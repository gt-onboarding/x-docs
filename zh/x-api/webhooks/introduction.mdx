<div id="v2-webhooks-api">
  # V2 Webhooks API
</div>

<div id="overview">
  ## 概览
</div>

V2 Webhooks API 使开发者能够通过基于 webhook 的 JSON 消息，从 X 账户接收实时事件通知。该 API 允许你注册和管理 webhook，构建用于处理事件的消费端应用，并通过质询-响应校验（CRC）和签名请求头确保通信安全。

<div id="feature-summary">
  ## 功能概览
</div>

| 等级 | 价格 | Webhook 数量 |
| :---: | :---: | :---: |
| 自助专业版 | $5000/月 | 1 |
| 企业版 | [联系销售](/zh/resources/enterprise/forms/enterprise-api-interest#enterprise-access-form) | 5+ |

<div id="products-that-support-webhooks">
  ## 支持 Webhook 的产品
</div>

以下产品目前支持通过 Webhook 发送事件：

- [Account Activity API (AAA)](/zh/x-api/account-activity/introduction)
- [Filtered Stream](/zh/x-api/webhooks/stream/introduction)

<div id="manage-webhooks">
  ## 管理 Webhook
</div>

Account Activity API 会在与订阅你服务的 X 账号相关的事件发生时，通过 webhook 向你发送 JSON 消息。X 会将这些活动推送到你注册的 webhook。通过以下步骤，你将学习如何管理 webhooks 和已订阅用户。

你将学习如何注册、查看和移除 webhooks 以及已订阅用户。我们将使用简单的 cURL 命令向各个 API 端点发起请求。cURL 是一种使用 URL 语法来发送或获取请求的命令行工具。

在你的事件消费应用开始接收 webhook 事件之前，还有若干事项需要准备。如下所述，你需要创建一个 X 应用、获取 Account Activity API 访问权限，并开发一个用于接收 webhook 事件的 Web 应用。 

<div id="1-develop-a-webhook-consumer-app">
  ### 1. 开发 Webhook 消费端应用
</div>

要为你的 X 应用注册新的 webhook，你需要开发、部署并托管一个可接收 X webhook 事件并响应安全校验请求的 Web 应用。

_在开始之前，建议先查看我们的[示例应用](https://github.com/xdevplatform/account-activity-dashboard-enterprise/tree/master)\！_

- 创建一个具有公网可访问 HTTPS URL 的 Web 应用，作为 webhook 端点以接收事件。
  - URI 的“路径”可自行决定。以下示例有效：[https://mydomain.com/service/listen](https://mydomain.com/service/listen)
  - 若需同时监听多个来源的 webhook，常见约定是：[https://mydomain.com/webhook/twitter](https://mydomain.com/webhook/twitter)
  - 注意：指定的 URL 不能包含端口号（[https://mydomain.com:5000/NoWorkie](https://mydomain.com:5000/NoWorkie)）。
- 首先编写代码以接收 X 的 Challenge Response Check（CRC）GET 请求，并返回格式正确的 JSON 响应。
- 注册你的 webhook URL。向 /2/webhooks 端点发送一条 POST 请求，在 JSON body 中包含该 URL。发出此请求后，X 会向你的 Web 应用发送 CRC 请求。
- 当 webhook 注册成功后，响应中会包含一个 webhook id。后续对支持 webhooks 的产品发起请求时需要该 webhook id。
- X 会向你注册的 URL 发送包含事件的 POST 请求。这些事件以 JSON 编码。示例 webhook JSON 负载见[此处](/zh/x-api/account-activity/introduction#account-activity-data-object-structure)。

<div id="optional-use-xurl-for-testing">
  #### 可选：使用 xurl 进行测试
</div>

用于测试时，xurl 工具现已支持临时 webhook！从 GitHub 安装 [`xurl` 项目](https://github.com/xdevplatform/xurl) 的最新版本，配置授权，然后运行：

```
xurl webhook start
```

这将生成一个临时的公网 webhook URL，自动处理所有 CRC 校验，并记录任何传入的订阅事件。这是在部署前验证配置的绝佳方式。示例输出：

```
Starting webhook server with ngrok...
Enter your ngrok authtoken (leave empty to try NGROK_AUTHTOKEN env var):

Attempting to use NGROK_AUTHTOKEN environment variable for ngrok authentication.
Configuring ngrok to forward to local port: 8080
Ngrok tunnel established!
  Forwarding URL: https://<your-ngrok-subdomain>.ngrok-free.app -> localhost:8080

Use this URL for your X API webhook registration: https://<your-ngrok-subdomain>.ngrok-free.app/webhook

Starting local HTTP server to handle requests from ngrok tunnel (forwarded from https://<your-ngrok-subdomain>.ngrok-free.app)...
```

**重要说明**

- 在注册 webhook URL 时，你的 Web 应用需要使用应用的 consumer secret 对 CRC 校验进行加密。

- 所有传入的私信（Direct Message）都会通过 webhook 传递。通过 [POST /2/dm\_conversations/with/:participant\_id/messages](/zh/x-api/direct-messages/send-a-new-message-to-a-user) 发送的所有私信也会通过 webhook 传递。这样你的 Web 应用即可感知由其他客户端发送的私信。

- 如果有多个 Web 应用共享同一 webhook URL，且同一用户映射到每个应用，则同一事件会被多次发送到你的 webhook（每个 Web 应用一次）。

- 在某些情况下，你的 webhook 可能会收到重复事件。你的 webhook 应用应具备容错能力，并按事件 ID 去重。

- 参见示例代码：

  - [Account Activity API Setup](https://github.com/m-rosinsky/XWebhookTest)：一个 Node Web 应用，使用企业级 Account Activity API 展示 webhook 事件。

<div id="2-securing-webhooks">
  ### 2. 保护 Webhook
</div>

X 的 webhook 类 API 提供两种方法来确认你的 webhook 服务器的安全性：

1. 挑战-响应检查使 X 能够验证用于接收 webhook 事件的 Web 应用的所有权。
2. 每个 POST 请求中的签名请求头使你能够确认传入的 webhook 确实来自 X。

有关实现要求，请参阅 CRC 检查部分。

<div id="3-the-webhooks-api">
  ### 3. Webhooks API
</div>

Webhooks 通过 Webhook Management API 进行管理。所有端点均需使用 OAuth2 App Only Bearer Token 进行身份验证。

<div id="adding-a-webhook">
  #### [添加 webhook](/zh/x-api/webhooks/create-webhook-config)
</div>

**POST /2/webhooks**

**说明：**

创建一个 webhook 配置。您可公开访问的 `https` 回调 URL 必须在 JSON 正文中传递。\
先为当前应用上下文注册一个新的 webhook URL。

**认证：**

OAuth2 应用仅限 Bearer Token

- **Bearer token** `<BEARER_TOKEN>`，例如 `AAAAAAAAAAAA0%2EUifi76ZC9Ub0wn...`

**参数（JSON 正文）：**

```
{
    "url": "<your publicly accessible https callback url>"
}
```

- **URL** `<URL>`，例如 `https://yourdomain.com/webhooks/twitter/`

**请求：** 按需修改后，将以下 cURL 请求复制到您的命令行中：

````
  ```
  curl --request POST --url 'https://api.twitter.com/2/webhooks?url=<URL>' --header 'authorization: Bearer <BEARER_TOKEN>'
  --data '{
"url": "https://yourdomain.com/webhooks/twitter"
          }'
  ```
````

**响应：**

**成功（200 OK）**

成功响应表示已创建 webhook，且初始 CRC 检查通过。

```
{
  "data": {
    "id": "<webhook_id>",
    "url": "<your callback url>",
    "valid": true,
    "created_at": "YYYY-mm-DDTHH:MM:ss.000Z"
  }
}
```

**失败（400 Bad Request）**

失败将返回标准错误对象。

```
{
    "errors": [
      {
        "message": "<Reason>: <Details>"
      }
    ],
    "title": "Invalid Request",
    "detail": "One or more parameters to your request was invalid.",
    "type": "https://api.twitter.com/2/problems/invalid-request"
}
```

常见失败原因包括：

| 原因 | 说明 |
| :---- | :---- |
| `CrcValidationFailed` | 回调 URL 未正确响应 CRC 检查（例如超时、响应内容不正确）。 |
| `UrlValidationFailed` | 提供的回调 URL 不符合要求（例如不是 `https`、格式无效）。 |
| `DuplicateUrlFailed` | 您的应用已为该回调 URL 注册了一个 webhook。 |
| `WebhookLimitExceeded` | 您的应用已达到允许的 webhook 配置数量上限。 |

<div id="viewing-a-webhook">
  #### [查看 webhook](/zh/x-api/webhooks/get-a-list-of-webhook-configs-associated-with-a-client-app)
</div>

**GET /2/webhooks**

\*\*说明：\*\*检索与你的应用（开发者账户）关联的所有 webhook 配置。

**认证：**

OAuth2 应用专用 Bearer 令牌

- **Bearer 令牌** `<BEARER_TOKEN>`，例如 `AAAAAAAAAAAA0%2EUifi76ZC9Ub0wn...`

- **URL** `<URL>`，例如 `https://yourdomain.com/webhooks/twitter/`

\*\*请求：\*\*运行以下命令，以检索指定应用的所有已注册 webhook URL 及其状态。

在完成必要修改后，将以下 cURL 请求复制到你的命令行中：

````
  ```
  curl --request GET --url 'https://api.twitter.com/2/webhooks' --header 'authorization: Bearer <BEARER_TOKEN>'
  ```
````

**成功（200 OK）**

返回 webhook 配置列表。若未配置任何 webhook，则列表为空。

_示例（配置了一个 webhook）：_

```
{
  "data": [
    {
      "created_at": "YYYY-mm-DDTHH:MM:ss.000Z",
      "id": "<webhook_id>",
      "url": "<callback url>",
      "valid": true
    }
  ],
  "meta": {
    "result_count": 1
  }
}
```

_示例（未配置任何 webhook）：_

```
{
  "data": [],
  "meta": {
    "result_count": 0
  }
}
```

<div id="removing-a-webhook">
  #### [移除 webhook](/zh/x-api/webhooks/delete-webhook-config)
</div>

DELETE /2/webhooks/:webhook\_id

**说明：** 使用指定的 `webhook_id` 删除 webhook 配置。该 ID 可从 `POST /2/webhooks` 的创建响应或 `GET /2/webhooks` 的列表响应中获取。

**认证：**

OAuth2 应用仅限 Bearer 令牌

- **Bearer 令牌** `<BEARER_TOKEN>`，例如 `AAAAAAAAAAAA0%2EUifi76ZC9Ub0wn...`

**路径参数：**

| 参数 | 说明 |
| :---- | :---- |
| `webhook_id` | 要删除的 webhook 的 ID。 |

**请求：** 运行以下命令，将该 webhook 从所提供应用的配置中移除。

在完成必要替换后，将下面的 cURL 请求复制到命令行中：

````
  ```
  curl --request DELETE --url 'https://api.twitter.com/2/webhooks/:WEBHOOK_ID' --header 'authorization: Bearer <BEARER_TOKEN>'
  ```

  **响应：**
````

**成功（200 OK）**

成功删除时返回一个 JSON 响应，其中 "deleted" 状态为 true。

_示例（成功删除 webhook）：_

```
{
  "data": {
    "deleted": true
  }
}
```

**失败（400 Bad Request）**

| 原因 | 说明 |
| :---- | :---- |
| `WebhookIdInvalid` | 提供的 `webhook_id` 未找到，或未与您的应用关联。 |

<div id="validate-and-reenable-webhook">
  #### [验证并重新启用 webhook](/zh/x-api/webhooks/webhook-crc-check)
</div>

**PUT /2/webhooks/:webhook\_id**

**描述：** 对指定 webhook 的 URL 触发挑战响应检查（CRC）。如果检查成功，将返回 200，并通过将其状态设置为 `valid` 来重新启用该 webhook。

**认证：**

仅应用 OAuth2 Bearer 令牌

- **Bearer 令牌** `<BEARER_TOKEN>`，例如 `AAAAAAAAAAAA0%2EUifi76ZC9Ub0wn...`

**路径参数：**

| 参数 | 描述 |
| :---- | :---- |
| `webhook_id` | 要验证的 webhook 的 ID。 |

**请求：** 运行以下命令，以根据所提供应用的配置验证该 webhook。

完成如下替换后，将以下 cURL 请求复制到命令行中运行：

````
  ```
  curl --request PUT --url 'https://api.twitter.com/2/webhooks/:WEBHOOK_ID' --header 'authorization: Bearer <BEARER_TOKEN>'
  ```

  **响应：**
````

**成功（200 OK）**

200 OK 表示&#x5DF2;_&#x53D1;起_ CRC 检查请求。这并**不**保证 CRC 检查通过。响应中的 `valid` 字段反映检查尝&#x8BD5;_&#x5B8C;成&#x540E;_&#x7684;状态。若 CRC 检查成功，webhook 的状态将更新为 valid。您可以使用 `GET /2/webhooks` 查看当前状态。

```
{
  "data": {
    "valid": true // 表示在 CRC 检查尝试完成后的状态
  }
}
```

**失败（400 Bad Request）**

| 原因 | 描述 |
| :---- | :---- |
| `WebhookIdInvalid` | 提供的 `webhook_id` 未找到，或未与您的应用关联。 |
| `CrcValidationFailed` | 回调 URL 未对 CRC 检查请求作出正确响应。 |

<div id="4-the-crc-check">
  ### 4. CRC 校验
</div>

挑战-响应检查（CRC）是 X 用于验证你提供的回调 URL 是否有效且由你控制的机制。

**CRC 触发时机：**

- 初次注册 webhook（`POST /2/webhooks`）
- 由 X 每小时发起一次验证
- 通过 `PUT /2/webhooks/:id` 手动触发

示例：

```
GET https://your-webhook-url.com/webhook?crc_token=challenge_string
```

示例 JSON 响应正文：

```
{
  "response_token": "sha256=<base64_encoded_hmac_hash>"
}
```

**如何构建响应：**

- 使用 crc\_token 作为消息
- 使用应用的**consumer secret** 作为密钥
- 生成 HMAC-SHA-256 哈希
- 将结果进行 Base64 编码

<div id="sample-apps">
  ## 示例应用
</div>

- [Simple webhook server](https://github.com/m-rosinsky/XWebhookTest/blob/main/app.py)
  - 一个 Python 单文件脚本，演示如何响应 CRC 校验并接收 POST 事件。
- [Account Activity API sample dashboard](https://github.com/xdevplatform/account-activity-dashboard-enterprise/tree/master)
  - 一个使用 [Bun](https://bun.sh) 构建的 Web 应用，可在应用内直接管理 webhook、订阅，并接收实时事件。