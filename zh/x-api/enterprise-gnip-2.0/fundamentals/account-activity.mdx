---
title: "Account Activity API：企业版"
---

<Note>
  此端点现已包含帖子编辑相关的元数据。请在["编辑帖子" 基础知识页面](/zh/x-api/enterprise-gnip-2.0/fundamentals/edit-tweets)了解详情。 

  此端点常与 Direct Messages 端点配合使用。我们已发布新的 [v2 Direct Messages 端点](/zh/x-api/direct-messages/manage/introduction)。请注意，Enterprise 与 Premium Account Activity API 支持 v2 一对一消息，但尚不支持群聊。   
</Note>

概览

`Enterprise`

Account Activity API 允许你通过 webhooks 订阅与某个用户账户相关的实时活动。这意味着，你可以通过单一连接，从你拥有或订阅的一个或多个账户接收实时帖子、Direct Messages 以及其他账户事件。

对于你在 webhook 注册中的每个用户订阅，你将收到以下所有相关活动：

| 活动类型 |     |
| :--- | :--- |
| \* 帖子（用户发布）  <br />    <br />\* 删除帖子（用户执行）<br />\* @提及（提及该用户）<br />\* 回复（发给该用户或来自该用户）<br />\* 转发（由用户转发或转发该用户的内容）<br />\* 引用推文（由用户发布或引用该用户）<br />\* 对被引用推文的转发（由用户转发或转发该用户的被引用推文）<br />\* 点赞（由用户点赞或对该用户内容的点赞）<br />\* 关注（由用户关注或关注该用户）  <br />    <br />\* 取消关注（用户执行） | \* 屏蔽（用户执行）<br />\* 取消屏蔽（用户执行）<br />\* 静音（用户执行）<br />\* 取消静音（用户执行）<br />\* 发送 Direct Messages（用户发送）<br />\* 接收 Direct Messages（用户接收）<br />\* 正在输入指示（发给该用户）<br />\* 已读回执（发给该用户）<br />\* 撤销订阅（用户执行） |

**请注意** - 我们不通过 Account Activity API 提供主页时间线数据。请使用 [GET statuses/home\_timeline](https://developer.x.com/en/docs/x-api/v1/tweets/timelines/overview) 拉取这些数据。
 

<div id="video-series">
  #### 视频系列
</div>

观看我们的[四集视频系列](https://www.youtube.com/watch?v=otPxejFhyy8\&index=0\&list=PLFKjcMIU2WshGG6Yj940XM7Z6BFs1zfBg)，快速上手 Account Activity API。

<iframe src="https://platform.x.com/embed/Tweet.html?dnt=false&embedId=twitter-widget-0&features=eyJ0ZndfdGltZWxpbmVfbGlzdCI6eyJidWNrZXQiOltdLCJ2ZXJzaW9uIjpudWxsfSwidGZ3X2ZvbGxvd2VyX2NvdW50X3N1bnNldCI6eyJidWNrZXQiOnRydWUsInZlcnNpb24iOm51bGx9LCJ0ZndfdHdlZXRfZWRpdF9iYWNrZW5kIjp7ImJ1Y2tldCI6Im9uIiwidmVyc2lvbiI6bnVsbH0sInRmd19yZWZzcmNfc2Vzc2lvbiI6eyJidWNrZXQiOiJvbiIsInZlcnNpb24iOm51bGx9LCJ0ZndfZm9zbnJfc29mdF9pbnRlcnZlbnRpb25zX2VuYWJsZWQiOnsiYnVja2V0Ijoib24iLCJ2ZXJzaW9uIjpudWxsfSwidGZ3X21peGVkX21lZGlhXzE1ODk3Ijp7ImJ1Y2tldCI6InRydWV0bWVudCIsInZlcnNpb24iOm51bGx9LCJ0ZndfZXhwZXJpbWVudHNfY29va2llX2V4cGlyYXRpb24iOnsiYnVja2V0IjoxMjA5NjAwLCJ2ZXJzaW9uIjpudWxsfSwidGZ3X3Nob3dfYmlyZHdhdGNoX3Bpdm90c19lbmFibGVkIjp7ImJ1Y2tldCI6Im9uIiwidmVyc2lvbiI6bnVsbH0sInRmd19kdXBsaWNhdGVfc2NyaWJlc190b19zZXR0aW5ncyI6eyJidWNrZXQiOiJvbiIsInZlcnNpb24iOm51bGx9LCJ0ZndfdXNlX3Byb2ZpbGVfaW1hZ2Vfc2hhcGVfZW5hYmxlZCI6eyJidWNrZXQiOiJvbiIsInZlcnNpb24iOm51bGx9LCJ0ZndfdmlkZW9faGxzX2R5bmFtaWNfbWFuaWZlc3RzXzE1MDgyIjp7ImJ1Y2tldCI6InRydWVfYml0cmF0ZSIsInZlcnNpb24iOm51bGx9LCJ0ZndfbGVnYWN5X3RpbWVsaW5lX3N1bnNldCI6eyJidWNrZXQiOnRydWUsInZlcnNpb24iOm51bGx9LCJ0ZndfdHdlZXRfZWRpdF9mcm9udGVuZCI6eyJidWNrZXQiOiJvbiIsInZlcnNpb24iOm51bGx9fQ%3D%3D&frame=false&hideCard=false&hideThread=false&id=996790447048613888&lang=en&origin=https%3A%2F%2Fdeveloper.x.com%2Fen%2Fdocs%2Fx-api%2Fenterprise%2Faccount-activity-api%2Foverview&sessionId=81f4a0339cbd7bd77b669faa00bd3a7224bc4418&theme=light&widgetsVersion=2615f7e52b7e0%3A1702314776716&width=550px" height="400px" />

<div id="feature-summary">
  ### 功能摘要
</div>

| 级别 | 定价 | 唯一订阅数 | Webhook 数量 | 可靠性与活动恢复 |
| :--- | :--- | :--- | :--- | :--- |
| Enterprise | [联系销售](/zh/x-api/enterprise-gnip-2.0/enterprise-gnip) | 最多 500+ | 3+ | [重试](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#retries) 和 [回放](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#account-activity-replay-api) |

- 有问题？遇到错误？
  - 阅读我们的[常见问题](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#frequently-asked-questions)或[错误排查指南](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#frequently-asked-questions)。

- 浏览我们的示例代码：
  - [Enterprise Account Activity API 控制台](https://github.com/xdevplatform/account-activity-dashboard-enterprise)，一个基于 Account Activity API 企业级版本的 Node Web 应用，用于展示 webhook 事件，并包含[回放](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#account-activity-replay-api)功能。
  - [SnowBot 聊天机器人](https://github.com/xdevplatform/SnowBotDev)，一个基于企业版 Account Activity 和 Direct Message API 构建的 Ruby Web 应用。

#### 管理 webhook：

使用 webhook 可以通过单一连接订阅与某个用户帐户相关的实时活动。

<Tabs>
  <Tab title="添加 webhook">
    先在给定的应用上下文中注册一个新的 webhook URL。

    在保存之前，系统会通过 CRC 请求验证该 URL。注册 webhook 后，请务必记录 webhook ID，后续会用到。

    按需修改以下占位符后，将这条 cURL 命令复制到命令行中：

    - **URL** `<URL>`，例如 `https://yourdomain.com/webhooks/twitter/`

    - **Consumer key** `<CONSUMER_KEY>`，例如 `xvz1evFS4wEEPTGEFPHBog`

    - **Access token** `<ACCESS_TOKEN>`，例如 `370773112-GmHxMAgYyLbNEtIKZeRNFsMKPR9EyMZeS9weJAEb`

      ```
      curl --request POST --url 'https://api.x.com/1.1/account_activity/webhooks.json?url=<URL>' --header 'authorization: OAuth oauth_consumer_key="<CONSUMER_KEY>", oauth_nonce="GENERATED", oauth_signature="GENERATED", oauth_signature_method="HMAC-SHA1", oauth_timestamp="GENERATED", oauth_token="<ACCESS_TOKEN>", oauth_version="1.0"'
      ```
  </Tab>

  <Tab title="查看 webhook">
    运行以下命令以返回给定应用的所有已注册 webhook URL 及其状态。

    按需修改以下占位符后，将这条 cURL 命令复制到命令行中：

    - **Bearer token** `<BEARER_TOKEN>`，例如 `AAAAAAAAAAAA0%2EUifi76ZC9Ub0wn...`

      ```curl --request GET --url https://api.x.com/1.1/account_activity/webhooks.json --header 'authorization: Bearer <BEARER_TOKEN>'
      ```
  </Tab>

  <Tab title="移除 webhook">
    要从所提供应用的配置中移除某个 webhook，按需修改以下占位符后，将这条 cURL 命令复制到命令行中：

    - **Webhook ID** `<:WEBHOOK_ID>`，例如 `1234567890`

    - **Consumer key** `<CONSUMER_KEY>`，例如 `xvz1evFS4wEEPTGEFPHBog`

    - **Access token** `<ACCESS_TOKEN>`，例如 `370773112-GmHxMAgYyLbNEtIKZeRNFsMKPR9EyMZeS9weJAEb`

      ```curl --request DELETE --url https://api.x.com/1.1/account_activity/webhooks/<:WEBHOOK_ID>.json --header 'authorization: OAuth oauth_consumer_key="<CONSUMER_KEY>", oauth_nonce="GENERATED", oauth_signature="GENERATED", oauth_signature_method="HMAC-SHA1", oauth_timestamp="GENERATED", oauth_token="<ACCESS_TOKEN>", oauth_version="1.0"'
      ```
  </Tab>
</Tabs>

<div id="managing-a-webhook">
  #### 管理已订阅用户：
</div>

注册 Webhook 后，您可以将订阅用户添加到 Account Activity API，以开始接收其账号活动。

<Tabs>
  <Tab title="添加订阅">
    我们先从订阅用户开始，以便接收所有事件类型。

    在根据以下占位符做出相应替换后，将下面的 cURL 请求复制到命令行执行：

    - **Webhook ID** `<:WEBHOOK_ID>`，例如 `1234567890`

    - **Consumer key 名称** `<CONSUMER_KEY>`，例如 `xvz1evFS4wEEPTGEFPHBog`

    - **订阅用户的访问令牌** `<SUBSCRIBING_USER'S_ACCESS_TOKEN>`，例如 `370773112-GmHxMAgYyLbNEtIKZeRNFsMKPR9EyMZeS9weJAEb`

      ```
      curl --request POST --url https://api.x.com/1.1/account_activity/webhooks/<:WEBHOOK_ID>/subscriptions/all.json --header 'authorization: OAuth oauth_consumer_key="<CONSUMER_KEY>", oauth_nonce="GENERATED", oauth_signature="GENERATED", oauth_signature_method="HMAC-SHA1", oauth_timestamp="GENERATED", oauth_token="<SUBSCRIBING_USER'S_ACCESS_TOKEN>", oauth_version="1.0"'
      ```
  </Tab>

  <Tab title="查看订阅">
    若要查看指定 Webhook 的所有活动类型订阅列表，在根据以下占位符做出相应替换后，将下面的 cURL 请求复制到命令行执行：

    - **Webhook ID** `<:WEBHOOK_ID>`，例如 `1234567890`

    - **Bearer token** `<BEARER_TOKEN>`，例如 `AAAAAAAAAAAA0%2EUifi76ZC9Ub0wn...`

      ```
      curl --request GET --url https://api.x.com/1.1/account_activity/webhooks/<:WEBHOOK_ID>/subscriptions/all/list.json --header 'authorization: Bearer <BEARER_TOKEN>'
      ```
  </Tab>

  <Tab title="移除订阅">
    停用后，请求用户的所有事件将不再发送到该 Webhook URL。

    要在给定的用户上下文和应用中停用订阅，在根据以下占位符做出相应替换后，将下面的 cURL 请求复制到命令行执行：

    - **Webhook ID** `<:WEBHOOK_ID>`，例如 `1234567890`

    - **Consumer key** `<CONSUMER_KEY>`，例如 `xvz1evFS4wEEPTGEFPHBog`

    - **订阅用户的访问令牌** `<SUBSCRIBING_USER'S_ACCESS_TOKEN>`，例如 `370773112-GmHxMAgYyLbNEtIKZeRNFsMKPR9EyMZeS9weJAEb`

      ```
      curl --request DELETE --url https://api.x.com/1.1/account_activity/webhooks/:WEBHOOK_ID/subscriptions/all.json --header 'authorization: OAuth oauth_consumer_key="CONSUMER_KEY", oauth_nonce="GENERATED", oauth_signature="GENERATED", oauth_signature_method="HMAC-SHA1", oauth_timestamp="GENERATED", oauth_token="SUBSCRIBED_USER'S_ACCESS_TOKEN", oauth_version="1.0"'
      ```
  </Tab>
</Tabs>

干得好！现在您应该能够管理您的 Webhook 和订阅用户了。

<div id="managing-subscribed-users">
  #### 参考文章
</div>

- [Challenge-Response Check（CRC）概览](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#securing-webhooks)
- [管理 Webhook 与订阅](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#managing-webhooks-and-subscriptions)

## Account Activity API 的视频演示

在本次视频演示中，您将了解 Account Activity API 的高级版和企业版所具备的功能。

观看完本视频后，您将了解以下功能：

- 注册 webhook
- 添加用户订阅
- 移除用户订阅
- 接收账户活动
- 重放账户活动

<iframe src="https://platform.x.com/embed/Tweet.html?dnt=false&embedId=twitter-widget-0&features=eyJ0ZndfdGltZWxpbmVfbGlzdCI6eyJidWNrZXQiOltdLCJ2ZXJzaW9uIjpudWxsfSwidGZ3X2ZvbGxvd2VyX2NvdW50X3N1bnNldCI6eyJidWNrZXQiOnRydWUsInZlcnNpb24iOm51bGx9LCJ0ZndfdHdlZXRfZWRpdF9iYWNrZW5kIjp7ImJ1Y2tldCI6Im9uIiwidmVyc2lvbiI6bnVsbH0sInRmd19yZWZzcmNfc2Vzc2lvbiI6eyJidWNrZXQiOiJvbiIsInZlcnNpb24iOm51bGx9LCJ0ZndfZm9zbnJfc29mdF9pbnRlcnZlbnRpb25zX2VuYWJsZWQiOnsiYnVja2V0Ijoib24iLCJ2ZXJzaW9uIjpudWxsfSwidGZ3X21peGVkX21lZGlhXzE1ODk3Ijp7ImJ1Y2tldCI6InRyZWF0bWVudCIsInZlcnNpb24iOm51bGx9LCJ0ZndfZXhwZXJpbWVudHNfY29va2llX2V4cGlyYXRpb24iOnsiYnVja2V0IjoxMjA5NjAwLCJ2ZXJzaW9uIjpudWxsfSwidGZ3X3Nob3dfYmlyZHdhdGNoX3Bpdm90c19lbmFibGVkIjp7ImJ1Y2tldCI6Im9uIiwidmVyc2lvbiI6bnVsbH0sInRmd19kdXBsaWNhdGVfc2NyaWJlc190b19zZXR0aW5ncyI6eyJidWNrZXQiOiJvbiIsInZlcnNpb24iOm51bGx9LCJ0ZndfdXNlX3Byb2ZpbGVfaW1hZ2Vfc2hhcGVfZW5hYmxlZCI6eyJidWNrZXQiOiJvbiIsInZlcnNpb24iOm51bGx9LCJ0ZndfdmlkZW9faGxzX2R5bmFtaWNfbWFuaWZlc3RzXzE1MDgyIjp7ImJ1Y2tldCI6InRydWVfYml0cmF0ZSIsInZlcnNpb24iOm51bGx9LCJ0ZndfbGVnYWN5X3RpbWVsaW5lX3N1bnNldCI6eyJidWNrZXQiOnRydWUsInZlcnNpb24iOm51bGx9LCJ0ZndfdHdlZXRfZWRpdF9mcm9udGVuZCI6eyJidWNrZXQiOiJvbiIsInZlcnNpb24iOm51bGx9fQ%3D%3D&frame=false&hideCard=false&hideThread=false&id=1204084171334832128&lang=en&origin=https%3A%2F%2Fdeveloper.x.com%2Fen%2Fdocs%2Fx-api%2Fenterprise%2Faccount-activity-api%2Fquick-start%2Fa-visual-walkthrough-of-the-account-activity-api&sessionId=b5b8e259a4c6287be2413de9059093170036fb30&theme=light&widgetsVersion=2615f7e52b7e0%3A1702314776716&width=550px" />

- 有疑问？遇到错误？
  - 请阅读我们的[常见问题](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#frequently-asked-questions)或[错误排查指南](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#frequently-asked-questions)。

- 查看我们的示例代码：
  - [Enterprise Account Activity API 仪表板](https://github.com/xdevplatform/account-activity-dashboard-enterprise)：一款 Node 网页应用，基于 Account Activity API 的企业级版本，用于展示 webhook 事件，并包含 [Replay](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#account-activity-replay-api) 功能。
  - [SnowBot 聊天机器人](https://github.com/xdevplatform/SnowBotDev)：一款基于企业级 Account Activity API 和 Direct Message API 构建的 Ruby 网页应用。

**企业版**

<div id="a-video-walkthrough-of-the-account-activity-api">
  ## Webhook 入门
</div>

Account Activity API 是一种基于 webhook 的 API，会将账户事件发送到由你开发、部署并托管的 Web 应用。

在你的事件消费应用开始接收 webhook 事件之前，有一些底层配套细节需要处理。如下所述，你需要创建一个 X 应用、获取 Account Activity API 的访问权限，并开发一个用于消费 webhook 事件的 Web 应用。 

### 1. 创建 X 应用。

- 使用已获批准的开发者账号在[开发者门户](/zh/resources/fundamentals/developer-portal)中创建[X 应用](/zh/resources/fundamentals/developer-apps)。如果你代表公司创建应用，建议使用公司的 X 账号。要申请开发者账号，[点击此处](/zh/resources/fundamentals/developer-apps)。
- 在应用页面的[权限](/zh/resources/fundamentals/developer-apps#oauth-1-0a-app-permissions)选项卡中启用“读取、写入和访问私信”（Read, Write and Access direct messages）。
- 在“Keys and Access Tokens”选项卡中，记录应用的 Consumer Key（API Key）和 Consumer Token（API Secret）。
- 在同一选项卡中，生成应用的[Access Token 和 Access Token Secret](/zh/resources/fundamentals/authentication#obtaining-access-tokens-using-3-legged-oauth-flow)。你需要这些访问令牌来注册 webhook URL，X 会将账号事件发送到该地址。
- 如果你不熟悉[ X 登录 ](/zh/resources/fundamentals/authentication#log-in-with-x)以及用户上下文在 X API 中的工作方式，请参阅[获取访问令牌](https://dev.x.com/webhooks/access-tokens)。当你添加要接收事件的账号时，将使用该账号的访问令牌为其订阅。
- 记下应用的数字 ID，可在[“Apps”](/zh/resources/fundamentals/developer-apps)页面的[开发者门户](/zh/resources/fundamentals/developer-portal)中查看。申请 Account Activity API 访问权限时需要该应用 ID。
   

<div id="1-create-a-x-app">
  ### 2. 获取 Account Activity API 访问权限
</div>

创建 X 应用后，下一步是申请 Account Activity API 访问权限。

Account Activity API 仅对企业版提供，因此你需要通过以下链接提交申请。

<Button href="https://developer.x.com/en/enterprise-application.html">
  申请企业版访问权限
</Button>

<div id="2-get-account-activity-api-access">
  ### 3. 开发 webhook 消费端应用
</div>

在获得 Account Activity API 访问权限后，您需要开发、部署并托管一个用于接收 X webhook 事件的 Web 应用。

- 创建一个带有 URL 的 Web 应用，将其用作 webhook 来接收事件。该端点部署在您的服务器上，用于监听传入的 X webhook 事件。
  - URI 的路径（_path_）完全由您决定。以下示例是有效的：https://mydomain.com\_/service/listen\_

  - 如果您需要监听来自多种来源的 webhook，常见的路径模式是：https://mydomain.com/webhook/twitter

  - 请注意，指定的 URL 不能包含端口（https://mydomain.com:5000/NoWorkie）。

- 如我们的[保护 Webhooks](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#securing-webhooks)指南所述，第一步是编写代码以接收 X Challenge Response Check（CRC）GET 请求，并返回格式正确的 JSON 响应。

- 注册您的 webhook URL。您需要向 /webhooks.json?url= 端点发起 POST 请求。发起该请求后，X 会向您的 Web 应用发送 CRC 请求。成功注册 webhook 后，响应将包含一个 webhook ID。后续向 Account Activity API 发起某些请求时需要该 webhook ID。

- X 会将账户的 webhook 事件发送到您注册的 URL。请确保您的 Web 应用支持针对传入事件的 POST 请求。这些事件将采用 JSON 编码。示例 webhook JSON 负载见[此处](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#account-activity-data-object-structure)。

- 当您的 Web 应用准备就绪后，下一步是添加需要接收活动的账户。添加（或删除）账户时，您将基于账户 ID 发起 POST 请求。更多信息请参阅我们的[添加订阅指南](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#managing-webhooks-and-subscriptions)。

<div id="3-develop-webhook-consumer-app">
  ### 4. 验证设置
</div>

- 要验证你的应用和 webhook 是否配置正确，请为你的应用已订阅的某个 X 账号发布的帖子点“收藏”。你的 webhook URL 应会针对订阅者收到的每一次“收藏”，通过 POST 请求接收一个 `favorite_events`。
- 请注意，添加订阅后，开始投递事件可能会有最长 10 秒的延迟。

**重要说明**

- 在注册你的 webhook URL 时，你的 Web 应用必须使用其 consumer token 和 secret 进行身份验证，且还需要使用应用所有者的用户访问令牌和密钥。

- 所有传入的私信都会通过 webhook 投递。所有通过 [POST direct\_messages/events/new (message\_create)](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/new-event) 发送的私信也会通过 webhook 投递。这样你的 Web 应用就能感知通过其他客户端发送的私信。

- 请注意，每个 webhook 事件都包含一个 for\_user\_id（用户 ID），用于指示该事件对应的是哪个订阅。

- 如果有两位用户在你的 Web 应用中于同一会话使用私信功能，你的 webhook 将会接收到两条重复事件（每个用户一条）。你的 Web 应用应考虑并处理这一点。

- 如果有多个 Web 应用共享同一个 webhook URL，且同一用户映射到每个应用，则同一事件会多次发送到你的 webhook（每个 Web 应用一次）。

- 在某些情况下，你的 webhook 可能会收到重复事件。你的 webhook 应用应具备容错能力，并按事件 ID 去重。

- 不要指望快速回复会紧随请求而来。用户可以忽略快速回复请求，也可能通过传统私信进行回应。用户还可能对其在消息线程中先前未回复的请求给出快速回复。

- 参见示例代码：
  - [Enterprise Account Activity API dashboard](https://github.com/xdevplatform/account-activity-dashboard-enterprise)：一个使用 Account Activity API 企业版显示 webhook 事件的 Node Web 应用，并包含 [Replay](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#account-activity-replay-api) 功能。

  - [SnowBot chatbot](https://github.com/xdevplatform/SnowBotDev)：一个基于 Account Activity 和 Direct Message API 构建的 Ruby Web 应用。该代码库包含一个用于帮助设置 Account Activity API webhook 的 [脚本](https://github.com/xdevplatform/SnowBotDev/wiki/Account-Activity-API-setup-script)。

## 保护 webhook 的安全

X 的基于 webhook 的 API 提供两种方法来验证你的 webhook 服务器的安全性：

1. 挑战-响应检查使 X 能够确认接收 webhook 事件的 Web 应用的所有权。
2. 每个 POST 请求中的签名头使你能够确认传入的 webhook 确实来自 X。
    

### 挑战-响应检查

为验证你同时是应用与 webhook URL 的所有者，X 将执行 Challenge-Response Check（CRC，勿与循环冗余校验混淆）。当发送 CRC 时，X 会向你的 Web 应用发起一个带有 _`crc_token`_ 参数的 GET 请求。收到该请求后，你的 Web 应用需要基于 _`crc_token`_ 参数和应用的 Consumer Secret（详见下文）构建一个加密的 `response_token`。`response_token` 必须以 JSON 编码（见下方示例）并在三秒内返回。成功后，会返回一个 webhook `id`。

在你注册 webhook URL 时会发送一次 CRC，因此实现 CRC 响应代码是首要步骤。一旦 webhook 建立，X 将在上次收到成功响应约 24 小时后再次触发 CRC。你的应用也可以在需要时使用 webhook `id` 发起 PUT 请求来触发 CRC。在开发 webhook 应用、部署新代码并重启服务后，触发 CRC 很有用。

应预期每个传入的 CRC 请求其 _`crc_token`_ 都会变化，并且在计算中应将其作为消息，而将 Consumer Secret 作为密钥。

如果未在 3 秒内返回响应或响应无效，将停止向已注册的 webhook 发送事件。

#### CRC 请求会在以下情况下发生：

- 注册 webhook URL 时。
- 大约每小时一次，用于验证你的 webhook URL。
- 你可以通过发送 PUT 请求手动触发 CRC。在开发 webhook 客户端的过程中，应计划在完善 CRC 响应的同时手动触发 CRC。 
   

<div id="the-crc-request-will-occur">
  #### 响应要求：
</div>

- 使用 `crc_token` 和你的应用 Consumer Secret 生成的 HMAC SHA-256 哈希，并进行 base64 编码
- 有效的 response\_token，且为 JSON 格式。
- 延迟小于 3 秒。
- HTTP 200 响应代码。
   

<div id="response-requirements">
  #### 按语言分类的 HMAC 库：
</div>

- [Java/Scala](https://docs.oracle.com/javase/8/docs/api/index.html?javax/crypto/Mac.html)
- [Ruby](http://ruby-doc.org/stdlib-2.1.0/libdoc/openssl/rdoc/OpenSSL/HMAC.html)
- [Node.js](https://nodejs.org/api/crypto.html#crypto_class_hmac)
- [Python](https://docs.python.org/2/library/hmac.html)

<div id="language-specific-hmac-libraries">
  #### 在 Python 中生成响应令牌的示例：
</div>

下面定义了一个 Python 2.7 Flask Web 应用中的路由，它将正确通过挑战响应校验。

```
import base64
import hashlib
import hmac
import json


\# Defines a route for the GET request
@app.route('/webhooks/twitter', methods=\['GET'\])
def webhook_challenge():

  # creates HMAC SHA-256 hash from incomming token and your consumer secret
  sha256\_hash\_digest = hmac.new(TWITTER\_CONSUMER\_SECRET, msg=request.args.get('crc_token'), digestmod=hashlib.sha256).digest()

  # construct response data with base64 encoded hash
  response = {
    'response\_token': 'sha256=' + base64.b64encode(sha256\_hash_digest)
  }

  # returns properly formatted json response
  return json.dumps(response)
```

<div id="example-response-token-generation-in-python">
  #### 示例 JSON 响应：
</div>

按上述方式定义路由后，在网页浏览器中访问 https://your-app-domain/webhooks/twitter?crc\_token=foo 时，您的 Web 应用应返回与以下内容类似的响应。

```
{
  "response_token": "sha256=x0mYd8hz2goCTfcNAaMqENy2BFgJJfJOb4PdvTffpwg="
}
```

<div id="example-json-response">
  #### 其他示例：
</div>

- [此处](https://github.com/xdevplatform/account-activity-dashboard/blob/master/helpers/security.js) 提供了一个用 Node/JS 编写的 CRC 响应方法示例。
- [此处](https://github.com/xdevplatform/SnowBotDev/blob/master/app/controllers/snow_bot_dev_app.rb) 提供了一个用 Ruby 编写的 CRC 响应方法示例（参见 _generate\_crc\_response_ 以及用于接收 CRC 事件的 /GET 路由）。

### 可选的签名请求头验证

当接收来自 X 的 POST 请求、发送 GET 请求创建 webhook，或发送 GET 请求执行手动 CRC 时，会在请求头 x-twitter-webhooks-signature 中传递哈希签名。该签名可用于验证数据来源是否为 X。POST 的哈希签名以 sha256= 开头，表示使用 HMAC SHA-256 对你的 X App Consumer Secret 和请求负载进行加密。GET 的哈希基于查询参数字符串 crc\_token=$token\&nonce=$nonce 计算得到。

**验证请求的步骤**

1. 使用你的 consumer secret 与接收的请求体创建哈希。
2. 将生成的哈希与经 base64 编码的 x-twitter-webhooks-signature 值进行比较。使用类似 [compare\_digest](https://docs.python.org/2/library/hmac.html) 的方法以降低对计时攻击的风险。

<div id="optional-signature-header-validation">
  ### 其他安全指南
</div>

以下是你的 Web 应用在安全方面应当考虑的其他指南。未实施这些指南不会影响你的 webhook 的正常运行，但 X 信息安全团队强烈建议采纳。若你不熟悉以下建议，请咨询你的服务器管理员。

#### X 汇总网段

为提升安全性，您可以将以下汇总网段添加到允许列表（allowlist）：

- 199.59.148.0/22

- 199.16.156.0/22

- 192.133.77.0/26

- 64.63.15.0/24

- 64.63.31.0/24

- 64.63.47.0/24

- 202.160.128.0/24

- 202.160.129.0/24

- 202.160.130.0/24

<div id="x-aggregate-network-blocks">
  #### 推荐的服务器配置
</div>

- 在 [ssllabs.com](http://ssllabs.com/) 测试中获得 “A” 评级
- **启用 TLS 1.2**
- 启用前向保密（Forward Secrecy）
- 关闭 SSLv2
- 关闭 SSLv3（因 POODLE 漏洞）
- 关闭 TLS 1.0
- 关闭 TLS 1.1
- 关闭 TLS 压缩
- 关闭会话票据（Session Tickets），除非会轮换会话票据密钥
- 在 SSL 配置中将 “ssl\_prefer\_server\_ciphers” 或 “SSLHonorCipherOrder” 选项设置为 “on”
- 确保密码套件列表为现代列表，例如：
  `ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA:ECDHE-RSA-DES-CBC3-SHA:DES-CBC3-SHA`

## 管理 Webhook 与订阅

### 创建和更改 webhook

若需更改 webhook URL，必须先删除现有的 webhook，然后创建一个新的。请注意，完成此操作后，您需要将用户订阅重新添加到新的 webhook。

#### Webhook 配置管理端点：

|     |     |
| :--- | :--- |
| **方法** | 企业版 |
| 注册 webhook URL / 生成 webhook\_id | [POST webhooks](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#enterprise-account-activity-api) |
| 返回所有 webhook URL 及其状态 | [GET webhooks](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks) |
| 删除应用当前的 webhook 配置 | [DELETE webhooks/:webhook\_id](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id) |
| 手动触发 CRC 请求 | [PUT webhooks/:webhook\_id](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#put-account-activity-webhooks-webhook-id) |

<div id="webhook-configuration-management-endpoints">
  #### 为什么不能直接更新 webhook URL？
</div>

为什么 webhook 配置是不可变的？X 高度重视安全性。如果你的 webhook URL 被更改，这可能意味着你的应用的 consumer key 和 consumer secret 已遭泄露。通过要求你创建新的 webhook 配置，你也必须重新订阅用户事件。此过程需要使用恶意方不太可能持有的访问令牌，因此可降低他人获取你用户私密信息的可能性。
 

### 添加与移除用户订阅

企业版本支持数千个订阅。如果您已有客户经理，请与其联系咨询相关问题。申请使用企业版 API，请[点击此处](https://developer.x.com/en/products/x-api/enterprise)。 

#### 订阅管理端点

 

|     |     |
| :--- | :--- |
| 方法 | 企业版 |
| 添加新用户订阅 | [POST webhooks/:webhook\_id/subscriptions/all](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks-webhook-id-subscriptions-all) |
| 获取用户订阅 | [GET webhooks/:webhook\_id/subscriptions/all](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks-webhook-id-subscriptions-all) |
| 返回所有活跃订阅列表 | [GET webhooks/:webhook\_id/subscriptions/all/list](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-subscriptions-count) |
| 使用应用仅限（App-only）OAuth 停用用户订阅 | [DELETE webhooks/:webhook\_id/subscriptions/:user\_id/all.json](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id-subscriptions-user-id-all-json) |

Account Activity API：企业版

<Note>
  **请注意**： 

  在开始使用该 API 之前，X 需先为你的开发者应用启用对 Account Activity API 的访问。为此，请将你计划用于身份验证的应用 ID 提供给你的客户经理或技术支持团队。
</Note>

[Account Activity API](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity) 由一组端点组成，允许你创建和管理用户订阅，并通过单一连接接收你所有已订阅账户的实时账户活动。 

Account Activity API 提供两种身份验证方式（[OAuth 1.0a](/zh/resources/fundamentals/authentication#oauth-1-0a-2) 和 [OAuth 2.0 Bearer Token](/zh/resources/fundamentals/authentication#bearer-token-also-known-as-app-only)）。应使用的方式取决于你调用的具体端点。

|     |     |     |     |
| :--- | :--- | :--- | :--- |
| **描述** | **端点** | OAuth 1.0a  <br />(用户上下文) | OAuth 2.0 持有者令牌（仅限应用） |
| 为给定的应用上下文注册新的 webhook URL | [POST account\_activity/webhooks](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks) | ✓   |     |
| 返回给定应用的所有 URL 及其状态 | [GET account\_activity/webhooks](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks) |     | ✓   |
| 为给定 webhook 的 URL 触发挑战-响应检查（CRC） | [PUT account\_activity/webhooks/:webhook\_id](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#put-account-activity-webhooks-webhook-id) | ✓   |     |
| 将应用订阅到某个用户的账户事件 | [POST account\_activity/webhooks/:webhook\_id/subscriptions/all](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks-webhook-id-subscriptions-all) | ✓ \* |     |
| 返回当前活跃订阅的数量 | [GET account\_activity/subscriptions/count](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-subscriptions-count) |     | ✓   |
| 检查某个 webhook 配置是否已订阅用户事件 | [GET account\_activity/webhooks/:webhook\_id/subscriptions/all](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks-webhook-id-subscriptions-all) | ✓ \* |     |
| 返回当前活跃订阅的列表 | [GET account\_activity/webhooks/:webhook\_id/subscriptions/all/list](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks-webhook-id-subscriptions-all-list) |     | ✓   |
| 删除 webhook | [DELETE account\_activity/webhooks/:webhook\_id](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id) | ✓   |     |
| \[已弃用] 为所提供的用户上下文和应用停用订阅 | [DELETE account\_activity/webhooks/:webhook\_id/subscriptions/all](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id-subscriptions-all-deprecated) | ✓ \* |     |
| 使用仅限应用的 OAuth 停用订阅 | [DELETE /account\_activity/webhooks/:webhook\_id/subscriptions/:user\_id/all.json](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id-subscriptions-user-id-all-json) |     | ✓   |
| 重新向 webhook 投递活动 | [POST /1.1/account\_activity/replay/webhooks/:webhook\_id/subscriptions/all.json](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#replay-api) |     | ✓   |

\*\_ 认证需要订阅用户的访问令牌。 \_

对于需要 OAuth 1.0a 用户上下文认证的端点，你需要提供以下凭据来完成请求认证：

- 消费者密钥（API Key 和 Secret）
- 访问令牌（Access Token 和 Secret）

对于以下三个端点，你是在应用上下文内执行写操作（不涉及任何 X 用户）。因此，需要提供的访问令牌应属于你的开发者应用（App）。这些令牌可在 [developer portal](https://developer.x.com/en/portal/projects-and-apps) 中你的 App 的“Keys and tokens”选项卡直接生成。  

- [POST account\_activity/webhooks](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks)：为指定的应用上下文注册新的 webhook URL
- [PUT account\_activity/webhooks/:webhook\_id](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#put-account-activity-webhooks-webhook-id)：对指定 webhook 的 URL 触发挑战-响应检查（CRC）
- [DELETE account\_activity/webhooks/:webhook\_id](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id)：删除 webhook

另一方面，对于以下三个端点，你将发起请求，允许你的应用代表某位 X 用户访问受保护的数据（例如私信）。因此，你必须提供该订阅用户的访问令牌（Access Tokens）。所需访问令牌可通过三方 OAuth 流程获取（参见 [OAuth 1.0a：如何获取用户的 Access Tokens](/zh/resources/fundamentals/authentication#obtaining-access-tokens-using-3-legged-oauth-flow)）。这些端点在上表中以星号（\*）标注。

- [POST account\_activity/webhooks/:webhook\_id/subscriptions/all](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks-webhook-id-subscriptions-all)：将应用订阅到某用户的账号事件
- [GET account\_activity/webhooks/:webhook\_id/subscriptions/all](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks-webhook-id-subscriptions-all)：检查某个 webhook 配置是否已订阅某用户的事件
- [DELETE account\_activity/webhooks/:webhook\_id/subscriptions/all](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id-subscriptions-all-deprecated)：停用所提供用户上下文与应用的订阅【已弃用】

<Note>
  **请注意**：

  确保你的开发者 App 已启用“Read, Write, and Direct Messages”。你可以在开发者账号的 [Projects & Apps 部分](https://developer.x.com/en/portal/projects-and-apps)中，在所选开发者 App 的“App permissions”下更改此设置。更改权限后，你需要重新生成 App 凭据。
</Note>

包含所有 Account Activity API 可用端点（含说明以及带有认证实现示例的 cURL 示例请求）的列表，见[API 参考文档](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#account-activity-api-reference-index)。

如需更多信息，请查看 XDev 的[示例 Web 应用与辅助脚本](https://github.com/xdevplatform/account-activity-dashboard-enterprise)，以开始使用企业版 Account Activity API。

<Note>
  **请注意**：

  在开始使用该 API 之前，X 需要为你的开发者 App 启用对 Account Activity API 的访问。为此，请将你用于认证的 App ID 提供给你的客户经理或技术支持团队。
</Note>

[Account Activity API](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity) 由一组端点组成，允许你创建并管理用户订阅，通过单个连接接收你所有已订阅账号的实时活动。

Account Activity API 提供两种认证方法（[OAuth 1.0a](/zh/resources/fundamentals/authentication#oauth-1-0a-2) 和 [OAuth 2.0 Bearer Token](/zh/resources/fundamentals/authentication#oauth-2-0)）。应使用哪种方法取决于所调用的端点。

|     |     |     |     |
| :--- | :--- | :--- | :--- |
| **描述** | **端点** | OAuth 1.0a  <br />(用户上下文) | OAuth 2.0 持有者令牌（仅限应用） |
| 为给定的应用上下文注册新的 webhook URL | [POST account\_activity/webhooks](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks) | ✓   |     |
| 返回给定应用的所有 URL 及其状态 | [GET account\_activity/webhooks](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks) |     | ✓   |
| 为给定 webhook 的 URL 触发挑战-响应检查（CRC） | [PUT account\_activity/webhooks/:webhook\_id](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#put-account-activity-webhooks-webhook-id) | ✓   |     |
| 将应用订阅到某个用户的账户事件 | [POST account\_activity/webhooks/:webhook\_id/subscriptions/all](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks-webhook-id-subscriptions-all) | ✓ \* |     |
| 返回当前活跃订阅的数量 | [GET account\_activity/subscriptions/count](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-subscriptions-count) |     | ✓   |
| 检查某个 webhook 配置是否已订阅用户事件 | [GET account\_activity/webhooks/:webhook\_id/subscriptions/all](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks-webhook-id-subscriptions-all) | ✓ \* |     |
| 返回当前活跃订阅的列表 | [GET account\_activity/webhooks/:webhook\_id/subscriptions/all/list](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks-webhook-id-subscriptions-all-list) |     | ✓   |
| 删除 webhook | [DELETE account\_activity/webhooks/:webhook\_id](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id) | ✓   |     |
| \[已弃用] 为所提供的用户上下文和应用停用订阅 | [DELETE account\_activity/webhooks/:webhook\_id/subscriptions/all](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id-subscriptions-all-deprecated) | ✓ \* |     |
| 使用仅限应用的 OAuth 停用订阅 | [DELETE /account\_activity/webhooks/:webhook\_id/subscriptions/:user\_id/all.json](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id-subscriptions-user-id-all-json) |     | ✓   |
| 重新向 webhook 投递活动 | [POST /1.1/account\_activity/replay/webhooks/:webhook\_id/subscriptions/all.json](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#replay-api) |     | ✓   |

\*\_ 认证需要订阅用户的访问令牌。 \_

对于需要 OAuth 1.0a 用户上下文认证的端点，你需要提供以下凭据来完成请求认证：

- 消费者密钥（API Key 和 Secret）
- 访问令牌（Access Token 和 Secret）

对于以下三个端点，你是在应用上下文内执行写操作（不涉及任何 X 用户）。因此，需要提供的访问令牌应属于你的开发者应用（App）。这些令牌可在 [developer portal](https://developer.x.com/en/portal/projects-and-apps) 中你的 App 的“Keys and tokens”选项卡直接生成。  

- [POST account\_activity/webhooks](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks)：为指定应用上下文注册新的 webhook URL
- [PUT account\_activity/webhooks/:webhook\_id](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#put-account-activity-webhooks-webhook-id)：对指定 webhook 的 URL 触发挑战-响应校验（CRC）
- [DELETE account\_activity/webhooks/:webhook\_id](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id)：删除 webhook

另一方面，对于以下三个端点，您将发起请求，使您的应用能够代表某位 X 用户访问受保护的数据（例如私信）。因此，必须提供该订阅用户对应的访问令牌（Access Tokens）。所需访问令牌可通过三方 OAuth 流程获取（参见 [OAuth 1.0a：如何获取用户的访问令牌](/zh/resources/fundamentals/authentication#obtaining-access-tokens-using-3-legged-oauth-flow)）。这些端点在上表中以星号（\*）标注。

- [POST account\_activity/webhooks/:webhook\_id/subscriptions/all](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks-webhook-id-subscriptions-all)：为应用订阅某用户的账户事件
- [GET account\_activity/webhooks/:webhook\_id/subscriptions/all](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks-webhook-id-subscriptions-all)：检查某 webhook 配置是否已订阅某用户的事件
- [DELETE account\_activity/webhooks/:webhook\_id/subscriptions/all](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id-subscriptions-all-deprecated)：停用所提供用户上下文与应用的订阅【已弃用】

<Note>
  **请注意**： 

  请确保您的开发者 App 已启用“读取、写入和私信”。您可以在开发者账户的 [Projects & Apps 部分](https://developer.x.com/en/portal/projects-and-apps)中所选开发者 App 的“App permissions”下更改此设置。更改权限后，您需要重新生成 App 凭据。
</Note>

可用于 Account Activity API 的全部端点列表（含对应说明以及带有身份验证实现示例的 cURL 示例请求）可在[API 参考文档](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#account-activity-api-reference-index)中查阅。

如需更多信息，请参阅 XDev 的[示例 Web 应用与辅助脚本](https://github.com/xdevplatform/account-activity-dashboard-enterprise)，以开始使用 Enterprise Account Activity API。

## 重试

`企业版`

Account Activity API 的企业版的一大优势是对 webhook 事件提供重试机制。若未收到表示“成功”的 200 HTTP 响应码，X 服务器将启动重试流程，在五分钟内最多重发该 webhook 事件三次。该 webhook 事件重试服务有助于在出现网络问题或客户端服务中断与部署期间，提升可靠性并实现事件恢复。
 

### 什么是重试？

当客户端的 Web 应用未对账户活动 webhook 事件返回 200 “成功”响应时，Account Activity API 会启用重试功能。当客户端未确认成功接收事件时，X 会认为该事件未被接收。如果收到非 200 响应、在三秒内未收到响应，或完全没有响应，我们会重试该请求，并将连接保持打开三秒。这意味着你在两次尝试中总计大约有五秒时间来响应，以接收我们尝试发送到你的 webhook URL 的活动。如果你的服务器没有响应或返回了瞬时错误，我们将持续重试五分钟。为完成验证，总共会进行三次重试尝试。这样可以提供冗余与保障，确保你接收到所有 webhook 事件。请注意，启用重试的订阅，其 webhook 会对所有已订阅用户的任何/所有活动接收到被重试的事件。

如果你未能在这八次尝试内完成验证确认，该活动将无法再通过 Account Activity API 获取。 

<div id="what-are-retries">
  ### 重试时间线
</div>

Account Activity API 会在五分钟内最多重试三次，直至收到 200 响应。有关更多详情，请参阅下表。约五分钟后，无法通过 Account Activity API 重新发送该活动。您需要使用其他 X 端点来收集遗漏的数据。例如，可以使用 [search APIs](/zh/x-api/enterprise-gnip-2.0/fundamentals/search-api) 来检索相关帖子、转发、引用推文、提及和回复。遗漏的私信可通过 [此端点](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/list-events) 获取。

#### 重试时间线

|     |
| :--- |
| 活动已创建，Account Activity API 向 webhook URL 发送 POST 请求，并在 3 秒内超时。 |
| 在上一轮超时结束后等待 3 秒，然后 Account Activity API 再次向 webhook URL 发送 POST 请求，并在 3 秒内超时。 |
| 在上一轮超时结束后等待 27 秒，然后 Account Activity API 再次向 webhook URL 发送 POST 请求，并在 3 秒内超时。 |
| 在上一轮超时结束后等待 242 秒，然后 Account Activity API 再次向 webhook URL 发送 POST 请求，并在 3 秒内超时。 |
| 之后，Account Activity API 将不再尝试发送 POST。客户端必须使用其他 X 端点来补回数据。 |

## Account Activity 数据对象结构

| 对象 | 详情 |
| :--- | :--- |
| for\_user\_id | 标识与该事件相关的订阅用户。 |
| is\_blocked\_by | （可选）仅当其他用户提及你所订阅的用户时显示。仅在帖子提及事件且为 true 时包含。 |
| source | 执行动作的用户。例如，发起关注、屏蔽或静音的用户为来源用户。 |
| target | 动作作用到的用户。例如，被关注、被屏蔽或被静音的用户为目标用户。 |

**可用活动**

| 消息类型 | 详情 |
| :--- | :--- |
| [tweet\_create\_events](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#tweet-create-events-posts-retweets-replies-quotetweets) | 当订阅用户发起或收到以下任一操作时的帖子状态负载：发帖、转推、回复、@ 提及、引用推文、对引用推文的转推。 |
| [favorite\_events](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#favorite-events) | 包含用户与目标的收藏（点赞）事件状态。 |
| [follow\_events](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#follow-events) | 包含用户与目标的关注事件。 |
| [unfollow\_events](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#unfollow-events) | 包含用户与目标的取消关注事件。 |
| [block\_events](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#block-events) | 包含用户与目标的屏蔽事件。 |
| [unblock\_events](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#unblock-events) | 包含用户与目标的取消屏蔽事件。 |
| [mute\_events](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#mute-events) | 包含用户与目标的静音事件。 |
| [unmute\_events](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#unmute-events) | 包含用户与目标的取消静音事件。 |
| [user\_event](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#user-event) | 当用户移除应用授权且订阅被自动删除时发送的撤销事件。 |
| [direct\_message\_events](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#direct-message-events) | 当私信被发送或接收时，包含用户与目标的私信状态。 |
| [direct\_message\_indicate\_typing\_events](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#direct-message-indicate-typing-events) | 包含用户与目标的私信“正在输入”事件。 |
| [direct\_message\_mark\_read\_events](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#direct-message-mark-read-events) | 包含用户与目标的私信“标记为已读”事件。 |
| [tweet\_delete\_events](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#tweet-delete-events) | 删除帖子通知，便于维护合规性。 |

**负载示例**

请参阅下方针对上表中每个 Account Activity 事件的负载示例。

#### tweet\_create\_events（帖子、转推、回复、引用帖子） 

```
{
	"for_user_id": "2244994945",
	"tweet_create_events": [
	  {
		<Tweet Object>
	  }
	]
}
```

#### tweet\_create\_events（@提及）

```
{
	"for_user_id": "2244994945",
	"user_has_blocked": "false",
	"tweet_create_events": [
	  {
		<Tweet Object>
	  }
	]
}
```

#### favorite\_events

```
{
	"for_user_id": "2244994945",
	"favorite_events": [{
		"id": "a7ba59eab0bfcba386f7acedac279542",
		"created_at": "Mon Mar 26 16:33:26 +0000 2018",
		"timestamp_ms": 1522082006140,
		"favorited_status": {
			<Tweet Object>
		},
		"user": {
			<User Object>
		}
	}]
}
```

#### follow\_events

```
{
	"for_user_id": "2244994945",
	"follow_events": [{
			"type": "follow",
			"created_timestamp": "1517588749178",
			"target": {
				<User Object >
			},
			"source": {
				< User Object >
			}
		]
	}
}
```

<div id="follow_events">
  #### 取消关注事件
</div>

```
{
	"for_user_id": "2244994945",
	"follow_events": [{
			"type": "unfollow",
			"created_timestamp": "1517588749178",
			"target": {
				<User Object>
			},
			"source": {
				<User Object>
			}
		]
	}
}
```

#### block\_events

```
{
	"for_user_id": "2244994945",
	"block_events": [{
		"type": "block",
		"created_timestamp": "1518127020304",
		"source": {
			<User Object>
		},
		"target": {
			<User Object>
		}
	}]
}
```

#### unblock\_events

```
{
	"for_user_id": "2244994945",
	"block_events": [{
		"type": "unblock",
		"created_timestamp": "1518127020304",
		"source": {
			<User Object>
		},
		"target": {
			<User Object>
		}
	}]
}
```

#### mute\_events

```
{
	"for_user_id": "2244994945",
	"mute_events": [
		{
			"type": "mute",
		  	"created_timestamp": "1518127020304",
			"source": {
				<User Object>
			},
			"target": {
				<User Object>
			}
		}
	]
}
```

<div id="mute_events">
  #### 取消静音事件
</div>

```
{
	"for_user_id": "2244994945",
	"mute_events": [
		{
			"type": "unmute",
		  	"created_timestamp": "1518127020304",
			"source": {
				<User Object>
			},
			"target": {
				<User Object>
			}
		}
	]
}
```

#### user\_event

```
{
	"user_event": {
		"revoke": {
			"date_time": "2018-05-24T09:48:12+00:00",
			"target": {
				"app_id": "13090192"
			},
			"source": {
				"user_id": "63046977"
			}
		}
	}
}
```

#### direct\_message\_events

```
{
  	"for_user_id": "4337869213",
	"direct_message_events": [{
		"type": "message_create",
		"id": "954491830116155396",
		"created_timestamp": "1516403560557",
		"message_create": {
			"target": {
				"recipient_id": "4337869213"
			},
			"sender_id": "3001969357",
			"source_app_id": "13090192",
			"message_data": {
				"text": "Hello World!",
				"entities": {
					"hashtags": [],
					"symbols": [],
					"user_mentions": [],
					"urls": []
				}
			}
		}
	}],
	"apps": {
		"13090192": {
			"id": "13090192",
			"name": "FuriousCamperTestApp1",
			"url": "https://x.com/furiouscamper"
		},
		"users": {},
		"3001969357": {
			"id": "3001969357",
			"created_timestamp": "1422556069340",
			"name": "Jordan Brinks",
			"screen_name": "furiouscamper",
			"location": "Boulder, CO",
			"description": "另一个身份 - X PE 仅代表个人观点",
			"url": "https://t.co/SnxaA15ZuY",
			"protected": false,
			"verified": false,
			"followers_count": 22,
			"friends_count": 45,
			"statuses_count": 494,
			"profile_image_url": "null",
			"profile_image_url_https": "https://pbs.twimg.com/profile_images/851526626785480705/cW4WTi7C_normal.jpg"
		},
		"4337869213": {
			"id": "4337869213",
			"created_timestamp": "1448312972328",
			"name": "Harrison Test",
			"screen_name": "Harris_0ff",
			"location": "Burlington, MA",
			"protected": false,
			"verified": false,
			"followers_count": 8,
			"friends_count": 8,
			"profile_image_url": "null",
			"statuses_count": 240,
			"profile_image_url_https": "https://abs.twimg.com/sticky/default_profile_images/default_profile_normal.png"
		}
	}
}
```

#### direct\_message\_indicate\_typing\_events

```
{
	"for_user_id": "4337869213",
	"direct_message_indicate_typing_events": [{
		"created_timestamp": "1518127183443",
		"sender_id": "3284025577",
		"target": {
			"recipient_id": "3001969357"
		}
	}],
	"users": {
		"3001969357": {
			"id": "3001969357",
			"created_timestamp": "1422556069340",
			"name": "Jordan Brinks",
			"screen_name": "furiouscamper",
			"location": "Boulder, CO",
			"description": "Alter Ego - X PE opinions-are-my-own",
			"url": "https://t.co/SnxaA15ZuY",
			"protected": false,
			"verified": false,
			"followers_count": 23,
			"friends_count": 47,
			"statuses_count": 509,
			"profile_image_url": "null",
			"profile_image_url_https": "https://pbs.twimg.com/profile_images/851526626785480705/cW4WTi7C_normal.jpg"
		},
		"3284025577": {
			"id": "3284025577",
			"created_timestamp": "1437281176085",
			"name": "Bogus Bogart",
			"screen_name": "bogusbogart",
			"protected": true,
			"verified": false,
			"followers_count": 1,
			"friends_count": 4,
			"statuses_count": 35,
			"profile_image_url": "null",
			"profile_image_url_https": "https://pbs.twimg.com/profile_images/763383202857779200/ndvZ96mE_normal.jpg"
		}
	}
}
```

#### direct\_message\_mark\_read\_events

```
{
	"for_user_id": "4337869213",
	"direct_message_mark_read_events": [{
		"created_timestamp": "1518452444662",
		"sender_id": "199566737",
		"target": {
			"recipient_id": "3001969357"
		},
		"last_read_event_id": "963085315333238788"
	}],
	"users": {
		"199566737": {
			"id": "199566737",
			"created_timestamp": "1286429788000",
			"name": "Le Braat",
			"screen_name": "LeBraat",
			"location": "Denver, CO",
			"description": "白天做数据 @X，傍晚做设计",
			"protected": false,
			"verified": false,
			"followers_count": 299,
			"friends_count": 336,
			"statuses_count": 752,
			"profile_image_url": "null",
			"profile_image_url_https": "https://pbs.twimg.com/profile_images/936652894371119105/YHEozVAg_normal.jpg"
		},
		"3001969357": {
			"id": "3001969357",
			"created_timestamp": "1422556069340",
			"name": "Jordan Brinks",
			"screen_name": "furiouscamper",
			"location": "Boulder, CO",
			"description": "另一个身份——X PE（仅代表个人观点）",
			"url": "https://t.co/SnxaA15ZuY",
			"protected": false,
			"verified": false,
			"followers_count": 23,
			"friends_count": 48,
			"statuses_count": 510,
			"profile_image_url": "null",
			"profile_image_url_https": "https://pbs.twimg.com/profile_images/851526626785480705/cW4WTi7C_normal.jpg"
		}
	}
}
```

#### tweet\_delete\_events

```
{
    "for_user_id": "930524282358325248",
    "tweet_delete_events": [
{
        "status": {
            "id": "1045405559317569537",
            "user_id": "930524282358325248"
        },
        "timestamp_ms": "1432228155593"
    }
   ]
}
```

## 账户活动回放 API

`Enterprise`

账户活动回放 API 是一款数据恢复工具，允许你检索最久可追溯至五天前的事件。它适用于你的 [webhook](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#enterprise-account-activity-api) 服务器错过事件的情形——无论是由于断连时间超过了[重试窗口](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#retries)，还是在灾难恢复场景中需要数天时间将系统恢复正常。

账户活动回放 API 专为在一段时间内未能摄取[活动](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity)的场景而设计。它会将活动投递到与原始实时投递相同的 webhook。该产品是恢复工具而非回填工具，这意味着仅当此前曾尝试投递相应事件时，才会回放这些事件。账户活动回放 API 无法为订阅创建时间之前的时间段投递事件。

### 使用 Account Activity Replay API

如果你的账户已配置 Replay 功能，你可以以与调用 Account Activity API 类似的方式发起请求。需要注意，你的请求必须指定 webhook id 参数，以表明要回放哪个 webhook 的活动。换言之，Replay 请求会要求 Account Activity Replay API 基于 webhook id 和 application id，在指定的起止日期时间范围内检索事件。

请使用 UTC 时间。这些活动将通过与该 id 关联的已注册 webhook 进行投递，速率最高可达每秒 2,500 个事件。另请注意，同一时间每个 webhook 只能运行一个 Replay 作业，但该 webhook 上在所指定日期/时间范围内处于活动状态的所有订阅都会被回放。

事件的投递会从指定时间段的第一个（最早的）分钟开始，按时间顺序（尽可能）持续到最后一分钟被投递。届时，Replay 会向该 webhook 投递一个[作业完成事件](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#job-completed-successfully-message)。由于我们按时间顺序投递活动，如果在开始时间附近几乎没有匹配结果，那么在首次结果投递之前很可能会有一段等待时间。

<div id="using-account-activity-replay-api">
  ### 限制
</div>

Replay 旨在作为便于恢复最长可追溯至过去五天内活动的工具，但它不会返回早于订阅创建时间的事件。举例来说，如果你在三天前添加了一个新订阅，并运行了一个时间窗口涵盖截至今天前五天的 Replay 作业，你只会收到该新订阅处于活动状态的这三天的数据。

<div id="limitations">
  ### 数据可用性与类型
</div>

来自 Account Activity Replay API 的活动数据自请求发起之时起可用为期五天，且新数据通常在某项活动创建约 10 分钟后可用。您可以在这五天的时间窗口内，使用请求中的 from\_date 和 to\_date 参数指定时间范围发起请求。在获得 Replay 访问权限之前已投递的事件无法重放。举例来说，如果您的账户在 2019 年 6 月 1 日 15:30（UTC）被启用访问 Account Activity Replay API，您将无法使用 Replay 检索该日期和时间之前的任何事件。

继续查看 [Account Activity Replay API 参考](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id-subscriptions-all-deprecated)

## 迁移介绍

**我们已于 2018 年下线了 Site Streams、User Streams，以及 Account Activity API（仅限 DM）的标准测试版产品。若您曾使用这些产品，请务必迁移至 Account Activity API 的高级版或企业版。**

**我们也已下线了旧版 Direct Message 端点。若您曾使用这些端点，请务必迁移至新的 DM 端点，或迁移至 Account Activity API 的高级版或企业版。**

**请查看[此公告](https://devcommunity.x.com/t/details-and-what-to-expect-from-the-api-deprecations-this-week-on-august-16-2018/110746)以了解更多信息。**

以下端点将受到这些变更的影响：

- User Streams
- Site Streams
- GET direct\_messages
- GET direct\_messages/sent
- GET direct\_messages/show
- POST direct\_messages/new
- POST direct\_messages/destroy
   

我们现已提供新的端点和服务，既能提供类似的访问能力，也为私信（Direct Messages）增加了部分功能：

- Account Activity API 的[企业版](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#enterprise-account-activity-api)与[高级版](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#account-activity-api-reference-index)
- [GET direct\_messages/events/list](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/list-events)
- [GET direct\_messages/events/show](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/get-event)
- [POST direct\_messages/events/new](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/new-event)
- [POST direct\_messages/events/destroy](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/delete-message-event)

为帮助您顺利迁移到这些新端点和服务，我们提供了两份迁移指南：

- [Account Activity API 迁移指南](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#migration-guide-moving-from-user-streams-site-streams-to-account-activity-api)，适用于从 User Streams 和 Site Streams 迁移至我们基于 Webhook 的新服务
- [Direct Message 迁移指南](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/guides/direct-message-migration)，适用于在 Direct Message REST 端点之间迁移
   

此外，我们还有一[系列视频](https://www.youtube.com/playlist?list=PLFKjcMIU2WshGG6Yj940XM7Z6BFs1zfBg)，介绍 Account Activity API 及其入门方法。

最后，我们提供了代码示例以加深理解并帮助您快速上手：

- [Account Activity Dashboard](https://github.com/xdevplatform/Account-Activity-dashboard) 是一个示例 Node.js Web 应用，附带辅助脚本，帮助您开始使用 Account Activity API。
- [SnowBot](https://github.com/xdevplatform/SnowBotDev) 是一个使用 Account Activity API 和 REST Direct Message 端点的示例聊天机器人。其使用 Ruby 编写，基于 Sinatra Web 应用框架，并部署在 Heroku 上。

<div id="migration-introduction">
  ## 迁移指南：从 User Streams/Site Streams 迁移到 Account Activity API
</div>

**自 2018 年 8 月 23 日起，我们已停用 Site Streams 和 User Streams。请务必迁移至 Account Activity API。**

**请查看[此公告](https://devcommunity.x.com/t/details-and-what-to-expect-from-the-api-deprecations-this-week-on-august-16-2018/110746)了解更多信息。**

本指南旨在帮助你从旧版 User Streams 和 Site Streams API 迁移至其替代方案 Account Activity API。下文提供变更摘要、新功能清单，以及关键差异与注意事项，助你顺利完成迁移。若需关于从基础 DM 端点迁移的指导，请参阅[私信迁移指南](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/guides/direct-message-migration)。

### 变更摘要

与 User Streams 和 Site Streams 等流式连接不同，Account Activity API 将通过 webhook 向已通过身份验证且已订阅的账户投递事件。

#### 已弃用的 API

GET user

GET site（包括控制流：GET site/c/:stream\_id、GET site/c/:stream\_id/info.json、GET site/c/:stream\_id/friends/ids.json、POST site/c/:stream\_id/add\_user.json、POST /site/c/:stream\_id/remove\_user.json）

<div id="deprecated-apis">
  #### 替换 API
</div>

[企业账户活动 API - 全部活动](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#enterprise-account-activity-api)

<div id="new-features">
  ### 差异与迁移注意事项
</div>

**API 格式：** 新版 Account Activity API 的工作方式与 User Streams 和 Site Streams 不同。你需要调整你的 Web 应用，以通过 webhooks 接收数据。关于 webhooks 的更多信息请参见[此处](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#getting-started-with-webhooks)。

**可用数据：** 你会注意到的另一个关键差异在于交付的数据。X 将不再发送你在 X 上关注的人的事件（即你的主页时间线）。这是经过刻意设计的更改，且我们不计划在未来对此进行调整。

**可靠性：** 与流式传输不同，webhooks 支持交付确认，并可对未成功到达 webhook URL 的已 POST 活动进行重试。这可以更有把握地确保应用接收到所有适用的活动，即使存在短暂的断连或停机。

<div id="differences-migration-considerations">
  ### 新功能
</div>

Account Activity API 提供了许多新功能，其中最主要的是，数据现改为通过 webhook 而非流式传输进行投递。与流式传输相比，webhook 的优势众多，尤以速度与可靠性为著。API 会在数据可用时以 JSON 事件的形式发送给你，你无需再维持持久连接或轮询端点。这减少了冗余机制的需求，并整体提升效率。有关 webhook 的更多信息，请参见[技术文档](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#getting-started-with-webhooks)。

<div id="new-features">
  ### 管理用户订阅
</div>

Account Activity API 允许为单个已注册的 webhook 创建多个订阅。这样可将多个用户订阅的活动通过 webhook 投递到同一位置，类似于 Site Streams 的架构。这意味着你可以在订阅上限的约束下，独立于 webhook 连接来跟踪订阅。这也便于扩展：从仅有一个或少量订阅，扩展到单个 webhook 下的数千个订阅。

<div id="managing-user-subscriptions">
  ### **迁移指南**
</div>

<div id="how-to-migrate">
  ### **按照以下步骤，轻松从 Site Streams API 迁移到 Account Activity API**
</div>

**步骤 1：选择套餐**

根据你当前使用 User Streams 或 Site Streams 的方式，考虑迁移到 Account Activity API 的企业版或高级版。请根据你目前支持的应用数量或授权用户数量进行评估，并按所需的吞吐量和可靠性进行相应扩展。选择最适合你需求的套餐时，可重点考虑：

- 所需的 webhook 数量
- 你的应用当前/预计管理的订阅数/授权用户数
- 当前的 X 客户端应用数量
- 你期望从 X 获得的支持级别（论坛支持或托管的企业级一对一支持）
- 各套餐的价格

**步骤 2：** **在开发者门户检查你的 X 应用设置**

当前用于 User Streams 或 Site Streams 的 [X 应用](/zh/resources/fundamentals/developer-apps) 会在[开发者门户](/zh/resources/fundamentals/developer-portal)中显示为其所属用户名下的应用。该 X 应用也可用于 Account Activity API，从而保留该应用的已授权用户。你也可以创建一个新应用，并在需要时让用户为该新应用重新授权。如果你代表企业创建新应用，建议使用公司的 X @handle 账户创建。

- 在 X 应用页面的[权限](/zh/resources/fundamentals/developer-apps#app-permissions)选项卡启用“读取、写入和访问私信”。
  \*请注意，更改这些设置不具有追溯效力，任何已授权用户将保留其最初授权时的权限设置。如果某用户尚未授予读取、写入和私信访问权限，你需要让该用户重新授权你的应用。
- 如果你不熟悉 [X 登录](/zh/resources/fundamentals/authentication#log-in-with-x)以及用户上下文在 X API 中的工作方式，请查看[获取访问令牌](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#getting-started-with-webhooks)。
- 在“Keys and Tokens”选项卡底部为 X 应用所有者生成访问令牌。在同一选项卡记录你的 Consumer Key、Consumer Secret、Access Token 和 Access Token Secret。你在使用 API 时需要这些信息。
- 使用你的 Consumer Key 和 Consumer Secret 生成用于[仅应用](/zh/resources/fundamentals/authentication#bearer-token-also-known-as-app-only) API 方法的 Bearer 令牌。

**步骤 3：设置并配置你的 Webhook**

- 创建一个带有端点的 Web 应用，将其作为 webhook 来接收事件（例如：https://your\_domain.com/webhook/twitter 或 https://webhooks.your\_domain.com）。

- 在创建 webhook 时使用你的 Consumer Key、Consumer Secret、Access Token 和 Access Token Secret。请注意，你的端点必须返回一个包含 response\_token 的 JSON 响应，该 response\_token 是由 crc\_token 与应用的 Consumer Secret 生成的、经 base64 编码的 HMAC SHA-256 哈希。

- 查阅[保护 Webhook](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#securing-webhooks)文档，特别注意 Challenge Response Check（CRC）要求。

- 确保你的 webhook 支持用于接收事件的 POST 请求以及用于 CRC 的 GET 请求。

- 确保你的 webhook 具备低延迟（对 POST 请求的响应时间小于 3 秒）。

**步骤 4：验证你的 Webhook 设置**

- Webhook API 将通过两种方式保护你的 webhook：

               - 要求进行挑战响应检查，以验证 webhook 的所有者与 Web 应用的所有者一致。

               - 在发送至你 Web 应用的每个 POST 请求中包含签名请求头，供你验证来源。

- 为了验证你同时拥有该 Web 应用和 webhook URL，X 将执行一次 Challenge Response Check（CRC），这与循环冗余校验不同。
- 将向你的 webhook URL 发送一个带有名为 crc\_token 参数的 GET 请求。你的端点必须返回一个包含 response\_token 的 JSON 响应，该 response\_token 是由 crc\_token 与应用的 Consumer Secret 生成的、经 base64 编码的 HMAC SHA-256 哈希。
- 预期每次传入的 CRC 请求其 crc\_token 都会变化。计算时应将 crc\_token 作为消息内容，使用你的 Consumer Secret 作为密钥。
- 如果响应无效，将停止向已注册的 webhook 发送事件。

**步骤 5：为每个 User Stream 或 Site Streams 的授权用户创建订阅**

从 User Streams 迁移到 Account Activity API：

- 在用户流（User Streams）上生成当前用户订阅的列表
- 使用请求：  _POST account\_activity/all/:env\_name/subscriptions_ 设置新的 Account Activity API 订阅
- 使用请求：  \_GET account\_activity/all/:env\_name/subscriptions/list
   \_ 确认您的 Account Activity API 订阅

从站点流（Site Streams）迁移到 Account Activity API（使用控制流）：

- 使用请求：  _GET /1.1/site/c/:stream\_id/info.json_ 在站点流上生成当前订阅的列表
- 使用请求：  _POST account\_activity/all/:env\_name/subscriptions_ 设置新的 Account Activity API 订阅
- 使用请求：  \_GET account\_activity/all/:env\_name/subscriptions/list
   \_ 确认您的 Account Activity API 订阅

注册 Webhook 并创建订阅（非从 Site Streams 或 User Streams 迁移）

- 使用 [POST webhooks](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#enterprise-account-activity-api) 在应用中注册您的 webhook URL，并获取 webhook\_id。
- 使用返回的 webhook\_id，通过 [POST webhooks/:webhook\_id/subscriptions/all](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks-webhook-id-subscriptions-all) 添加用户订阅。

<div id="follow-the-steps-below-to-easily-migrate-from-the-site-streams-api-to-the-account-activity-api">
  ### 账户活动仪表板（Account Activity API 示例应用）
</div>

我们提供了一个示例应用，方便更快速地测试 Account Activity API：   

- 在[此处](https://github.com/xdevplatform/Account-Activity-dashboard)下载 Account Activity Dashboard 示例应用（基于 Node.js）
- 按照 README 的说明安装并启动应用
- 应用启动后，您可以通过 UI 轻松设置 webhook，并创建新的订阅

<div id="the-account-activity-dashboard-sample-account-activity-api-application">
  ### 可用活动
</div>

| 消息类型 | 详情 |
| :--- | :--- |
| [tweet\_create\_events](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#tweet-create-events-posts-retweets-replies-quotetweets) | 当订阅用户发起或收到以下任一行为时的帖子状态载荷：发布、转发、回复、@提及、引用 |
| [favorite\_events](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#favorite-events) | 收藏（点赞）事件状态，包含用户与目标。 |
| [follow\_events](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#follow-events) | 关注事件，包含用户与目标。 |
| [block\_events](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#block-events) | 屏蔽事件，包含用户与目标。 |
| [mute\_events](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#mute-events) | 静音事件，包含用户与目标。 |
| [direct\_message\_events](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#direct-message-events) | 私信事件状态，包含用户与目标。 |
| [direct\_message\_indicate\_typing\_events](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#direct-message-indicate-typing-events) | 私信输入指示事件，包含用户与目标。 |
| [direct\_message\_mark\_read\_events](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#direct-message-mark-read-events) | 私信已读事件，包含用户与目标。 |

### 已弃用的流式消息类型 

|     |     |
| :--- | :--- |
| 空行 | Account Activity API 将不再传递空行；此前这些空行在 User Streams 和 Site Streams 中被用作保活消息。 |
| 限制通知 | 限制通知将不再发送到指定的 webhook。相应地，用户可以调用 API 获取当前可用 handle 的使用情况。此信息未来也将加入开发者门户。 |
| 断开连接消息 | 不再需要断开连接通知，因为 webhook 不依赖活动连接。 |
| 阻塞警告 | 不再需要阻塞警告，因为 webhook 不依赖必须处理大量入站消息的活动连接。 |
| 好友列表 | 将不再主动推送好友列表。现在将提供一个 REST 端点以获取该信息。 |

<div id="deprecated-streaming-message-types">
  ### 已弃用的事件类型
</div>

|     |     |     |     |     |
| :--- | :--- | :--- | :--- | :--- |
| **描述** | **事件名称** | **来源** | **目标** | **目标对象** |
| 用户删除一条帖子 | delete | 当前用户 | 当前用户 | 帖子 |
| 关注的用户删除一条帖子 | delete | 被关注的用户 | 被关注的用户 | 帖子 |
| 用户取消点赞一条帖子 | unfavorite | 当前用户 | 帖子作者 | 帖子 |
| 用户的帖子被取消点赞 | unfavorite | 取消点赞的用户 | 当前用户 | 帖子 |
| 用户取消关注某人 | unfollow | 当前用户 | 被关注的用户 | Null |
| 用户创建一个列表 | list\_created | 当前用户 | 当前用户 | 列表 |
| 用户删除一个列表 | list\_destroyed | 当前用户 | 当前用户 | 列表 |
| 用户编辑一个列表 | list\_updated | 当前用户 | 当前用户 | 列表 |
| 用户将某人添加到列表 | list\_member\_added | 当前用户 | 被添加的用户 | 列表 |
| 用户被添加到某个列表 | list\_member\_added | 添加的用户 | 当前用户 | 列表 |
| 用户将某人从列表中移除 | list\_member\_removed | 当前用户 | 被移除的用户 | 列表 |
| 用户被从某个列表中移除 | list\_member\_removed | 移除的用户 | 当前用户 | 列表 |
| 用户订阅一个列表 | list\_user\_subscribed | 当前用户 | 列表所有者 | 列表 |
| 用户的列表被订阅 | list\_user\_subscribed | 订阅的用户 | 当前用户 | 列表 |
| 用户取消订阅一个列表 | list\_user\_unsubscribed | 当前用户 | 列表所有者 | 列表 |
| 用户的列表被取消订阅 | list\_user\_unsubscribed | 取消订阅的用户 | 当前用户 | 列表 |
| 用户更新其个人资料 | user\_update | 当前用户 | 当前用户 | Null |
| 用户更新其受保护状态 | user\_update | 当前用户 | 当前用户 | Null |

## 私信迁移指南

**我们已于 2018 年 9 月 17 日停用旧版私信端点。
如果你一直在使用这些端点，请务必迁移到新的私信端点或 Account Activity API。**

**请查看[此公告](https://devcommunity.x.com//t/details-and-what-to-expect-from-the-api-deprecations-this-week-on-august-16-2018/110746)以了解更多信息。**

本指南旨在帮助你从旧版私信 REST API 迁移到已毕业、功能增强的替代方案。下文提供变更摘要、新功能列表，以及有助于迁移的关键差异与注意事项。新的私信端点现已向所有开发者开放。有关从 User Streams 或 Site Streams 迁移的说明，请参阅[迁移至 Account Activity API 的指南](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#migration-guide-moving-from-user-streams-site-streams-to-account-activity-api)。

- [变更摘要](#summary)
- [新功能](#features)
- [发送私信](#sending)
- [接收私信](#receiving)
- [删除私信](#deleting)

### 变更摘要

如果您仍在使用以下 DM 端点，则需要迁移至较新的端点。

| 已弃用端点 | 新的迁移替代 |
| :--- | :--- |
| [POST direct\_messages/new](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/new-event) | [POST direct\_messages/events/new](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/new-event) |
| [GET direct\_messages/show](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/get-event) | [GET direct\_messages/events/show](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/get-event) |
| [GET direct\_messages](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/list-events) | [GET direct\_messages/events/list](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/list-events) |
| [GET direct\_messages/sent](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/get-event) | [GET direct\_messages/events/list](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/list-events) |
| [POST direct\_messages/destroy](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/delete-message-event) | [DELETE direct\_messages/events/destroy](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/delete-message-event "GET direct_messages/events/list") |

<div id="summary-of-changes">
  ### 新增功能
</div>

新的 Direct Message API 端点支持多项新功能，并改进了对历史私信的访问。新增内容包括：

- 支持媒体附件（图片、GIF 和视频）。
- 可通过预定义的选项列表提示用户进行结构化回复。
- 最长可获取过去 30 天的私信。

有关新的 Direct Message 功能的完整列表以及其他新增 API 端点，请参阅[技术文档](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/overview)。
 

<div id="new-features">
  ### 差异与迁移注意事项
</div>

新的 API 端点与旧版本的对应端点在行为上有显著差异。仅更新端点 URL 将会导致应用出现错误。在为迁移更新应用时，请注意以下事项。

#### 新的私信对象

首先你会注意到私信对象采用了全新的结构。新的 Message Create 对象结构引入是为了支持诸如 [Quick Replies](https://developer.x.com/en/docs/x-api/v1/direct-messages/quick-replies/overview) 和 [Attachments](https://developer.x.com/en/docs/x-api/v1/direct-messages/message-attachments/overview) 等新功能。新对象也包含一个更小、更精简的用户对象。你的应用需要更新以适配这一新的对象结构，包括在解析阶段以及可能在数据模型或存储层进行相应调整。各属性说明请参阅[Message Create 对象的完整文档](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/guides/message-create-object)。

**示例 message create 对象**

```json
{
      "type": "message_create",
      "id": "1234858592",
      "created_timestamp": "1392078023603",
      "initiated_via": {
        "tweet_id": "123456",
        "welcome_message_id": "456789"
      },
      "message_create": {
        "target": {
          "recipient_id": "1234858592"
        },
        "sender_id": "3805104374",
        "source_app_id": "268278",
        "message_data": {
          "text": "Blue Bird",
          "entities": {
            "hashtags": [],
            "symbols": [],
            "urls": [],
            "user_mentions": [],
          },
          "quick_reply_response": {
            "type": "options",
            "metadata": "external_id_2"
          },
          "attachment": {
            "type": "media",
            "media": {
             ...
            }
          }
        }
      }
```

<div id="new-direct-message-object">
  #### 摘要
</div>

- 全新的私信对象结构。
- 更为精简的用户对象。
- 新增信息（快捷回复的响应、附件等）。

### 发送私信

[POST direct\_messages/events/new](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/new-event) 是用于发送私信的替代接口。与以往的端点相比，最大的区别在于：现在所有信息都作为 JSON 放在 POST 请求体中，而不是作为单独的 POST 参数。

**Twurl 请求示例**

```bash
twurl -A 'Content-type: application/json' -X POST /1.1/direct\_messages/events/new.json -d '{"event": {"type": "message\_create", "message\_create": {"target": {"recipient\_id": "4534871"}, "message_data": {"text": "Hello World!"}}}}'
```

请注意，上述请求中 content-type 设置为 application/json，而不是 application/x-www-form-urlencoded。此外，若你在构造 OAuth 1.0a 签名，请注意 JSON 请求体不参与签名生成。大多数 OAuth 库已考虑到这一点。若你使用 [twurl](https://github.com/twitter/twurl)，请确保版本至少为 0.9.3。

<div id="new-direct-message-object">
  #### 摘要
</div>

- 消息在 JSON POST 正文中定义
- 必须将 Content-Type 头设置为 application/json
- 生成 OAuth 签名时不包含 JSON 正文。
   

### 检索私信

现在可通过单一 API 端点检索历史私信：[GET direct\_messages/events/list](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/list-events)。该新端点的主要变化在于，它会按时间逆序同时返回已发送和已接收的消息，这有助于更容易重建对话。不过，如果你仅需已发送或仅需已接收的消息，则需依据 `sender_id` 属性对返回结果进行后处理。

分页机制现基于游标值而非某条私信的 ID。每个响应都会返回一个 `cursor` 属性。[GET direct\_messages/events/list](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/list-events) 最多返回过去 30 天的消息，不受该时间范围内消息数量的影响。未返回游标即表示没有更多消息可供获取。使用 [GET direct\_messages/events/show](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/get-event) 访问单条私信的方法保持不变，但返回的私信对象结构已如前文所述有所调整。

最后，私信的实时访问将通过配合 [Account Activity API](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity) 的 webhook 实现。有关从 User Streams 或 Site Streams 迁移的指导，请参阅 Account Activity API 的迁移指南以获取更多信息。

<div id="new-direct-message-object">
  #### 摘要
</div>

- 发送和接收的消息现可通过同一端点返回。
- 可返回最长 30 天内的消息。
- 支持基于游标的分页。
- 通过 webhook 实现对私信的实时访问。

### 删除私信

现在可以使用 DELETE direct\_messages/events/destroy 删除私信。接口基本一致，仍需提供要删除消息的 ID。主要区别在于该端点现在需要发送 DELETE 请求，而不是 POST 请求。

已删除的私信在官方 X 客户端中的呈现方式保持不变。私信只会从所提供用户上下文对应的界面中移除，对话中的其他成员仍可访问该私信。

<div id="new-direct-message-object">
  #### 摘要
</div>

- 删除私信需要提供 ID。
- 新的端点需要使用 DELETE 请求。
- 已删除的私信在 X 官方客户端中的展示方式保持不变。

**关于迁移到新的私信端点有疑问？**
请在开发者社区论坛 [devcommunity.com](https://devcommunity.x.com/) 提问。

## 常见问题解答

### 常规

**使用 Account Activity API 有哪些优势？**

Account Activity API 采用 webhooks。与流式 API 不同，我们无需你保持长连接即可向你发送信息。Webhooks 也不同于 REST API，你不必每 15 分钟轮询数百次来获取关心的数据。它会在事件发生时投递数据，从而提升用户与应用之间的交互效率。

Account Activity API 具备以下优势：

1. **速度**：以 X 的速度投递数据。
2. **简洁**：通过单个 webhook 连接投递一个账户的全部事件。API 可投递的活动包括：帖子、@提及、回复、转发、引用推文、对引用推文的转发、点赞、已发送私信、已接收私信、关注、屏蔽、隐藏。
3. **规模**：你可接收所管理账户的全部活动，不受速率限制或事件上限的约束。

Account Activity API 提供高级沙盒、高级付费和企业版，可随你的账户数量与功能需求进行扩展。

开始使用，请从 [GitHub](https://github.com/xdevplatform/account-activity-dashboard) 下载示例代码片段。
 

**我如何判断哪个产品层级最适合我？**

请阅读我们的 [Account Activity API 概览](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity) 页面，了解高级版与企业版之间的差异。 
 

**高级环境与企业版 webhook 有什么区别？**

没有区别。每个高级环境都会有自己的 webhook\_id。
 

**我需要为 Account Activity API 设置开发、预发布和生产环境，可以吗？**

可以！在 Account Activity API 的付费层级（高级付费和企业版）中，你可以注册多个 webhook URL，并通过 API 方法分别管理各环境的订阅。此外，可将多个客户端应用加入允许列表，以维持你当前已授权用户的授权状态。
 

**是否有关于如何设置 Account Activity API 的分步指南？**

当然有！

- 如果你刚开始，我们建议查看[使用 webhooks 入门](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#getting-started-with-webhooks)指南

- 可配合使用我们由 X Dev 支持的脚本： 
  - [Account Activity API 仪表板](https://github.com/xdevplatform/account-activity-dashboard)：一个用于展示 webhook 事件的 Node 网页应用。
  - [SnowBot 聊天机器人](https://github.com/xdevplatform/SnowBotDev)：一个基于 Account Activity 和 Direct Message API 构建的 Ruby 网页应用。该代码库包含用于设置 Account Activity API webhooks 的[脚本](https://github.com/xdevplatform/SnowBotDev/wiki/Account-Activity-API-setup-script)。
     

**如果我们的系统在一段时间内宕机，有没有办法恢复数据？**

在 Account Activity API 的付费层级（高级付费和企业版）中，我们的系统会在四小时内[重试](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#retries)多次向你发送活动。如果你的系统在这四小时内未响应，则该活动将丢失，你需要在 7 天内使用其他 REST 端点来恢复数据。

我们建议将不同的 webhooks 或环境用作冗余手段，例如使用 [Account Activity Replay API](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#account-activity-replay-api)，以确保当某个系统发生故障时不会错过任何活动。
 

**使用 Account Activity API 需要什么身份验证？**

Account Activity API 所需的授权方式在[API 参考页面](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#account-activity-api-reference-index)的各个方法中均有说明。如果你刚开始接触 X 身份验证，建议阅读[此部分](/zh/resources/fundamentals/authentication)。

**什么是质询-响应校验（CRC）？**

Account Activity API 的质询响应检查是一项安全功能，用于确保 Account Activity API 的活动被发送给正确的开发者。它也可供开发者用来确认所接收的数据确实来自 X。自上次验证 webhook URL 起，X 将每 24 小时自动向你的 webhook URL 发送一次 CRC。你的系统必须在 3 秒内返回有效响应，才能保持验证状态。

请访问我们的页面[保护 webhooks](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#securing-webhooks)以了解更多详情。

**有没有什么情况会立即使我的 webhook URL 失效？**

如果发生以下任一情况，我们会立即将你的 webhook 标记为无效：

- 服务器对 CRC 的响应包含错误的令牌。在这种情况下，我们的系统不会[重试](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#retries)向你发送活动。
- webhook URL 配置了错误的证书。在这种情况下，我们的系统不会[重试](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#retries)向你发送活动。
- 你的服务器返回了非 2XX、非 4XX、非 5XX 的响应代码。
- 你声明使用 gzip，但实际并未发送。
- 你未声明使用 gzip，却在响应中实际发送了它。

**如果订阅了彼此互动的用户，我会收到重复的活动吗？**

会的。若你的 web 应用对用户 A 和用户 B 均有有效订阅，且用户 A 在帖子中提及用户 B，则会向注册的 webhook 发送两条 POST 活动。每条活动都会包含一个“for\_user\_id”指示器，显示该活动属于哪个订阅。

**当我向我的 webhook 发起订阅时，是否可以将以下端点中的 `/all/` 部分替换为其他账户活动数据对象，以限制 API 交付的活动？**`POST https://api.x.com/1.1/account_activity/all/:env_name/subscriptions.json`

不可以。目前我们只提供 `/all/` 产品。

**是否有办法在不向用户请求私信权限的情况下使用 Account Activity API？**

目前需要私信权限，因为对此 API 无法“过滤掉”私信活动。

**Account Activity API 有免费版本吗？**

有的，我们提供沙盒版本作为免费层。我们的沙盒选项限制为单个 webhook，最多 15 个订阅。你可以在[我们的文档](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity)中了解更多关于沙盒选项的内容。

**能否使用 Account Activity API 获取提及已订阅用户的帖子转发？**

很遗憾，这不在本 API 交付的活动范围内。为此，我们建议使用 Streaming API。

**tweet\_create\_event 代表的可能活动类型有哪些？**

在以下情况下会发送 tweet\_create\_event 负载：

如果订阅用户执行了以下任一操作：

- 创建帖子
- 转发
- 回复帖子

如果其他用户：

- @提及\*订阅用户
- 引用订阅用户创建的推文

_注意：Account Activity API 仅在订阅用户会从 X 收到通知且能够公开看到该事件时才会投递事件。这意味着，如果被提及的账户（@userA）关注了受保护的账户（@userB），则 UserA 会收到 UserB 提及他们的通知。如果 UserA 未关注（且未被 @userB 批准）UserB，UserA 将不会收到通知，因此即使 @userA 已订阅，AAA 也不会发送 tweet\_create\_event。_

**如果被我订阅的用户被某个已拉黑的用户提及，我如何识别这种情况？**

你会在 JSON 响应的顶层看到一个布尔字段 `user_has_blocked`，其值为“true”或“false”。该字段只会在帖子提及中暴露。

企业版

**如何将我的应用添加到允许名单，或检查我的应用是否已在允许名单中？**

若要管理你已加入允许列表、可通过企业 API 访问的[X apps](/zh/resources/fundamentals/developer-apps)，请联系你的客户经理并提供你的 app ID。你可以在[开发者门户](/zh/resources/fundamentals/developer-portal)的["Apps"](/zh/resources/fundamentals/developer-apps)页面找到你的 app ID。
 

**如果我有三个 webhook 的访问权限，是否可以为我注册为企业用途的每个应用分别使用三个 webhook？**

webhook 限额设置在账户级别，而非应用级别。如果你有三个 webhook 的访问权限，并且有两个注册为企业用途的应用，你可以在一个应用上使用两个，在另一个应用上使用第三个，但不能在每个应用上都使用三个。 

**我可以指定使用 Account Activity Replay API 重新投递的事件类型吗？**

无法指定要重放的事件类型。将在指定的日期和时间窗口内曾投递的所有事件都会被重放。 

**如果我的应用未能接收并处理某个 Account Activity Replay API 事件，是否会有重试？**

不会，不会进行重试。如果应用未能摄取由 Account Activity Replay API 发送的事件，可以为相同的时间段提交另一个 Replay 作业，以尝试重新投递任何错过的 Replay 事件。 

**当我收到“部分成功”的完成事件时应该怎么做？**

建议记录已接收事件的时间戳，并为遗漏的事件再次请求一个 Replay 作业。 

**我一次可以同时运行多少个 Account Activity Replay API 作业？**

每个 webhook 在同一时间只能运行一个 Account Activity Replay API 作业。 

**当事件被投递到我的 webhook 时，我如何区分 Account Activity Replay API 事件与实时生产事件？**

由于 Account Activity Replay API 始终投递过去的事件，可根据事件的时间戳将其与实时生产事件区分开来。 

**我最早何时可以开始使用 Account Activity Replay API 来重新投递我的应用丢失或错过的活动？**

活动在创建后约 10 分钟即可用于重新投递。 

<div id="general">
  ### 错误故障排查指南
</div>

#### 代码 32

此错误通常表示你的请求、请求头（headers）、授权信息或所指定的 URL 存在格式问题。这不是 Account Activity API 的错误，而是授权错误；X 未收到正确的 OAuth 设置或 URL。

- **Enterprise** - 请确保你使用的 consumer key 和 access token 属于已注册用于 Enterprise 产品的[X 应用](/zh/resources/fundamentals/developer-apps)。如果你没有 consumer key 和 access token，或需要将你的 X 应用加入允许列表，请联系你的客户经理。 

- 如以用户上下文进行认证，请确保你已使用正确的 `oauth_nonce`、`oauth_signature` 和 `oauth_timestamp`[为请求授权](/zh/resources/fundamentals/authentication#authorizing-a-request)。

- 确保你的 access token 具备正确的权限级别。
  - 在 [应用控制台](/zh/resources/fundamentals/developer-apps)的“Keys and tokens”选项卡中，确保你的 access token 拥有“Read, write, and direct messages”[权限级别](/zh/resources/fundamentals/developer-apps#app-permissions)。 
  - 如果 token 的权限级别低于此，请前往“Permissions”选项卡，将访问权限调整为“Read, write, and direct messages”，然后在“Keys and tokens”选项卡中重新生成你的 access token 和 secret。

- 确保你的 URL 格式正确。
  - 请注意，`:env_name` 区分大小写。
     

<div id="code-32">
  #### 代码 200 - 禁止访问
</div>

- **Premium** - 在尝试向 API 发起请求之前，请确保你拥有已获批准的[开发者账户](/zh/resources/fundamentals/developer-portal)。你还必须在请求中使用正确的 :env\_name，可在 [dev environments](/zh/resources/fundamentals/developer-portal) 页面进行设置。

- **Enterprise** - 请确认你的客户经理已为你开通 Account Activity API 的访问权限。

- 请确认你已正确配置 URI。若在请求中填写了错误的 URI，可能会触发此错误。
   

<div id="code-200-forbidden">
  #### 代码 214 - Webhook URL 不符合要求。
</div>

- 请确保您使用的是 https。
- 您的 webhook URL 可能格式不正确。
- 请在[Webhook 入门](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#getting-started-with-webhooks)页面的[开发 webhook 消费者应用](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#3-develop-webhook-consumer-app)部分了解如何设置您的 webhook URL。
   

<div id="code-214-webhook-url-does-not-meet-the-requirements">
  #### 代码 214 - CRC GET 请求延迟过高。你的 webhook 应在 3 秒内响应。
</div>

- 这表示你的服务器响应缓慢。请确保在 3 秒内对 CRC 做出响应。
   

<div id="code-214-high-latency-on-crc-get-request-your-webhook-should-respond-in-less-than-3-seconds">
  #### 代码 214 - CRC GET 请求期间返回非 200 的响应码（如 404、500 等）。
</div>

- 服务器可能已宕机。请确保服务器正在正常运行。
   

<div id="code-214-non-200-response-code-during-crc-get-request-ie-404-500-etc">
  #### 代码 214 - 已创建的资源过多。
</div>

- **企业版** - 你已用尽所有 webhook。请为你注册的每个应用调用 [GET webhooks](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks) 端点，以确定你的 webhook 分布位置。 

<div id="code-214-too-many-resources-already-created">
  #### 代码 261 - 应用无法执行写入操作。
</div>

- 您与 API 搭配使用的应用的访问令牌和访问令牌密钥未设置正确的[权限级别](/zh/resources/fundamentals/developer-apps#app-permissions)。请前往 [X apps](/zh/resources/fundamentals/developer-apps) 控制台的“Keys and tokens”选项卡，检查分配给您的访问令牌和访问令牌密钥的权限级别。若设置为“Read, write and Direct Messages”以外的任何选项，则需在“Permission”选项卡中调整设置，并重新生成访问令牌和访问令牌密钥以应用新设置。
- 或者，您正在尝试使用仅应用身份验证注册 webhook，这是不受支持的。请改为使用用户上下文进行身份验证，具体请参见在 [Enterprise Account Activity API](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks) 中注册 webhook 的 API 参考部分。

## 账户活动 API 参考索引

|     |     |
| :--- | :--- |
| **用途** | 企业版 |
| 注册 webhook URL / 生成 webhook\_id | [POST  <br />webhooks](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#enterprise-account-activity-api) |
| 返回所有 webhook URL 及其状态 | [GET  <br />webhooks](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks) |
| 手动触发挑战响应检查 | [PUT  <br />webhooks/:webhook\_id](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#put-account-activity-webhooks-webhook-id) |
| 将应用订阅到账户事件 | [POST  <br />webhooks/:webhook\_id/subscriptions/all](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks-webhook-id-subscriptions-all) |
| 返回当前活跃订阅数 | [GET  <br />subscriptions/count](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-subscriptions-count) |
| 检查某个 webhook 是否已订阅某账户 | [GET  <br />webhooks/:webhook\_id/subscriptions/all](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks-webhook-id-subscriptions-all) |
| 返回当前活跃订阅列表 | [GET  <br />webhooks/:webhook\_id/subscriptions/all/list](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-subscriptions-count) |
| 删除该 webhook | [DELETE  <br />webhooks/:webhook\_id](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id) |
| 通过三方 OAuth 停用订阅（已弃用） | [DELETE  <br />webhooks/:webhook\_id/subscriptions/all](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id-subscriptions-all-deprecated) |
| 通过仅应用 OAuth 停用订阅 | [DELETE  <br />webhooks/:webhook\_id/subscriptions/:user\_id/all.json](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id-subscriptions-user-id-all-json) |
| 重新投递活动到 webhook | [POST  <br />replay/webhooks/:webhook\_id/subscriptions/all](/zh/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id-subscriptions-all-deprecated) |

### 企业级 Account Activity API

#### POST account\_activity/webhooks[](#post-account-activity-webhooks "Permalink to this headline")

为指定的应用上下文注册新的 webhook URL。该 URL 在保存前将通过 CRC 请求进行验证。若验证失败，将向请求方返回详尽的错误信息。

可用的 webhook 数量由计费套餐决定。

### 资源 URL[](#resource-url "Permalink to this headline")

`https://api.x.com/1.1/account_activity/webhooks.json`

<div id="resource-url">
  ### 资源信息[](#resource-information "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| 响应格式 | JSON |
| 是否需要身份验证 | 是（用户上下文——所有消费者和访问令牌） |
| 是否有速率限制 | 是 |
| 每 15 分钟窗口的请求数（用户认证） | 15 |
| 对推文编辑的支持 | 所有推文对象都会包含描述其编辑历史的推文编辑元数据。详见“推文编辑”基础知识页面：["Tweet edits"](/zh/x-api/enterprise-gnip-2.0/fundamentals/edit-tweets)。 |

<div id="resource-information">
  ### 参数[](#parameters "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| url（必填） | 回调端点的已编码 URL。 |

<div id="parameters">
  ### 示例请求[](#example-request "Permalink to this headline")
</div>

$ curl --request POST
\--url 'https://api.x.com/1.1/account\_activity/webhooks.json?url=https%3A%2F%2Fyour\_domain.com%2Fwebhooks%2Ftwitter%2F0'
\--header 'authorization: OAuth oauth\_consumer\_key="CONSUMER\_KEY", oauth\_nonce="GENERATED", oauth\_signature="GENERATED", oauth\_signature\_method="HMAC-SHA1", oauth\_timestamp="GENERATED", oauth\_token="ACCESS\_TOKEN", oauth\_version="1.0"'

<div id="example-request">
  ### HTTP 响应[](#http-responses "Permalink to this headline")
</div>

| HTTP 代码 | 信息 |
| :--- | :--- |
| 200 | Webhook URL 已为所提供的应用注册 |
| 403 | 请求有误。请参见下方的错误信息部分。 |

<div id="http-responses">
  ### 示例响应 - 成功[](#example-response-success "Permalink to this headline")
</div>

```json
_HTTP 200_

    {
      "id": "1234567890",
      "url": "https://your_domain.com/webhook/twitter/0",
      "valid": true,
      "created_at": "2016-06-02T23:54:02Z"
    }
```

<div id="example-response-success">
  ### 错误消息[](#error-messages "Permalink to this headline")
</div>

| Code | Message |
| :--- | :--- |
| 214 | Webhook URL 不符合要求。 |
| 214 | 已创建的资源过多。 |
| 214 | Webhook URL 不符合要求。CRC 令牌无效或 JSON 响应格式不正确。 |
| 214 | CRC GET 请求延迟过高。Webhook 应在 3 秒内响应。 |
| 214 | CRC GET 请求期间返回非 200 响应码（如 404、500 等）。 |

_HTTP 403_

```json
    {
      "errors": [
        {
          "code": 214,
          "message": "Too many resources already created."
        }
      ]
    }
```

#### GET account\_activity/webhooks[](#get-account-activity-webhooks "Permalink to this headline")

返回指定应用的所有 URL 及其状态。

如果某个 URL 未通过每日验证检查，我们会将其标记为无效。要重新启用该 URL，请调用更新端点。

### 资源 URL[](#resource-url "Permalink to this headline")

`https://api.x.com/1.1/account_activity/webhooks.json`

<div id="resource-url">
  ### 资源信息[](#resource-information "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| 响应格式 | JSON |
| 需要认证 | 是（仅应用 — Bearer 令牌） |
| 受速率限制 | 是 |
| 每 15 分钟窗口的请求数（应用认证） | 15 |

<div id="parameters">
  ### 示例请求[](#example-request "Permalink to this headline")
</div>

```bash
    $ curl --request GET
     --url https://api.x.com/1.1/account_activity/webhooks.json
     --header 'authorization: Bearer TOKEN'
```

<div id="example-request">
  ### 示例响应[](#example-response "Permalink to this headline")
</div>

_HTTP 200 OK_

```json
    [
      {
        "id": "1234567890",
        "url": "https://your_domain.com/webhook/twitter/0",
        "valid": true,
        "created_at": "2016-06-02T23:54:02Z"
      }
      {
        "id": "2468013579",
        "url": "https://your_domain2.com/webhook/twitter/0",
        "valid": true,
        "created_at": "2016-06-04T22:31:29Z"
      }
    ]
```

<div id="example-response-success">
  ### 错误消息[](#error-messages "Permalink to this headline")
</div>

| 代码 | 消息 |
| :--- | :--- |
| 99  | 您没有访问此资源的权限。 |

#### PUT account\_activity/webhooks/:webhook\_id[](#put-account-activity-webhooks-webhook-id "Permalink to this headline")

对指定 webhook 的 URL 触发挑战响应校验（CRC）。若校验成功，将返回 204，并通过将其状态设为 `valid` 来重新启用该 webhook。

### 资源 URL[](#resource-url "固定链接到此标题")

`https://api.x.com/1.1/account_activity/webhooks/:webhook_id.json`

<div id="resource-url">
  ### 资源信息[](#resource-information "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| 响应格式 | JSON |
| 是否需要认证 | 是（用户上下文——所有消费者和访问令牌） |
| 是否限流 | 是 |
| 每 15 分钟窗口的请求数（用户认证） | 15  |

<div id="resource-information">
  ### 参数[](#parameters "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| webhook\_id（必填） | Webhook ID，定义在资源路径中。 |

<div id="parameters">
  ### 示例请求[](#example-request "Permalink to this headline")
</div>

```json
    $ curl --request PUT
     --url https://api.x.com/1.1/account_activity/webhooks/:WEBHOOK_ID.json
     --header 'authorization: OAuth oauth_consumer_key="CONSUMER_KEY", oauth_nonce="GENERATED", oauth_signature="GENERATED", oauth_signature_method="HMAC-SHA1", oauth_timestamp="GENERATED", oauth_token="ACCESS_TOKEN", oauth_version="1.0"'
```

<div id="example-request">
  ### 响应[](#response "Permalink to this headline")
</div>

_HTTP 204 无内容_

```
    { }
```

<div id="response">
  ### 错误信息[](#error-messages "Permalink to this headline")
</div>

| 代码 | 信息 |
| :--- | :--- |
| 34  | Webhook 不存在，或与其他 X 应用关联。 |
| 214 | Webhook URL 不符合要求。 |
| 214 | Webhook URL 不符合要求。CRC 令牌无效或 JSON 响应格式不正确。 |
| 214 | CRC GET 请求延迟过高。你的 webhook 应在 3 秒内响应。 |
| 214 | CRC GET 请求期间返回非 200 响应码（例如 404、500 等）。 |

#### POST account\_activity/webhooks/:webhook\_id/subscriptions/all[](#post-account-activity-webhooks-webhook-id-subscriptions-all "跳转到此标题的永久链接")

将指定应用订阅到指定用户上下文下的所有消息类型的全部事件。激活后，针对该请求用户的所有事件都会通过 POST 请求发送到该应用的 webhook。

当前订阅受您的账户配置限制。如需增加订阅数量，请联系您的客户经理。

### 资源 URL[](#resource-url "Permalink to this headline")

`https://api.x.com/1.1/account_activity/webhooks/:webhook_id/subscriptions/all.json`

<div id="resource-url">
  ### 资源信息[](#resource-information "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| 响应格式 | JSON |
| 需要身份验证 | 是（3-legged OAuth——白名单中的消费者密钥与订阅用户的访问令牌） |
| 速率限制 | 是 |
| 请求数/每 15 分钟（用户授权） | 500 |

<div id="resource-information">
  ### 参数[](#parameters "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| webhook\_id（必填） | Webhook ID，定义在资源路径中。 |

### 示例请求[](#example-request "此标题的永久链接")

```bash
    $ curl --request POST
     --url https://api.x.com/1.1/account_activity/webhooks/:WEBHOOK_ID/subscriptions/all.json
     --header 'authorization: OAuth oauth_consumer_key="WHITELISTED_CONSUMER_KEY", oauth_nonce="GENERATED", oauth_signature="GENERATED", oauth_signature_method="HMAC-SHA1", oauth_timestamp="GENERATED", oauth_token="SUBSCRIBING_USER'S_ACCESS_TOKEN", oauth_version="1.0"'
```

<div id="http-responses">
  ### 示例响应 - 成功[](#example-response-success "Permalink to this headline")
</div>

_HTTP 204 No Content_

```
    {}
```

<div id="example-response-success">
  ### 错误消息[](#error-messages "Permalink to this headline")
</div>

| 代码 | 消息 |
| :--- | :--- |
| 34  | Webhook 不存在，或与其他 X 应用程序关联。 |
| 348 | 客户端应用程序无权访问该用户的 Webhook 订阅。 |

#### GET account\_activity/subscriptions/count[](#get-account-activity-subscriptions-count "Permalink to this headline")

返回你帐户当前处于激活状态的订阅数量。请注意，/count 端点仅支持应用级 OAuth，因此应使用 Bearer 令牌发起请求，而非使用用户上下文。

### 资源 URL[](#resource-url "Permalink to this headline")

`https://api.x.com/1.1/account_activity/subscriptions/count.json`

<div id="resource-url">
  ### 资源信息[](#resource-information "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| 响应格式 | HTTP 响应代码 |
| 是否需要认证 | 是（仅应用—持有者令牌） |
| 是否受速率限制 | 是 |
| 每 15 分钟窗口的请求数（应用认证） | 15 |

<div id="resource-information">
  ### HTTP 响应代码[](#http-response-codes "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| 代码 | 消息 |
| 200 | 成功。将返回所请求 webhook 的订阅数量。 |
| 401 | 您的应用无权查看指定 webhook 的订阅。 |

<div id="parameters">
  ### 示例请求[](#example-request "Permalink to this headline")
</div>

```bash
    $ curl --request GET
     --url https://api.x.com/1.1/account_activity/subscriptions/count.json
     --header 'authorization: Bearer TOKEN'
```

<div id="http-responses">
  ### 示例响应 - 成功[](#example-response-success "Permalink to this headline")
</div>

_HTTP 200_

```bash
    {
      "account_name":"my-account",
      "subscriptions_count_all":"1",
      "subscriptions_count_direct_messages":"0",
      "provisioned_count":"50"
    }
```

<div id="response">
  ### 错误信息[](#error-messages "Permalink to this headline")
</div>

| 代码 | 信息 |
| :--- | :--- |
| 32  | 无法通过身份验证。 |

_HTTP 401_

```abash
    {
      "errors": [
        {
           "code": 32,
          "message": "Could not authenticate you."
        }
      ]
    }
```

#### GET account\_activity/webhooks/:webhook\_id/subscriptions/all[](#get-account-activity-webhooks-webhook-id-subscriptions-all "Permalink to this headline")

用于判断某个 webhook 配置是否已订阅指定用户的事件。若所提供的用户上下文在所提供的应用中存在活跃订阅，则返回 204 OK。若响应码不是 204，则该用户没有活跃订阅。详情参见下方的 HTTP 响应代码与错误信息。

### 资源 URL[](#resource-url "Permalink to this headline")

`https://api.x.com/1.1/account_activity/webhooks/:webhook_id/subscriptions/all.json`

<div id="resource-url">
  ### 资源信息[](#resource-information "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| 响应格式 | JSON |
| 需要身份验证 | 是（3-legged OAuth——白名单中的消费者密钥与订阅用户的访问令牌） |
| 速率限制 | 是 |
| 请求数/每 15 分钟（用户授权） | 500 |

<div id="resource-information">
  ### 参数[](#parameters "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| webhook\_id（必填） | Webhook ID，定义在资源路径中。 |

<div id="parameters">
  ### 示例请求[](#example-request "Permalink to this headline")
</div>

$ curl --request GET
\--url https://api.x.com/1.1/account\_activity/webhooks/:WEBHOOK\_ID/subscriptions/all.json
\--header 'authorization: OAuth oauth\_consumer\_key="WHITELISTED\_CONSUMER\_KEY", oauth\_nonce="GENERATED", oauth\_signature="GENERATED", oauth\_signature\_method="HMAC-SHA1", oauth\_timestamp="GENERATED", oauth\_token="SUBSCRIBING\_USER\_ACCESS\_TOKEN", oauth\_version="1.0"'

<div id="http-responses">
  ### 示例响应 - 成功[](#example-response-success "Permalink to this headline")
</div>

_HTTP 204 无内容_

```
    { }
```

#### GET account\_activity/webhooks/:webhook\_id/subscriptions/all/list[](#get-account-activity-webhooks-webhook-id-subscriptions-all-list "Permalink to this headline")

返回指定 webhook 的当前“全部活动”类型订阅列表。请注意，/list 端点要求使用“仅限应用”的 OAuth，因此应使用持有者令牌（bearer token）而非用户上下文来发起请求。

### 资源 URL[](#resource-url "Permalink to this headline")

`https://api.x.com/1.1/account_activity/webhooks/:webhook_id/subscriptions/all/list.json`

<div id="resource-url">
  ### 资源信息[](#resource-information "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| 响应格式 | HTTP 状态码 |
| 需要身份验证 | 是（仅限应用 — Bearer Token） |
| 受速率限制 | 是 |
| 每 15 分钟窗口的请求数（应用鉴权） | 50  |

<div id="resource-information">
  ### 参数[](#parameters "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| webhook\_id（必填） | Webhook ID，定义在资源路径中。 |

<div id="resource-information">
  ### HTTP 响应代码[](#http-response-codes "Permalink to this headline")
</div>

| 代码 | 消息 |
| :--- | :--- |
| 200 | 成功。将返回所请求 webhook 的订阅列表。 |
| 401 | 您的应用无权查看指定 webhook 的订阅。 |

<div id="parameters">
  ### 示例请求[](#example-request "Permalink to this headline")
</div>

$ curl --request GET
\--url https://api.x.com/1.1/account\_activity/webhooks/:WEBHOOK\_ID/subscriptions/all/list.json
\--header 'authorization: Bearer TOKEN'

<div id="http-responses">
  ### 示例响应 - 成功[](#example-response-success "Permalink to this headline")
</div>

_HTTP 200_

```bash
    {
      "webhook_id": "1234567890",
      "webhook_url": "https://your_domain.com/webhook/twitter/0",
      "application_id": "11231812",
      "subscriptions": [{
        "user_id": "20212306"
      }]
    }
```

<div id="response">
  ### 错误信息[](#error-messages "Permalink to this headline")
</div>

| 代码 | 信息 |
| :--- | :--- |
| 32  | 无法验证您的身份。 |

_HTTP 401_

```bash
    {
      "errors": [
        {
           "code": 32,
          "message": "Could not authenticate you."
        }
      ]
    }
```

#### DELETE account\_activity/webhooks/:webhook\_id[](#delete-account-activity-webhooks-webhook-id "Permalink to this headline")

从所提供的应用配置中移除该 webhook。可通过调用 GET /1.1/account\_activity/webhooks 获取 webhook ID。

### 资源 URL[](#resource-url "固定链接到此标题")

`https://api.x.com/1.1/account_activity/webhooks/:webhook_id.json`

<div id="resource-url">
  ### 资源信息[](#resource-information "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| 响应格式 | JSON |
| 是否需要认证 | 是（用户上下文——所有消费者和访问令牌） |
| 是否限流 | 是 |
| 每 15 分钟窗口的请求数（用户认证） | 15  |

<div id="resource-information">
  ### 参数[](#parameters "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| webhook\_id（必填） | Webhook ID，定义在资源路径中。 |

<div id="parameters">
  ### 示例请求[](#example-request "Permalink to this headline")
</div>

```bash
    $ curl --request DELETE
     --url https://api.x.com/1.1/account_activity/webhooks/:WEBHOOK_ID.json
     --header 'authorization: OAuth oauth_consumer_key="CONSUMER_KEY", oauth_nonce="GENERATED", oauth_signature="GENERATED", oauth_signature_method="HMAC-SHA1", oauth_timestamp="GENERATED", oauth_token="ACCESS_TOKEN", oauth_version="1.0"'
```

<div id="example-request">
  ### 响应[](#response "Permalink to this headline")
</div>

_HTTP 204 无内容_

```
    { }
```

#### DELETE account\_activity/webhooks/:webhook\_id/subscriptions/all（已弃用）[](#delete-account-activity-webhooks-webhook-id-subscriptions-all-deprecated- "Permalink to this headline")

为给定的用户上下文和应用停用订阅。停用后，针对该请求用户的所有事件将不再发送到该 webhook URL。

### 资源 URL[](#resource-url "Permalink to this headline")

`https://api.x.com/1.1/account_activity/webhooks/:webhook_id/subscriptions/all.json`

<div id="resource-url">
  ### 资源信息[](#resource-information "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| 响应格式 | JSON |
| 需要身份验证 | 是（3-legged OAuth - 已列入白名单的 consumer key 与已订阅用户的 access token） |
| 受速率限制 | 是 |
| 每 15 分钟窗口的请求数（用户授权） | 500 |

<div id="resource-information">
  ### 参数[](#parameters "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| webhook\_id（必填） | Webhook ID，定义在资源路径中。 |

<div id="parameters">
  ### 示例请求[](#example-request "Permalink to this headline")
</div>

```bash
    $ curl --request DELETE
     --url https://api.x.com/1.1/account_activity/webhooks/:WEBHOOK_ID/subscriptions/all.json
     --header 'authorization: OAuth oauth_consumer_key="WHITELISTED_CONSUMER_KEY", oauth_nonce="GENERATED", oauth_signature="GENERATED", oauth_signature_method="HMAC-SHA1", oauth_timestamp="GENERATED", oauth_token="SUBSCRIBED_USER'S_ACCESS_TOKEN", oauth_version="1.0"'
```

示例请求

```
    { }
```

#### DELETE /account\_activity/webhooks/:webhook\_id/subscriptions/:user\_id/all.json[](#delete-account-activity-webhooks-webhook-id-subscriptions-user-id-all-json "Permalink to this headline")

为指定的 webhook 和用户 ID 停用订阅。停用后，将不再把该请求方用户的所有事件发送到该 webhook 的 URL。注意：此端点要求使用仅应用程序 OAuth，因此请求应使用 Bearer 令牌，而非以用户上下文发起。

### 资源 URL[](#resource-url "Permalink to this headline")

`https://api.x.com/1.1/account_activity/webhooks/:webhook_id/subscriptions/:user_id/all.json`

<div id="resource-url">
  ### 资源信息[](#resource-information "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| 响应格式 | JSON |
| 需要身份验证 | 是（仅应用程序——持有者令牌） |
| 有速率限制 | 是 |
| 每 15 分钟窗口的请求数 | 500 |

<div id="parameters">
  ### 示例请求[](#example-request "Permalink to this headline")
</div>

```bash
    $ curl --request DELETE
     --url https://api.x.com/1.1/account_activity/webhooks/:webhook_id/subscriptions/:user_id/all.json
     --header 'authorization: Bearer TOKEN'
```

<div id="example-request">
  ### 响应[](#response "Permalink to this headline")
</div>

_HTTP 204 无内容_

<div id="response">
  ### 错误信息[](#error-messages "Permalink to this headline")
</div>

| 代码 | 信息 |
| :--- | :--- |
| 404 | 抱歉，该页面不存在。- 通常是因为指定的用户 ID 并未订阅。 |

<div id="error-messages">
  ### 回放 API
</div>

**POST /1.1/account\_activity/replay/webhooks/:webhook\_id/subscriptions/all.json [¶](#post-1-1-account-activity-replay-webhooks-webhook-id-subscriptions-all-json- "Permalink to this headline")**

提交请求，以从请求中指定的日期与时间窗口内，检索过去最多五天内所有订阅中的活动。如果你的 webhook 有活跃的用户订阅，你也会同时实时收到这些事件。注意：在投递回放事件之前，我们会执行 CRC。

|     |     |
| :--- | :--- |
| **请求方法** | HTTP POST |
| **URL** | /1.1/account\_activity/replay/webhooks/:webhook\_id/subscriptions/all.json?from\_date=yyyymmddhhmm\&to\_date=yyyymmddhhmm |
| **响应格式** | JSON |
| **需要身份验证** | 是（仅应用程序 — bearer token） |
| **速率限制** | 每 15 分钟 5 次请求。目前对可请求的回放作业数量没有上限。 |
| **from\_date** | 事件提供的最早（起始）UTC 时间戳，必须为“yyyymmddhhmm”格式。时间戳粒度为分钟，且为包含（例如 12:00 包含第 00 分钟）。有效时间必须在过去 5 天内（UTC），且不得晚于当前时间点前 31 分钟。建议 from\_date 与 to\_date 相差在约 2 小时以内。 |
| **to\_date** | 事件提供的最晚（结束）UTC 时间戳，必须为“yyyymmddhhmm”格式。时间戳粒度为分钟，且为不包含（例如 12:30 不包含该小时的第 30 分钟）。有效时间必须在过去 5 天内（UTC），且不得晚于当前时间点前 10 分钟。 |

#### 响应

API 可能返回以下响应。大多数错误代码会在正文中附带包含更多细节的字符串。对于非 200 响应，你应当先解决错误然后重试。

| 状态 | 文本 | 错误代码 | 描述 | 消息 |
| :--- | :--- | :--- | :--- | :--- |
| 202 | Accepted | N/A | 请求成功，相关活动将被发送。 | N/A |
| 400 | Bad Request | 214 | Webhook 已被标记为无效。 | Webhook 被标记为无效，需要进行 CRC 检查。 |
| 400 | Bad Request | 357 | 缺少查询参数。 | : 需要提供 queryParam。 |
| 400 | Bad Request | 358 | 路由或查询参数格式错误。 | 无法解析参数。 |
| 400 | Bad Request | 360 | 路由参数为负数。 | webhook\_id: \[] 必须大于或等于 0。 |
| 400 | Bad Request | 368 | from\_date 或 to\_date 不是过去的时间。 | : \[\<field\_value>] 不是过去的时间。 |
| 400 | Bad Request | 356 | from\_date 必须早于 to\_date。 | from\_date 必须早于 to\_date。 |
| 400 | Bad Request | 356 | from\_date 必须在过去 5 天内。 | from\_date 必须在过去 5 天内。 |
| 401 | Unauthorized | 32  | 提供了三方授权导致 HTTP 认证失败。 | 无效的认证方式。请使用仅限应用的认证。 |
| 401 | Unauthorized | 61  | 客户端无权请求此方法。 | 客户端无权请求此方法。 |
| 403 | Forbidden | 200 | 客户端没有启用 Replay 的企业账户。 | 需要启用 replay 的 Account Activity API 企业账户。请确认你拥有企业账户并已启用 replay。 |
| 404 | Not Found | 34  | webhook\_id 不存在；webhook\_id 与 application\_id 不匹配。 | Webhook 不存在或与其他 X 应用关联。 |
| 409 | Conflict | 355 | 有一个请求正在进行，需等待其处理完成后才能发起另一个。 | 此 webhook 已有一个重放作业在进行中。 |
| 429 | Too Many Requests | 88  | 速率受限（达到每个时间段的请求数量上限）。 | 请求过多。请降低 API 请求速率。 |
| 500 | Internal Server Error | 0   | 内部服务器错误。 | 内部服务器错误。 |
| 503 | Service Unavailable | 67  | X 的一个或多个依赖服务不可用。 | X 服务器错误。请使用指数退避策略重试。 |

<div id="responses">
  #### “作业已成功完成”消息
</div>

当作业成功完成后，Account Activity Replay API 会发送如下作业完成事件。收到该事件即表示作业已结束运行，可以提交新的作业。

```json
{
  "replay\_job\_status": {
    "webhook_id": "1234577122340233217",
    "job_state": "Complete",
    "job\_state\_description": "Job completed successfully"
    "job_id": "1095098195724558337"
  }
}
```

<div id="job-completed-successfully-message">
  #### “作业未完成”消息
</div>

如果您的作业未能成功完成，我们将返回以下消息，提示您重试 Replay 作业。收到此事件后，表示该作业已运行结束，您可以提交另一个作业。

```json
{
  "replay\_job\_status": {
    "webhook_id": "123451374207332352",
    "job_state": "Incomplete",
    "job\_state\_description": "Job failed to deliver all events, please retry your replay job",
    "job_id": "1093226942650736640"
  }
}
```

<div id="job-failed-to-complete-message">
  #### curl 请求示例
</div>

```bash
    curl --request POST  --url 'https://api.x.com/1.1/account_activity/replay/webhooks/:webhook_id/subscriptions/all.json?from_date=yyyymmddhhmm&to_date=yyyymmddhhmm'
    --header 'authorization: Bearer TOKEN'
```

<div id="example-curl-request">
  #### 示例响应
</div>

HTTP 202

```bash
{
  "job_id": "1234567890",
  "created_at": "2016-06-02T23:54:02Z"
}
```