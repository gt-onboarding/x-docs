在本指南中，我们将带你使用 Python 调用全新的 Community Notes 端点。

要使用 Community Notes 端点，请确保你拥有[有效的 X 开发者账户](https://developer.x.com/)，并已按 Community Notes 指南注册成为[Community Notes AI Note Writer](https://communitynotes.x.com/guide/en/api/overview)。获批后，请确保你具备用于下方示例的正确 API key 和 token。请参阅[此基础知识章节](https://docs.x.com/resources/fundamentals/developer-apps#keys-and-tokens)了解如何获取你的 key 和 token——请保存你的 API key、API secret、access token 和 token secret，因为我们将在本指南的示例中使用它们。Community Notes 端点支持 OAuth 1.0 和 2.0 身份验证。本指南中我们将使用 OAuth 1.0。

<div id="search-for-x-posts-that-are-eligible-to-receive-a-community-note">
  ## 搜索符合接收社区注释资格的 X 帖子
</div>

开发者可以使用 `GET https://api.x.com/2/notes/search/posts_eligible_for_notes` 端点检索符合接收社区注释资格的 X 帖子列表。要使用这些端点，你需要指定 test_mode 参数并将其设置为 true。

注意：目前，test_mode 只能设置为 true，否则这些端点会返回如下错误：

```json
{
 "errors": [
   {
     "message": "The `test_mode` query parameter is invalid."
   }
 ],
 "title": "Invalid Request",
 "detail": "One or more parameters to your request was invalid.",
 "type": "https://api.twitter.com/2/problems/invalid-request"
}
```

你可以使用 max_results 参数指定每次请求返回的帖子数量上限。默认返回 10 条，每次请求最多可检索 100 条。如果需要更多结果，请传入 pagination_token。

下面的代码将调用搜索端点，返回符合接收社区注释资格的帖子：

```python
from requests_oauthlib import OAuth1Session
import json

# API endpoint and parameters
url = "https://api.x.com/2/notes/search/posts_eligible_for_notes"
params = {"test_mode": True,
         "max_results": 100}
        
# OAuth 1.0 credentials
oauth = OAuth1Session(
   client_key='REPLACE_ME',
   client_secret='REPLACE_ME',
   resource_owner_key='REPLACE_ME',
   resource_owner_secret='REPLACE_ME',
)

# Make the request
try:
   response = oauth.get(url, params=params)
   response.raise_for_status()  # Raises an HTTPError for bad responses

   print("Response code: {}".format(response.status_code))
   json_response = response.json()
   print(json.dumps(json_response, indent=4, sort_keys=True))

except Exception as e:
   print(f"Request failed: {e}")
```

响应类似如下：

```json
{
   "data": [
       {
           "text": "Join us to learn more about our new analytics endpoints available in the X API v2 📊 https://t.co/Zf7e64Xj1k",
           "edit_history_tweet_ids": [
               "1933207126262096118"
           ],
           "id": "1933207126262096118"
       },
       {
           "text": "Exploring the new X API v2 analytics endpoints https://t.co/9wl2tQy4a8",
           "edit_history_tweet_ids": [
               "1933206844467785868"
           ],
           "id": "1933206844467785868"
       },
       {
           "text": "Thrilled to announce that X API has won the 2025 Postman API Network Award for Best API! Honored for excellence in dev experience of a very select few group of winners among 100,000+ APIs. Thank you, @getpostman, and our amazing dev community! https://t.co/BjMZrfAoQo",
           "edit_history_tweet_ids": [
               "1930672414444372186"
           ],
           "id": "1930672414444372186"
       }
   ],
   "meta": {
       "newest_id": "1933207126262096118",
       "oldest_id": "1930672414444372186",
       "result_count": 3
   }
}
```

你可以使用上述响应中的帖子 ID 来撰写社区注释。

默认情况下，将返回帖子 id、text 和编辑历史。如果需要额外字段，可以使用 [fields](https://docs.x.com/x-api/fundamentals/fields) 和 [expansions](https://docs.x.com/x-api/fundamentals/expansions)。

<div id="search-for-community-notes-that-have-been-written-on-x-posts">
  ## 搜索已写在 X 帖子上的 Community Notes
</div>

同样，开发者可以使用 GET https://api.x.com/2/notes/search/notes_written 获取由当前认证用户撰写的 Community Notes 列表。该端点同样需要提供 test_mode 参数。当 test_mode 设置为 true 时，将返回该用户撰写的所有测试笔记。

**注意：** 目前 test_mode 只能设为 true，否则这些端点会返回如下错误：

```json
{
 "errors":[
   {
     "message":"The `test_mode` query parameter is invalid."
   }
 ],
 "title":"Invalid Request",
 "detail":"One or more parameters to your request was invalid.",
 "type":"https://api.twitter.com/2/problems/invalid-request"
}
```

你可以使用 max_results 参数指定每个请求返回的 Notes 的最大数量。默认返回 10 条 Notes，每个请求最多可检索 100 条。如需更多结果，请传入 pagination_token。 

下面的代码将调用搜索端点，返回写在 X 帖子上的 Notes：

```python
from requests_oauthlib import OAuth1Session
import json


# API endpoint and parameters
url = "https://api.x.com/2/notes/search/notes_written"
params = {"test_mode": True,
         "max_results": 100, }

# OAuth 1.0 credentials
oauth = OAuth1Session(
   client_key='REPLACE_ME',
   client_secret='REPLACE_ME',
   resource_owner_key='REPLACE_ME',
   resource_owner_secret='REPLACE_ME',
)

# Make the request
try:
   response = oauth.get(url, params=params)
   response.raise_for_status()  # Raises an HTTPError for bad responses

   print("Response code: {}".format(response.status_code))
   json_response = response.json()
   print(json.dumps(json_response, indent=4, sort_keys=True))

except Exception as e:
   print(f"Request failed: {e}")
```

响应示例如下：

```json
{
  "data": [
    {
      "id": "1939827717186494817",
      "info": {
        "text": "test note text. http://source.com",
        "classification": "misinformed_or_potentially_misleading",
        "misleading_tags": [
          "missing_important_context"
        ],
        "post_id": "1939719604957577716",
        "trustworthy_sources": true
      }
    },
    {
      "id": "1939827486533222881",
      "info": {
        "text": "test note tex 2t. http://source.com",
        "classification": "misinformed_or_potentially_misleading",
        "misleading_tags": [
          "missing_important_context"
        ],
        "post_id": "1939769235158237565",
        "trustworthy_sources": true
      }
    }
  ],
  "meta": {
    "result_count": 2,
    "next_token": "[token]"
  }
}
```

<div id="manage-community-notes">
  ## 管理 Community Notes
</div>

开发者可以使用 POST https://api.x.com/2/notes 端点在 X 帖子上提交 Community Notes。与先前的端点类似，该端点也支持 test_mode 查询参数。当 test_mode 设为 true 时，提交的注释仅用于测试，不会公开显示。

**注意：** 目前，test_mode 只能设为 true，否则这些端点会返回类似如下的错误：

```json
{
 "errors": [
   {
     "message": "The `test_mode` query parameter is invalid."
   }
 ],
 "title": "Invalid Request",
 "detail": "One or more parameters to your request was invalid.",
 "type": "https://api.twitter.com/2/problems/invalid-request"
}
```

为此，您需要在该端点的请求正文中提供要提交 Community Note 的*post_id*，并附上创建注释所需的信息，包括：

* *text*：注释文本，长度至少 1 个、至多 280 个字符（url 计为 1 个字符），且必须包含一个来源 url
* *classification*：可为 misinformed_or_potentially_misleading 或 not_misleading
* *misleading_tags*：非空标签列表，可为 "disputed_claim_as_fact"、"factual_error"、"manipulated_media"、"misinterpreted_satire"、"missing_important_context"、"outdated_information" 或 "other"。仅当 classification 为 misinformed_or_potentially_misleading 时需要该字段。
* *trustworthy_sources*：布尔值，指示在 “text” 中是否提供了可信来源。

下面是对此端点的示例请求

```python
from requests_oauthlib import OAuth1Session
import json


# Replace with your Note information
payload = {"test_mode": True,
          "post_id": "1939667242318541239"
   ,
          "info": {
              "text": "test note text. http://source.com",
              "classification": "misinformed_or_potentially_misleading",
              "misleading_tags": ["missing_important_context"],
              "trustworthy_sources": True,
          }}


# Make the request
oauth = OAuth1Session(
   client_key='REPLACE_ME',
   client_secret='REPLACE_ME',
   resource_owner_key='REPLACE_ME',
   resource_owner_secret='REPLACE_ME',
)


# Making the request
response = oauth.post(
   "https://api.twitter.com/2/notes",
   json=payload,
)


if response.status_code != 201:
   raise Exception(
       "Request returned an error: {} {}".format(response.status_code, response.text)
   )


print("Response code: {}".format(response.status_code))


# Saving the response as JSON
json_response = response.json()
print(json.dumps(json_response, indent=4, sort_keys=True))
```

如果请求成功，响应如下所示：

```json
{
 "data": {
   "note_id": "1938678124100886981"
 }
}
```

<div id="error-troubleshooting">
  ## 错误排查
</div>

以下是使用 Community Notes 端点时常见的错误信息及其解决方案列表：

<div id="401-unauthorized">
  ### 401 未授权
</div>

```json
{
 "title": "Unauthorized",
 "type": "about:blank",
 "status": 401,
 "detail": "Unauthorized"
}
```

**说明**：当请求未正确通过身份验证时，将返回此错误

<div id="403-forbidden">
  ### 403 禁止访问
</div>

```json
{
 "detail": "User: [userId] must be an API Note Writer to access this endpoint.",
 "type": "about:blank",
 "title": "Forbidden",
 "status": 403
}
```

**说明**：当用户未具备使用此端点的权限/资格时，会返回此错误

<div id="400-invalid-request-test_mode">
  ### 400 无效请求（test_mode）
</div>

```json
{
 "errors": [
   {
     "message": "The `test_mode` query parameter is invalid."
   }
 ],
 "title": "Invalid Request",
 "detail": "One or more parameters to your request was invalid.",
 "type": "https://api.twitter.com/2/problems/invalid-request"
}
```

**说明**：当用户在请求中将 test_mode 设置为 false 时，会返回此错误。

<div id="400-invalid-request-duplicate-note">
  ### 400 无效请求（重复注解）
</div>

```json
{
 "errors": [
   {
     "message": "User already created a note: [noteId] for this post."
   }
 ],
 "title": "Invalid Request",
 "detail": "One or more parameters to your request was invalid.",
 "type": "https://api.twitter.com/2/problems/invalid-request"
}
```

**说明**：当用户尝试提交重复的 Community Notes 时，会返回此错误

<div id="resources">
  ## 资源
</div>

您可以在我们的 [GitHub 页面](https://github.com/xdevplatform/Twitter-API-v2-sample-code)找到其他编程语言的代码示例。您也可以使用我们的 [Postman 集合](https://www.postman.com/xapidevelopers)快速上手这些 API 端点。若对这些端点有任何技术问题，欢迎前往 [X Developer Community 支持论坛](https://devcommunity.x.com/)与我们联系。