---
title: 处理流式数据
sidebarTitle: 处理流式数据
---

<div id="building-a-client-to-consume-streaming-data">
  ### 构建用于处理流式数据的客户端
</div>

在使用流式端点时，为了优化整体效果，有一些通用的最佳实践需要考虑。  
 

<div id="client-design">
  #### 客户端设计
</div>

当使用过滤流端点构建解决方案时，您需要一个客户端能够完成以下操作：

1. 与过滤流端点建立 HTTPS 流式连接。
2. 异步向过滤流规则端点发送 POST 请求，以在流中添加或删除规则。
3. 处理低数据量——维持流式连接，识别 Post 对象和保活信号。
4. 处理高数据量——使用异步流程将流数据摄取与后续处理解耦，并确保客户端缓冲区定期刷新。
5. 在客户端侧跟踪并管理数据量消耗。
6. 检测流断开，评估并自动重连。
    

<div id="connecting-to-a-streaming-endpoint">
  #### 连接到流式端点
</div>

连接到 X API v2 的流式端点，实质上是发起一个长时连接的 HTTP 请求，并对返回的数据进行增量解析。概念上，你可以将其理解为通过 HTTP 下载一个“无限长”的文件。连接建立后，只要连接保持打开，X 服务器就会通过该连接持续推送帖子事件。
 

<div id="consuming-data">
  #### 消费数据
</div>

请注意，JSON 对象的各字段无固定顺序，且在不同情形下并非所有字段都会出现。同样，独立的活动不会按排序顺序传送，且可能遇到重复消息。请记住，随着时间推移，新的消息类型可能会被添加并通过流发送。

因此，你的客户端必须能够容忍：

- 字段以任意顺序出现
- 意外出现或缺失的字段
- 未排序的帖子
- 重复消息
- 任意时间经由流传入的新的任意消息类型

除相关的帖子数据和所请求的字段参数外，通过流连接还可能传送以下类型的消息。请注意，此列表可能并不完整——流中可能会引入其他对象。请确保你的解析器能够容忍意外的消息格式。
 

<div id="buffering">
  #### 缓冲
</div>

流式端点会在数据一旦可用时立即向你发送，这在许多情况下会导致高数据量。如果 X 服务器无法立刻将新数据写入流（例如你的客户端读取不够快，详见[处理断开连接](/zh/x-api/posts/filtered-stream#what-is-a-disconnection)），它会在服务端对内容进行缓冲，以便你的客户端追上进度。然而，当缓冲区已满时，将会触发强制断开以终止连接，且已缓冲的帖子将被丢弃且不会重发。详见下文。

识别应用是否落后的一个方法是，将接收的帖子的时间戳与当前时间进行比较，并持续跟踪这一差值的变化。

尽管由于公共互联网可能存在的延迟和抖动，流式积压无法被完全避免，但通过对应用进行正确配置，可在很大程度上消除。为尽量减少积压的发生：

- 确保客户端以足够快的速度读取流。通常，不应在读取流的同时进行实际处理工作。应先读取流，再将任务交由其他线程/进程/数据存储异步处理。
- 确保你的数据中心具备足够的入站带宽，既能承载大规模的持续数据量，也能应对显著更大的峰值（例如正常体量的 5–10 倍）。对于过滤流，其数据量及你端所需的相应带宽完全取决于你的规则匹配到的帖子。
   

<div id="usage-tracking-and-rule-management">
  #### 使用情况跟踪与规则管理
</div>

鉴于不同开发者对其流的“正常”数据量有不同预期，我们无法就具体的百分比增减或时间周期给出通用建议。

请考虑监控流的数据量是否出现异常偏差。数据量下降可能与流断开属于不同类型的问题。在此情况下，流仍会接收保活信号，并可能仍有部分新增活动数据。然而，若帖子数量显著减少，应排查是否存在导致应用或网络入站数据量下降的因素，并检查[状态页](https://api.twitterstat.us/)是否有相关公告。

为实现此类监控，你可以跟踪在设定时间窗口内预期看到的新帖子数量。如果某个流的数据量明显低于指定阈值，且在设定时间内未恢复，则应触发告警和通知。你还可能需要监控数据量的大幅增加，尤其是在修改过滤流中的规则期间，或遇到会引发帖子活动激增的事件时。

需注意，通过过滤流传送的帖子会计入每月帖子总量；你应跟踪并调整消费以实现优化。若数据量较高，可考虑在每条规则中添加 sample: 运算符，以在必要时将匹配从 100% 降至 sample:50 或 sample:25。

此外，我们建议你在应用内实施措施：当数据量超过预设阈值时向团队发出告警，并视情况引入其他措施，例如自动删除带来过多数据的规则，或在极端情况下完全断开与流的连接。
 

<div id="responding-to-system-messages">
  #### 响应系统消息
</div>

保持连接信号
流会至少每 20 秒通过已打开的连接发送保持连接信号（心跳），以 \r\n 回车符的形式，防止客户端超时。你的客户端应用应能容忍流中的 \r\n 字符。

如果你的客户端在所用 HTTP 库上正确实现了读取超时，你的应用就可以依赖 HTTP 协议和该 HTTP 库在此期间未读取到数据时触发事件，而无需显式监测 \r\n 字符。

该事件通常表现为抛出异常，或根据所用 HTTP 库而触发其他事件。强烈建议为你的 HTTP 方法添加错误/事件处理程序来检测这些超时。一旦超时，你的应用应尝试重新连接。

错误消息
v2 流式端点也可能在流中传递错误消息。下面给出了这些消息的基本格式以及一些示例。请注意，传递的消息可能会变化，并可能引入新的消息。客户端应用需要能够容忍系统消息负载的变化。

请注意，错误消息会包含链接，指向说明如何解决问题的文档。

消息格式：

```{
	"errors": [{
		"title": "operational-disconnect",
		"disconnect_type": "UpstreamOperationalDisconnect",
		"detail": "This stream has been disconnected upstream for operational reasons.",
		"type": "https://api.x.com/2/problems/operational-disconnect"
	}]
}
```

另请注意，如果由于缓冲区已满而触发强制断开的错误消息，可能永远无法到达你的客户端——导致强制断开的积压可能会阻止该消息传递。因此，你的应用不应依赖这些消息来发起重连。