---
title: 处理断线
sidebarTitle: 处理断线
---

<div id="what-is-a-disconnection">
  ### 什么是断连？
</div>

与流式 API 建立连接意味着发起一个长时间保持的 HTTPS 请求，并以增量方式解析响应。连接到过滤流端点时，你应当发起一个 HTTPS 请求，并在可行的情况下尽可能长时间消费返回的流。除非出现服务器端错误、客户端严重滞后、网络问题、例行服务器维护或重复登录，我们的服务器会无限期保持该连接打开。对于流式端点的连接，断连是常见且应当预期的情况，因此需要实现重连逻辑。
 

<div id="why-a-streaming-connection-might-be-disconnected">
  #### 为什么流式连接可能会断开
</div>

您的流可能因多种原因而断开。请检查流返回的错误消息以了解失败原因。可能的断开原因包括：

- 身份验证错误（例如使用了错误的令牌或错误的身份验证方法）。
- X 端重启了流式服务器。这通常与代码部署相关，应事先预期并在系统设计中加以考虑。
- 您的客户端无法跟上流传递的帖子量，或读取数据过慢。每个流式连接背后都有一个发送给客户端的消息队列。如果该队列随时间增长过大，连接将被关闭。
- 您的账户超出了每日/每月的帖子配额。
- 活跃的冗余连接过多。
- 客户端突然停止读取数据。如果从流中读取帖子的速率突然下降，连接将被关闭。
- 服务器与客户端之间可能存在网络问题。
- 临时的服务端问题、计划内维护或更新。（查看[状态页](https://api.twitterstat.us/)）
   

<div id="common-disconnection-errors-include">
  #### 常见的断开错误包括：
</div>

```{
	"errors": [{
		"title": "operational-disconnect",
		"disconnect_type": "UpstreamOperationalDisconnect",
		"detail": "由于运营原因，此流已在上游被断开连接。",
		"type": "https://api.x.com/2/problems/operational-disconnect"
	}]
}
```

```
{
	"title": "ConnectionException",
	"detail": "此流当前已达到允许的最大连接数上限。",
	"connection_issue": "TooManyConnections",
	"type": "https://api.x.com/2/problems/streaming-connection"
}
```

<div id="anticipating-disconnects-and-reconnecting">
  #### 预判断连与重新连接
</div>

在流式传输帖子时，目标是尽可能长时间保持连接，同时也要意识到可能会发生断连。该端点会每 20 秒发送一次保活心跳（表现为一个换行符）。利用这一信号来检测是否正在被断开。

1. 您的代码应能检测到新内容和心跳何时停止到达。
2. 若发生此情况，代码应触发重连逻辑。某些客户端和语言允许指定读取超时，您可以将其设置为 20 秒。
3. 您的服务应检测到这些断连并尽快进行重连。

一旦已建立的连接中断，应立即尝试重连。若重连失败，请根据错误类型降低重连频率：

- 对 TCP/IP 层的网络错误采用线性退避。这类问题通常是暂时的，往往会很快恢复。每次重连尝试将延迟增加 250ms，最高至 16 秒。
- 对适合重连的 HTTP 错误采用指数退避。先等待 5 秒，每次尝试将等待时间加倍，最高至 320 秒。
- 对 HTTP 429（超出速率限制）采用指数退避。先等待 1 分钟，并在每次尝试时将等待时间加倍。请注意，每收到一次 HTTP 429，都会延长在您的账户不再受速率限制之前必须等待的时间。
   

<div id="recovering-lost-data">
  #### 恢复丢失的数据
</div>

如果确实发生断连，您可以采用多种策略来确保获取可能错过的全部数据。我们在集成指南的[数据恢复](/zh/x-api/posts/filtered-stream/integrate/recovery-and-redundancy-features)部分记录了用于恢复遗漏数据的一些关键步骤。 
 

<div id="rate-limits-and-usage">
  #### 速率限制与用量
</div>

要检查连接限制，响应会返回三个响应头。这有助于了解你可以调用规则端点的次数，以及流式端点允许的重连尝试次数。

- x-rate-limit-limit 表示在 15 分钟窗口内你的客户端被允许发起的请求配额。

- x-rate-limit-remaining 表示在该 15 分钟窗口内到目前为止已发起的请求数量。

- x-rate-limit-reset 是一个 UNIX 时间戳，指示 15 分钟窗口何时重置，届时会将 x-rate-limit-remaining 重置为 0。

过滤流端点目前不报告用量数据。要统计已传送的帖子数量，你的代码可以实现计量逻辑，以便在需要时衡量并暂停消费。

在你的代码中，负责承载流的客户端只需将接收的帖子插入先进先出（FIFO）队列或类似的内存结构；由单独的进程/线程从该队列中消费帖子，用于解析并准备入库。通过这种设计，当传入帖子量发生剧烈变化时，你可以实现一个能够高效扩展的服务。概念上，可以将其类比为通过 HTTP 下载一份无限长的文件。

<div id="reconnection-best-practices">
  #### 重连最佳实践
</div>

**测试退避策略**

测试退避机制的一个有效方法是使用无效的授权凭证，并观察重连尝试。良好的实现不应出现任何 429 响应。

**为多次重连发出警报**

如果客户端达到重连间隔时间的上限阈值，应向你发送通知，便于你排查影响连接的问题。

**处理 DNS 变更**

测试你的客户端进程是否遵循 DNS 生存时间（TTL）。某些技术栈会在进程整个生命周期内缓存解析得到的地址，无法在规定的 TTL 内拾取 DNS 变更。这种过度缓存会在 X 在不同 IP 地址之间进行负载切换时导致你的客户端发生服务中断。

**User Agent**

确保你的 user-agent HTTP 头包含客户端的版本信息。这对定位 X 端的问题至关重要。如果你的环境无法设置 user-agent 字段，则设置一个 x-user-agent 头。