---
title: 创建签名
sidebarTitle: 创建签名
---

import { Button } from "/snippets/zh/button.mdx";

<div id="creating-a-signature">
  ### 创建签名
</div>

本页说明如何为 HTTP 请求生成 OAuth 1.0a HMAC-SHA1 签名。该签名可作为授权请求的一部分传递给 X API，详见[授权请求](/zh/resources/fundamentals/authentication/oauth-1-0a/authorizing-a-request)。

用于演示签名的请求是对 https://api.x.com/1.1/statuses/update.json 发起的 POST。原始请求如下：

```
POST /1.1/statuses/update.json?include_entities=true HTTP/1.1
Accept: */*
Connection: close
User-Agent: OAuth gem v0.4.4
Content-Type: application/x-www-form-urlencoded
Content-Length: 76
Host: api.x.com

status=Hello%20Ladies%20%2b%20Gentlemen%2c%20a%20signed%20OAuth%20request%21
```

**收集请求方法和 URL**

要生成签名，首先确定请求的 HTTP 方法和 URL。在创建请求时这两者都是已知的，因此容易获取。

对于 X API 的请求，请求方法几乎总是 GET 或 POST。

|     |     |
| :--- | :--- |
| HTTP 方法 | POST |

基础 URL 是请求所指向的 URL，去掉所有查询字符串或哈希参数。正确使用协议很重要，请确保 URL 中的“https://”与实际发送到 API 的请求一致。

|     |     |
| :--- | :--- |
| 基础 URL | https://api.x.com/1.1/statuses/update.json |

<div id="collecting-parameters">
  #### 收集参数
</div>

接下来，收集请求中包含的所有参数。这些附加参数可能出现在两个位置：URL（作为查询字符串的一部分）和请求主体。示例请求在这两个位置各包含一个参数：

```
POST /1.1/statuses/update.json?include_entities=true HTTP/1.1
Accept: */*
Connection: close
User-Agent: OAuth gem v0.4.4
Content-Type: application/x-www-form-urlencoded
Content-Length: 76
Host: api.x.com

status=Hello%20Ladies%20%2b%20Gentlemen%2c%20a%20signed%20OAuth%20request%21
```

HTTP 请求的参数会进行 URL 编码，但你应当收集其原始值。除请求参数外，每个 oauth\_\* 参数也都需要包含在签名中，因此一并收集。以下是来自[对请求进行授权](/zh/resources/fundamentals/authentication/oauth-1-0a/authorizing-a-request)的参数：

|     |     |
| :--- | :--- |
| status | Hello Ladies + Gentlemen, a signed OAuth request! |
| include\_entities | true |
| oauth\_consumer\_key | xvz1evFS4wEEPTGEFPHBog |
| oauth\_nonce | kYjzVBB8Y0ZFabxSWbWovY3uYSQ2pTgmZeNu2VS4cg |
| oauth\_signature\_method | HMAC-SHA1 |
| oauth\_timestamp | 1318622958 |
| oauth\_token | 370773112-GmHxMAgYyLbNEtIKZeRNFsMKPR9EyMZeS9weJAEb |
| oauth\_version | 1.0 |

这些值需要被编码为一个字符串，稍后会用到。构建该字符串的过程非常明确：

1. [对将被签名的每个键和值进行百分号编码](/zh/resources/fundamentals/authentication/oauth-1-0a/percent-encoding-parameters)。
2. 按编码后的键的字母顺序[\[1\]](/zh/resources/fundamentals/authentication/oauth-1-0a/creating-a-signature)进行排序[\[2\]](/zh/resources/fundamentals/authentication/oauth-1-0a/creating-a-signature)。
3. 对于每个键/值对：
4. 将编码后的键追加到输出字符串。
5. 将字符“=”追加到输出字符串。
6. 将编码后的值追加到输出字符串。
7. 如果还有更多键/值对，向输出字符串追加一个“&”。

\[1] OAuth 规范要求按字典序排序，这也是许多库的默认字母排序方式。

\[2] 当存在两个具有相同编码键的参数时，OAuth 规范要求继续基于值进行排序。不过，X 不接受在 API 请求中出现重复键。
 

**参数字符串**

通过对上面收集的参数重复这些步骤，将生成如下的参数字符串：

| status                   | Hello Ladies + Gentlemen, a signed OAuth request!  |
|:--------------------------|:----------------------------------------------------|
| `include_entities`       | true                                               |
| `oauth_consumer_key`     | xvz1evFS4wEEPTGEFPHBog                             |
| `oauth_nonce`            | kYjzVBB8Y0ZFabxSWbWovY3uYSQ2pTgmZeNu2VS4cg         |
| `oauth_signature_method` | HMAC-SHA1                                          |
| `oauth_timestamp`        | 1318622958                                         |
| `oauth_token`            | 370773112-GmHxMAgYyLbNEtIKZeRNFsMKPR9EyMZeS9weJAEb |
| `oauth_version`          | 1.0                                                |

<div id="creating-the-signature-base-string">
  #### 创建签名基字符串
</div>

到目前为止收集的三个值必须连接为一个字符串，并据此生成签名。按照 OAuth 规范，这称为**签名基字符串**。

要将 HTTP 方法、基准 URL 和参数字符串编码为一个字符串：

1. 将 HTTP 方法转换为大写，并将输出字符串设为该值。
2. 在输出字符串后追加字符‘&’。
3. 对 URL 进行[百分号编码](/zh/resources/fundamentals/authentication/oauth-1-0a/percent-encoding-parameters)，并将其追加到输出字符串。
4. 在输出字符串后追加字符‘&’。
5. 对参数字符串进行[百分号编码](/zh/resources/fundamentals/authentication/oauth-1-0a/percent-encoding-parameters)，并将其追加到输出字符串。
    

这将生成以下\_签名基字符串\_：

```
POST&https%3A%2F%2Fapi.x.com%2F1.1%2Fstatuses%2Fupdate.json&include\_entities%3Dtrue%26oauth\_consumer\_key%3Dxvz1evFS4wEEPTGEFPHBog%26oauth\_nonce%3DkYjzVBB8Y0ZFabxSWbWovY3uYSQ2pTgmZeNu2VS4cg%26oauth\_signature\_method%3DHMAC-SHA1%26oauth\_timestamp%3D1318622958%26oauth\_token%3D370773112-GmHxMAgYyLbNEtIKZeRNFsMKPR9EyMZeS9weJAEb%26oauth_version%3D1.0%26status%3DHello%2520Ladies%2520%252B%2520Gentlemen%252C%2520a%2520signed%2520OAuth%2520request%2521
```

请确保对参数字符串进行百分号编码。签名基字符串应当恰好包含 2 个与号‘&’字符。参数字符串中的百分号‘%’字符在签名基字符串中应编码为 %25。
 

<div id="getting-a-signing-key">
  #### 获取签名密钥
</div>

最后需要收集的是用于标识发起请求的[X 应用](/zh/resources/fundamentals/developer-apps)以及该请求所代表用户的机密信息。务必注意，这些值极其敏感，绝不可对外共享。

用于在 X 上标识你的应用的值称为**consumer secret（消费者密钥）**，可在[开发者门户](/zh/resources/fundamentals/developer-portal)的[应用详情页面](/zh/resources/fundamentals/developer-apps)查看获取。对于你的 X 应用发出的每个请求，它都相同。

|     |     |
| :--- | :--- |
| Consumer secret | kAcSOqF21Fu85e7zjz7ZN2U4ZRhfV3WpwPAoE3Z7kBw |

用于标识你的应用代表哪个账户执行操作的值称为**OAuth token secret（OAuth 令牌密钥）**。该值可以通过多种方式获取，详见[获取访问令牌](/zh/resources/fundamentals/authentication/oauth-1-0a/obtaining-user-access-tokens)。

|     |     |
| :--- | :--- |
| OAuth token secret | LswwdoUaIvS8ltyTt5jkRh4J50vUPVVHtR2YPi5kE |

再次强调，务必将这些值严格保密，仅供你的应用使用。如果你认为这些值已遭泄露，请重新生成令牌（本页示例令牌已被标记为对真实请求无效）。

需要将上述两个值组合为**签名密钥**，用于生成签名。签名密钥即为[百分号编码](/zh/resources/fundamentals/authentication/oauth-1-0a/percent-encoding-parameters)后的令牌密钥：

请注意，在某些流程中（例如获取[请求令牌](/zh/resources/fundamentals/authentication/oauth-1-0a/obtaining-user-access-tokens)时）尚未知令牌密钥。在这种情况下，签名密钥应由[百分号编码](/zh/resources/fundamentals/authentication/oauth-1-0a/percent-encoding-parameters)后的**consumer secret**，后接一个和号“&”组成。

|     |     |
| :--- | :--- |
| Signing key | kAcSOqF21Fu85e7zjz7ZN2U4ZRhfV3WpwPAoE3Z7kBw\&LswwdoUaIvS8ltyTt5jkRh4J50vUPVVHtR2YPi5kE |

<div id="calculating-the-signature">
  #### 计算签名
</div>

最后，将签名基字符串和签名密钥传递给 HMAC-SHA1 哈希算法来计算签名。该算法的细节请参阅 hash\_hmac 函数。

HMAC 签名函数的输出是一个二进制字符串。需要将其进行 Base64 编码以生成签名字符串。例如，基于本页给出的基字符串和签名密钥，输出为 2E CF 77 84 98 99 6D 0D DA 90 5D C7 17 7C 75 07 3F 3F CD 4E。将该值转换为 Base64 后，即为此请求的 OAuth 签名：

|     |     |
| :--- | :--- |
| OAuth 签名 | Ls93hJiZbQ3akF3HF3x1Bz8/zU4= |