---
title: OAuth Echo
sidebarTitle: OAuth Echo
---

import { Button } from "/snippets/zh/button.mdx";


<div id="oauth-echo">
  ### OAuth Echo
</div>

OAuth Echo 是一种在与 API 交互时，将 OAuth 授权安全地委托给第三方的方式。

此交互涉及四方：

* **用户（User）**：通过某个已授权的 X 应用使用 X 的人
* **消费者（Consumer）**：尝试与第三方媒体提供方交互的 X 应用（例如照片分享网站）
* **委托方（Delegator）**：第三方媒体提供方
* **服务提供方（Service Provider）**：即 X 本身
     

本质上，是为委托方准备一个代表某个应用和用户向 X API 发送的请求。将原本需要签名的 OAuth 请求放入一个 HTTP 头中，并在完成中间操作后，要求委托方将该请求发送给 X。

举例：用户想上传一张照片。消费者将通过 POST 在委托方处调用上传。该 POST 应包含图像，同时还应在 HTTP 头中包含两个额外字段：

* `x-auth-service-provider` — 实际上，这是进行身份委托的目标域——对于 X，将其设为 https://api.x.com/1.1/account/verify_credentials.json。基于 iOS5 的 X 集成会在该 URL 中添加一个额外的 application_id 参数，该参数也将用于计算在 x-verify-credentials-authorization 中使用的 oauth_signature。
* `x-verify-credentials-authorization` — 消费者应创建调用 https://api.x.com/1.1/account/verify_credentials.json 所需的全部 OAuth 参数，并以 HTTP 头中的 OAuth 形式提供（例如，应类似于 OAuth oauth_consumer_key=”...”, oauth_token=”...”, oauth_signature_method=”...”, oauth_signature=”...”, oauth_timestamp=”...”, oauth_nonce=”...”, oauth_version=”...”）。
     

请注意，整个事务需要在 `oauth_timestamp` 仍然有效的时间窗口内完成。

或者，可以不将这两个参数放在头中，而是在 POST 体内以 x_auth_service_provider 和 x_verify_credentials_authorization 发送——在这种情况下，记得对参数进行转义并将其包含到 OAuth 签名基字符串中——与对任意请求参数的编码类似。最佳做法是使用 HTTP 头，以尽可能将这些操作彼此隔离。

此时，委托方（Delegator）的目标是在保存媒体之前验证用户身份的真实性。一旦委托方通过其上传方法接收到上述所有数据，应临时存储图像，然后构造对 x-auth-service-provider 头中指定端点的调用——在本例中为 https://api.x.com/1.1/account/verify_credentials.json，并使用消费者在 x-verify-credentials-authorization 头中提供的同一 OAuth 授权头。
 

<div id="oauth-echo-best-practices">
  #### OAuth Echo 最佳实践
</div>

使用 `x-auth-service-provider` 提供的 URL 进行查询，_而不是_ 使用硬编码的值。比如在 Apple iOS 上，系统会为所有 OAuth 请求添加一个额外的 application_id 参数，并且该参数在 OAuth Echo 的各个阶段都应被保留。

在 OAuth 授权部分，将 x-verify-credentials-authorization 中的 header 值，作为单独的 Authorization 头用于向服务提供方发起请求。为稳妥起见，请确认 `x-auth-service-provider` 中的值正确无误。

* 如果服务提供方返回 HTTP 200，则一切正常。Delegator 应永久存储该图片，生成一个 URL 并返回。
* 如果服务提供方未返回 HTTP 200，则丢弃该图片，并向 Consumer 返回一个错误。