---
title: OAuth 2.0 授权码模式（含 PKCE）
sidebarTitle: OAuth 2.0 授权码模式（含 PKCE）
---

<div id="oauth-20-authorization-code-flow-with-pkce">
  ### 使用 OAuth 2.0（含 PKCE）的授权码流程
</div>

<div id="introduction">
  #### 介绍
</div>

OAuth 2.0 是一项业界标准的授权协议，可让您更精细地控制应用的权限范围，以及在多设备间的授权流程。OAuth 2.0 允许您选择特定的细粒度权限范围，从而代表用户获得相应的权限。

要在您的应用中启用 OAuth 2.0，需前往开发者门户的“应用设置”中的身份验证设置将其开启。

#### 我的凭证会有效多久？  

默认情况下，除非你使用了 `offline.access` 作用域，否则你通过 OAuth 2.0（含 PKCE）的授权码流程创建的访问令牌仅在两小时内有效。

<div id="refresh-tokens">
  #### 刷新令牌
</div>

刷新令牌允许应用在无需再次提示用户的情况下，通过刷新令牌流程获取新的访问令牌。

如果应用了 `offline.access` 作用域，将签发一个 OAuth 2.0 刷新令牌。使用该刷新令牌可以获取访问令牌。未传入该作用域时，我们不会生成刷新令牌。

使用刷新令牌获取新的访问令牌的请求示例如下：

```bash
POST 'https://api.x.com/2/oauth2/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'refresh_token=bWRWa3gzdnk3WHRGU1o0bmRRcTJ5VUxWX1lZTDdJSUtmaWcxbTVxdEFXcW5tOjE2MjIxNDc3NDM5MTQ6MToxOnJ0OjE' \
--data-urlencode 'grant_type=refresh_token' \
--data-urlencode 'client_id=rG9n6402A3dbUJKzXTNX4oWHJ
```

<div id="app-settings">
  #### 应用设置
</div>

您可以将应用的身份验证设置为 OAuth 1.0a 或 OAuth 2.0。您也可以启用应用同时使用 OAuth 1.0a 和 OAuth 2.0。

OAuth 2.0 仅能与 X API v2 搭配使用。如果您选择了 OAuth 2.0，您将在应用的 Keys and Tokens 部分看到一个 Client ID。 

<div id="confidential-clients">
  #### 机密客户端
</div>

[机密客户端](https://datatracker.ietf.org/doc/html/rfc6749#section-2.1) 能以安全方式保存凭证，避免暴露给未授权方，并可与授权服务器安全完成身份验证，从而妥善保护你的客户端密钥。公共客户端通常运行在浏览器或移动设备上，无法使用客户端密钥。如果你选择的应用类型是机密客户端，将会提供一个客户端密钥。

如果你在开发者门户中将客户端类型设为机密客户端，你也可以看到客户端密钥。可选类型包括 Native App、Single-page App、Web App、Automated App 或 bot。Native App 和 Single-page App 属于公共客户端，而 Web App、Automated App 和 bot 属于机密客户端。

对于具有有效 Authorization Header 的机密客户端，无需提供客户端 ID。对于使用公共客户端的请求，仍需在请求体中包含 Client ID。 

<div id="scopes">
  #### 作用域
</div>

作用域允许为您的应用设置细粒度的访问权限，使其仅拥有所需的权限。要了解各作用域与哪些端点对应，请查看我们的[身份验证映射指南](/zh/resources/fundamentals/authentication/guides/v2-authentication-mapping)。

|     |     |
| :--- | :--- |
| **作用域** | **描述** |
| tweet.read | 您可查看的所有推文，包括受保护账户的推文。 |
| tweet.write | 代表您发布推文和转推。 |
| tweet.moderate.write | 隐藏或取消隐藏对您推文的回复。 |
| users.email | 已认证用户的电子邮件地址。 |
| users.read | 您可查看的任何账户，包括受保护账户。 |
| follows.read | 关注您的人以及您关注的人。 |
| follows.write | 代表您关注或取消关注他人。 |
| offline.access | 在您撤销授权前，保持对您账户的持续访问。 |
| space.read | 您可查看的所有 Space。 |
| mute.read | 您已静音的账户。 |
| mute.write | 代表您静音或取消静音账户。 |
| like.read | 您点赞过的推文以及您可查看的点赞。 |
| like.write | 代表您点赞或取消点赞推文。 |
| list.read | 您创建或加入的列表、列表成员及列表关注者，包括私有列表。 |
| list.write | 代表您创建并管理列表。 |
| block.read | 您已屏蔽的账户。 |
| block.write | 代表您屏蔽或取消屏蔽账户。 |
| bookmark.read | 从已认证用户获取加为书签的推文。 |
| bookmark.write | 为推文添加或移除书签。 |
| media.write | 上传媒体。 |

<div id="rate-limits">
  #### 速率限制
</div>

总体而言，速率限制与使用 OAuth 1.0a 进行身份验证时相同，但 `Tweets lookup` 和 `Users lookup` 除外。对于 `Tweet lookup` 和 `user lookup`，在使用 OAuth 2.0 时，我们将每个应用的限制从每 15 分钟 300 次请求提升至 900 次请求。要了解更多，请查看我们的[速率限制文档](/zh/resources/fundamentals/rate-limits)。

<div id="grant-types">
  #### 授权类型
</div>

在此次初始发布中，我们仅支持带有 [PKCE](https://oauth.net/2/pkce/) 的[授权码](https://oauth.net/2/grant-types/authorization-code/)和[刷新令牌](https://oauth.net/2/grant-types/refresh-token/)这两种[授权类型](https://oauth.net/2/grant-types/)。未来我们可能会提供更多授权类型。

<div id="oauth-20-flow">
  #### OAuth 2.0 流程
</div>

OAuth 2.0 的流程与我们当前使用的 OAuth 1.0a 类似。您可以在我们的[相关文档](/zh/resources/fundamentals/authentication/oauth-1-0a/obtaining-user-access-tokens)中查看示意图和详细说明。 

<div id="glossary">
  #### 术语表
</div>

|     |     |
| :--- | :--- |
| **术语** | **说明** |
| 授权类型 | OAuth 框架为不同用例规定了多种授权类型，并提供了创建新授权类型的机制。示例包括 authorization code、client credentials、device code 和 refresh token。 |
| 机密客户端 | 能够与授权服务器安全完成认证的应用程序，例如可妥善保管其注册的 client secret。 |
| 公开客户端 | 无法使用已注册 client secret 的客户端，例如在浏览器或移动设备中运行的应用程序。 |
| Authorization code flow | 由机密客户端和公开客户端使用，用于将 authorization code 交换为 access token。 |
| PKCE | authorization code flow 的扩展，用于防止多种攻击，并使公开客户端能够安全地执行 OAuth 交换。 |
| Client ID | 可在开发者门户的“keys and tokens”部分、标题为“Client ID”的位置找到。若未看到，请直接联系团队。生成 authorize URL 时需要使用 Client ID。 |
| Redirect URI | 你的回调 URL。需要通过[精确匹配验证](https://datatracker.ietf.org/doc/html/rfc6749#section-10.6)。 |
| Authorization code | 允许应用代表用户访问 API，简称 auth\_code。应用所有者一旦从用户处收到已批准的 auth\_code，auth\_code 的有效期为 30 秒。必须在 30 秒内将其交换为 access token，否则将失效。 |
| Access token | 应用代表用户发起 API 请求时使用的令牌。 |
| Refresh token | 允许应用通过 refresh token flow 在不提示用户的情况下获取新的 access token。 |
| Client Secret | 如果你选择的 App 类型为机密客户端，会在应用的“keys and tokens”部分的“Client ID”下提供“Client Secret”。 |

<div id="parameters">
  #### 参数
</div>

要构建 OAuth 2.0 授权 URL，您需要确保授权 URL 中包含以下参数。

|     |     |
| :--- | :--- |
| **Parameter** | **Description** |
| response\_type | 需要将其指定为授权码，值为“code”。 |
| client\_id | 可在开发者门户中 “Client ID” 一项下找到。 |
| redirect\_uri | 您的回调 URL。该值必须与您在应用设置中定义的某个 Callback URL 完全对应。对于 OAuth 2.0，回调 URL 需要通过[精确匹配验证](https://datatracker.ietf.org/doc/html/rfc6749#section-10.6)。 |
| state | 您提供的用于防范[CSRF 攻击](https://auth0.com/docs/protocols/state-parameters)的随机字符串。该字符串长度最多为 500 个字符。 |
| code\_challenge | 一个[PKCE](https://www.oauth.com/oauth2-servers/pkce/authorization-request/)参数，即为每个请求生成的随机机密。 |
| code\_challenge\_method | 指定用于生成 code\_challenge 的方法（S256 或 plain）。 |

#### 授权 URL 

使用 OAuth 2.0 时，您需要生成一个授权 URL，供用户通过认证流程进行身份验证，类似于使用 X 的“登录”。 

要创建的 URL 示例： 

```
https://x.com/i/oauth2/authorize?response_type=code&client_id=M1M5R3BMVy13QmpScXkzTUt5OE46MTpjaQ&redirect_uri=https://www.example.com&scope=tweet.read%20users.read%20account.follows.read%20account.follows.write&state=state&code_challenge=challenge&code_challenge_method=plain
```

为确保该 URL 正常工作，您需要进行正确的编码。请参阅我们关于[百分号编码](/zh/resources/fundamentals/authentication/oauth-1-0a/percent-encoding-parameters)的文档。