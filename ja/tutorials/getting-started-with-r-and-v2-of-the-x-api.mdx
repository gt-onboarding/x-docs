---
title: R と X API v2 の始め方
mode: wide
---

<div id="introduction">
  ## はじめに
</div>

このチュートリアルでは、プログラミング言語 R と X API v2 を使い始めるために必要な内容を順に説明します。R を使って [user lookup](/ja/x-api/users/lookup/introduction) エンドポイントに接続し、X API から返される JSON の扱い方を紹介します。user lookup は GET メソッドで、ユーザー ID または username を指定して、単一または複数のユーザー情報を返します。

R は時系列分析、モデリング、可視化、その他のデータ分析といった一般的なデータサイエンスの作業に広く使われる代表的な言語であり、X API と併用されることもよくあります。user lookup エンドポイントでは、[user object](/ja/x-api/fundamentals/data-dictionary#user) を用いて、あるユーザーのフォロワー数とプロフィールの自己紹介文のセンチメントスコアとの相関を確認できます。user object は、プロフィールで公開されている所在地に基づいてアカウントのグループをマッピングする用途にも利用できます。

<div id="getting-started-with-the-x-api">
  ### X API の始め方
</div>

X API v2 を使用する前に、開発者アカウントに
[サインアップ](https://developer.x.com/en/portal/petition/essential/basic-info)
する必要があります。

開発者アカウントの承認が下りたら、まず
[Project](/ja/resources/fundamentals/projects) を作成します。Projects を使うと、X API の利用目的に応じて作業を整理でき、API へのアクセスを適切に管理し、利用状況を監視できます。

各 Project には [App](/ja/resources/fundamentals/developer-apps) が含まれており、これを使って X API を利用するために必要なクレデンシャルを生成できます。X API の始め方の詳細は、ドキュメントの
[getting started](/ja/x-api/getting-started/about-x-api) セクションをご覧ください。

<div id="getting-your-r-environment-set-up">
  ### R 環境のセットアップ
</div>

まずは [R をダウンロード](https://cloud.r-project.org/)します。これは
[CRAN のウェブサイト](https://cran.r-project.org/)から行えます。

その後、R で作業する環境を整えるには、
[RStudio](https://www.rstudio.com/)、[Visual Studio Code](https://marketplace.visualstudio.com/items?itemName=Ikuyadeu.r-pack) の R 拡張パック、
または Python に慣れている場合は
[Jupyter Notebook](https://docs.anaconda.com/anaconda/navigator/tutorials/r-lang/) を使用できます。

<div id="setting-up-your-environment-variable">
  ### 環境変数の設定
</div>

これから示すコード例を実行するにあたり、ベアラートークン用の環境変数を用意してください。Bearer Token は、X API への認証およびリクエスト実行を可能にする資格情報です。まず、developer portal のアプリ内「keys and tokens」セクションで取得したご自身のベアラートークンで “your-bearer-token” を置き換えてください。スクリプトを書き始める前に、この行をコンソールで実行する必要があります。

```r
Sys.setenv(BEARER_TOKEN = "your-bearer-token")
```

<div id="making-your-request">
  ### リクエストの作成
</div>

パッケージ
[httr](https://cran.r-project.org/web/packages/httr/index.html) を使って X API へ HTTP
リクエストを送信できます。まだインストールしていない場合は、コンソールで
このパッケージをインストールしてください。さらに、
[jsonlite](https://cran.r-project.org/web/packages/jsonlite/index.html) をインストールして
JSON オブジェクトを扱えるようにし、データ操作のために [dplyr](https://dplyr.tidyverse.org/) も
インストールする必要があります。

```r
install.packages("httr")
install.packages("jsonlite")
install.packages("dplyr")
```

これで API に接続するための R スクリプトを書き始められます。ファイルの先頭で、
httr、jsonlite、dplyr の各パッケージを読み込みます。

```r
require(httr)
require(jsonlite)
require(dplyr)
```

コードサンプルの最初の手順は、X API への認証設定です。アプリから取得した
[Bearer Token](/ja/resources/fundamentals/authentication#using-and-generating-an-app-only-bearer-token) を用意し、
認証のためにヘッダーに渡します。以下の例では、$BEARER\_TOKEN を手元のトークンに置き換えてください。

```r
bearer_token <- Sys.getenv("$BEARER_TOKEN")
headers <- c(`Authorization` = sprintf('Bearer %s', bearer_token))
```

認証の設定ができたら、リクエストのパラメータを定義します。
デフォルトでは、取得対象の各ユーザーの id、name、username が返されます。
このペイロードは、追加の
[fields](/ja/x-api/fundamentals/fields) や
[expansions](/ja/x-api/fundamentals/expansions) を指定して調整できます。この例では、
ユーザーのプロフィールの自己紹介文を取得するために user.fields=description を指定し、
さらにユーザーの固定投稿を含めるエクスパンションを指定します。

```r
params <- list(`user.fields` = 'description', `expansions` = 'pinned_tweet_id')
```

次に、取得したい対象の X ハンドル（アカウントとも呼ばれます）を使って URL を整形します。
このサンプルを再利用可能にするため、readline メソッドを使用します。確認したいハンドルを入力したら、
$USERNAME を希望する X ハンドルに置き換えて、定義したハンドルを含むように URL を整形します。

```r
handle <- readline('$USERNAME')
url_handle <- sprintf('https://api.x.com/2/users/by?usernames=%s', handle)
```

ここで、httr パッケージを使って作成した URL へ GET リクエストを送信し、
ヘッダーで認証情報を渡し、定義したパラメータを付与します。レスポンスはテキストオブジェクトとして
変数 obj に保存し、リクエストの結果を確認するために出力します。

```r
response <-
  httr::GET(url = url_handle,
    httr::add_headers(.headers = headers),
    query = params)
obj <- httr::content(response, as = "text")
print(obj)
```

<div id="working-with-our-json-payload">
  ### JSON ペイロードの取り扱い
</div>

私が JSON を扱う際に好んで使う方法のひとつは、データフレームを用いることです。これにより、複雑にネストされたデータへ簡単にアクセスできます。これを行うには、jsonlite パッケージの fromJSON メソッドでファイルをフラット化し、フィールドを同一オブジェクト内に展開します。次に、そのオブジェクトをデータフレームに渡します。これで、このデータフレームを表示する準備が整いました。

```
json_data <- fromJSON(obj, flatten = TRUE) %>% as.data.frame View(json_data)
```

データフレームからフィールドにアクセスし、ハンドル、ユーザー名、自己紹介を含む文字列を作成できます。

```r
final <-
  sprintf(
    "Handle: %s\nBio: %s\nPinned Post: %s",
    json_data$data.username,
    json_data$data.description,
    json_data$includes.tweets.text
  )
```

各フィールドの間に改行を入れて表示するには、print ではなく cat を使用します。

```r
cat(final)
```

複数のハンドルに対してリクエストを行っている場合は、ループで各データフレーム要素に容易にアクセスできます。

<div id="conclusion">
  ### まとめ
</div>

このチュートリアルが、R と X API を扱うための出発点になれば幸いです。次のステップとして、最近の検索、投稿のルックアップ、ユーザーのルックアップ向けの R サンプルを、当社の[v2 sample code](https://github.com/xdevplatform)でご確認ください。途中で問題が発生した場合は[forums](https://devcommunity.x.com/)でお知らせください。また、このチュートリアルに触発されて何かを作成された場合は、[@XDevelopers](https://x.com/XDevelopers) へ投稿でお知らせください。