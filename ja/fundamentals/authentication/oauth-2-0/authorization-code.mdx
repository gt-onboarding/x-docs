---
title: OAuth 2.0 認可コードフロー（PKCE 付き）
sidebarTitle: OAuth 2.0 認可コードフロー（PKCE 付き）
---

<div id="oauth-20-authorization-code-flow-with-pkce">
  ### OAuth 2.0 認可コードフロー（PKCE）
</div>

<div id="introduction">
  #### はじめに
</div>

OAuth 2.0 は業界標準の認可プロトコルであり、アプリケーションのスコープと複数デバイスにまたがる認可フローをより細かく制御できます。OAuth 2.0 では、ユーザーに代わって特定の権限を付与するための、きめ細かなスコープを選択できます。

アプリで OAuth 2.0 を有効にするには、開発者ポータルの App 設定内にある認証設定で有効化してください。

#### 認証情報はどのくらいの期間有効ですか?  

デフォルトでは、OAuth 2.0（PKCE）のAuthorization Code Flowで発行したアクセストークンは、`offline.access` スコープを使用していない限り、2時間のみ有効です。

<div id="refresh-tokens">
  #### リフレッシュトークン
</div>

リフレッシュトークンを使用すると、リフレッシュトークンフローによりユーザーへ再認可を促すことなく、アプリケーションで新しいアクセストークンを取得できます。

スコープ `offline.access` を付与した場合は、OAuth 2.0 のリフレッシュトークンが発行されます。このリフレッシュトークンを使ってアクセストークンを取得します。このスコープを指定しなかった場合、リフレッシュトークンは発行されません。

リフレッシュトークンを使って新しいアクセストークンを取得するリクエスト例は次のとおりです。

```bash
POST 'https://api.x.com/2/oauth2/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'refresh_token=bWRWa3gzdnk3WHRGU1o0bmRRcTJ5VUxWX1lZTDdJSUtmaWcxbTVxdEFXcW5tOjE2MjIxNDc3NDM5MTQ6MToxOnJ0OjE' \
--data-urlencode 'grant_type=refresh_token' \
--data-urlencode 'client_id=rG9n6402A3dbUJKzXTNX4oWHJ
```

<div id="app-settings">
  #### アプリ設定
</div>

アプリの認証方式として OAuth 1.0a または OAuth 2.0 を選択できます。アプリで OAuth 1.0a と OAuth 2.0 の両方を有効にすることも可能です。

OAuth 2.0 は X API v2 でのみ利用できます。OAuth 2.0 を選択した場合、アプリの Keys and Tokens セクションに Client ID が表示されます。 

<div id="confidential-clients">
  #### 機密クライアント
</div>

[機密クライアント](https://datatracker.ietf.org/doc/html/rfc6749#section-2.1)は、認可されていない第三者に公開することなく安全に認証情報を保持し、認可サーバーに対して安全に認証できます。これにより、クライアントシークレットが保護されます。パブリッククライアントは通常、ブラウザやモバイルデバイス上で動作するため、クライアントシークレットを使用できません。機密クライアントに該当するアプリ種別を選択すると、クライアントシークレットが発行されます。 

開発者ポータルで機密クライアントに該当するクライアントタイプを選択した場合、Client Secret も表示されます。選択肢は Native App、Single page App、Web App、Automated App、または bot です。Native App と Single page App はパブリッククライアントで、Web App と Automated App または bot は機密クライアントです。

有効な Authorization Header を使用する機密クライアントでは、Client ID は不要です。パブリッククライアントでのリクエストでは、引き続き本文に Client ID を含める必要があります。 

<div id="scopes">
  #### スコープ
</div>

スコープを使用すると、アプリに必要な権限のみに限定して、アクセス権を細かく設定できます。各スコープがどのエンドポイントに対応するかは、[認証マッピングガイド](/ja/resources/fundamentals/authentication/guides/v2-authentication-mapping)をご覧ください。

|     |     |
| :--- | :--- |
| **スコープ** | **説明** |
| tweet.read | 閲覧可能なすべてのツイート（保護されたアカウントのツイートを含む）。 |
| tweet.write | ツイートおよびリツイートを行う。 |
| tweet.moderate.write | 自分のツイートへの返信を非表示／再表示する。 |
| users.email | 認証済みユーザーのメールアドレス。 |
| users.read | 閲覧可能なすべてのアカウント（保護されたアカウントを含む）。 |
| follows.read | フォロワーおよびフォロー中のユーザー。 |
| follows.write | フォロー／フォロー解除を行う。 |
| offline.access | アクセスを取り消すまで、アカウントへの接続を維持する。 |
| space.read | 閲覧可能なすべてのSpace。 |
| mute.read | ミュートしているアカウント。 |
| mute.write | アカウントのミュート／ミュート解除を行う。 |
| like.read | 「いいね」したツイートおよび閲覧可能な「いいね」。 |
| like.write | ツイートに「いいね」／「いいね」解除を行う。 |
| list.read | 作成または参加しているリストの本体、リストメンバー、リストのフォロワー（非公開リストを含む）。 |
| list.write | リストの作成および管理を行う。 |
| block.read | ブロックしているアカウント。 |
| block.write | アカウントのブロック／ブロック解除を行う。 |
| bookmark.read | 認証済みユーザーのブックマーク済みツイートを取得する。 |
| bookmark.write | ツイートをブックマークに追加／ブックマークから削除する。 |
| media.write | メディアをアップロードする。 |

<div id="rate-limits">
  #### レート制限
</div>

ほとんどの場合、レート制限は OAuth 1.0a での認証時と同じですが、Tweet lookup と User lookup は例外です。OAuth 2.0 を使用する場合、Tweet lookup と User lookup のアプリごとの上限は、15分あたり300リクエストから900リクエストに引き上げられます。詳細は[レート制限に関するドキュメント](/ja/resources/fundamentals/rate-limits)をご覧ください。

<div id="grant-types">
  #### グラントタイプ
</div>

この初期リリースでは、サポートされる[グラントタイプ](https://oauth.net/2/grant-types/)として、[PKCE](https://oauth.net/2/pkce/)を用いた[authorization code](https://oauth.net/2/grant-types/authorization-code/)と、[refresh token](https://oauth.net/2/grant-types/refresh-token/)のみを提供します。今後、対応するグラントタイプを追加する可能性があります。

<div id="oauth-20-flow">
  #### OAuth 2.0 フロー
</div>

OAuth 2.0 のフローは、現在 OAuth 1.0a で採用しているものと概ね同様です。詳しい図と解説は、[該当ドキュメント](/ja/resources/fundamentals/authentication/oauth-1-0a/obtaining-user-access-tokens)をご参照ください。 

<div id="glossary">
  #### 用語集
</div>

|     |     |
| :--- | :--- |
| **用語** | **説明** |
| Grant types | OAuth フレームワークは、さまざまなユースケース向けに複数のグラントタイプを規定しており、新しいグラントタイプを作成するための枠組みも提供しています。例として、authorization code、client credentials、device code、refresh token があります。 |
| Confidential client | クライアントとは、認可サーバーに対して安全に認証できるアプリケーションを指します。たとえば、登録済みの client secret を安全に保持できます。 |
| Public client | ブラウザやモバイルデバイス上で動作するアプリケーションなど、登録済みの client secret を使用できないクライアントを指します。 |
| Authorization code flow | 機密クライアントとパブリッククライアントの双方で、authorization code をアクセス トークンに交換するために使用されます。 |
| PKCE | 複数の攻撃を防ぎ、パブリッククライアントから安全に OAuth の交換を実行できるようにする authorization code flow の拡張です。 |
| Client ID | Developer Portal の Keys and tokens セクションの「Client ID」見出しの下にあります。表示されない場合は当チームまで直接ご連絡ください。authorize URL の生成に Client ID が必要です。 |
| Redirect URI | コールバック URL。 [exact match validation](https://datatracker.ietf.org/doc/html/rfc6749#section-10.6) が必要です。 |
| Authorization code | アプリケーションがユーザーに代わって API を呼び出すことを可能にします。auth\_code とも呼ばれます。ユーザーに承認された auth\_code をアプリの所有者が受け取ってから 30 秒の有効期限があります。30 秒以内にアクセス トークンと交換しない場合、auth\_code は失効します。 |
| Access token | アプリケーションがユーザーに代わって API リクエストを行うために使用するトークンです。 |
| Refresh token | ユーザーに再承認を求めることなく、refresh token flow により新しいアクセス トークンを取得できます。 |
| Client Secret | 機密クライアントの App タイプを選択した場合、App の Keys and tokens セクションの「Client ID」の下に「Client Secret」が表示されます。 |

<div id="parameters">
  #### パラメータ
</div>

OAuth 2.0 の認可 URL を構築するには、認可 URL に以下のパラメータが含まれていることを確認してください。

|     |     |
| :--- | :--- |
| **Parameter** | **Description** |
| response\_type | 「code」という文字列で認可コードフローであることを指定します。 |
| client\_id | Developer Portal の「Client ID」に記載されています。 |
| redirect\_uri | コールバック URL。値は App の設定で定義されている Callback URLs のいずれかと一致している必要があります。OAuth 2.0 ではコールバック URL に対して[完全一致の検証](https://datatracker.ietf.org/doc/html/rfc6749#section-10.6)が必要です。 |
| state | [CSRF 攻撃](https://auth0.com/docs/protocols/state-parameters)対策のために提供するランダムな文字列。最大 500 文字まで指定できます。 |
| code\_challenge | [PKCE](https://www.oauth.com/oauth2-servers/pkce/authorization-request/) のパラメータ。各リクエストごとに生成するランダムなシークレットです。 |
| code\_challenge\_method | 使用する方式を指定します（S256 または plain）。 |

#### 認可 URL 

OAuth 2.0 では、X の「Sign in」と同様の認証フローを通じてユーザーが認証できるようにするための認可 URL を作成します。 

作成する URL の例は次のとおりです。 

```
https://x.com/i/oauth2/authorize?response_type=code&client_id=M1M5R3BMVy13QmpScXkzTUt5OE46MTpjaQ&redirect_uri=https://www.example.com&scope=tweet.read%20users.read%20account.follows.read%20account.follows.write&state=state&code_challenge=challenge&code_challenge_method=plain
```

この URL を機能させるには正しいエンコードが必要です。[パーセントエンコーディング](/ja/resources/fundamentals/authentication/oauth-1-0a/percent-encoding-parameters) に関するドキュメントを必ず確認してください。