---
title: "Account Activity API: Enterprise"
---

<Note>
  このエンドポイントは、投稿の編集メタデータを含むように更新されました。これらのメタデータの詳細は「["Edit Posts" の基礎](/ja/x-api/enterprise-gnip-2.0/fundamentals/edit-tweets)」ページをご覧ください。 

  このエンドポイントはダイレクトメッセージのエンドポイントと併用されることがよくあります。新しい [v2 ダイレクトメッセージエンドポイント](/ja/x-api/direct-messages/manage/introduction)を公開しました。Enterprise および Premium の Account Activity API は v2 の 1 対 1 メッセージをサポートしていますが、グループ会話はまだサポートしていない点にご注意ください。   
</Note>

Overview

`Enterprise`

Account Activity API は、Webhook を介してユーザーアカウントに関連するリアルタイムのアクティビティをサブスクライブする機能を提供します。これは、単一の接続で、あなたが所有またはサブスクライブしている 1 つ以上のアカウントから、リアルタイムの投稿、ダイレクトメッセージ、その他のアカウントイベントを受信できることを意味します。

Webhook 登録の各ユーザーサブスクリプションに対して、以下の関連アクティビティをすべて受信します:

| Activity types |     |
| :--- | :--- |
| \* 投稿（ユーザーによる）  <br />    <br />\* 投稿の削除（ユーザーによる）<br />\* @メンション（ユーザーに対する）<br />\* 返信（ユーザーへの、またはユーザーからの）<br />\* リポスト（ユーザーによる、またはユーザーに対する）<br />\* 引用投稿（ユーザーによる、またはユーザーに対する）<br />\* 引用投稿のリポスト（ユーザーによる、またはユーザーに対する）<br />\* いいね（ユーザーによる、またはユーザーに対する）<br />\* フォロー（ユーザーによる、またはユーザーに対する）  <br />    <br />\* フォロー解除（ユーザーによる） | \* ブロック（ユーザーによる）<br />\* ブロック解除（ユーザーによる）<br />\* ミュート（ユーザーによる）<br />\* ミュート解除（ユーザーによる）<br />\* ダイレクトメッセージ送信（ユーザーによる）<br />\* ダイレクトメッセージ受信（ユーザーによる）<br />\* 入力中インジケーター（ユーザー宛）<br />\* 既読通知（ユーザー宛）<br />\* サブスクリプションの取り消し（ユーザーによる） |

**ご注意ください** - Account Activity API ではホームタイムラインのデータは配信しません。このデータを取得するには [GET statuses/home\_timeline](https://developer.x.com/en/docs/x-api/v1/tweets/timelines/overview) をご利用ください。
 

<div id="video-series">
  #### 動画シリーズ
</div>

Account Activity API を手早く理解するために、[全4回の動画シリーズ](https://www.youtube.com/watch?v=otPxejFhyy8\&index=0\&list=PLFKjcMIU2WshGG6Yj940XM7Z6BFs1zfBg)をご覧ください。

<iframe src="https://platform.x.com/embed/Tweet.html?dnt=false&embedId=twitter-widget-0&features=eyJ0ZndfdGltZWxpbmVfbGlzdCI6eyJidWNrZXQiOltdLCJ2ZXJzaW9uIjpudWxsfSwidGZ3X2ZvbGxvd2VyX2NvdW50X3N1bnNldCI6eyJidWNrZXQiOnRydWUsInZlcnNpb24iOm51bGx9LCJ0ZndfdHdlZXRfZWRpdF9iYWNrZW5kIjp7ImJ1Y2tldCI6Im9uIiwidmVyc2lvbiI6bnVsbH0sInRmd19yZWZzcmNfc2Vzc2lvbiI6eyJidWNrZXQiOiJvbiIsInZlcnNpb24iOm51bGx9LCJ0ZndfZm9zbnJfc29mdF9pbnRlcnZlbnRpb25zX2VuYWJsZWQiOnsiYnVja2V0Ijoib24iLCJ2ZXJzaW9uIjpudWxsfSwidGZ3X21peGVkX21lZGlhXzE1ODk3Ijp7ImJ1Y2tldCI6InRyZWF0bWVudCIsInZlcnNpb24iOm51bGx9LCJ0ZndfZXhwZXJpbWVudHNfY29va2llX2V4cGlyYXRpb24iOnsiYnVja2V0IjoxMjA5NjAwLCJ2ZXJzaW9uIjpudWxsfSwidGZ3X3Nob3dfYmlyZHdhdGNoX3Bpdm90c19lbmFibGVkIjp7ImJ1Y2tldCI6Im9uIiwidmVyc2lvbiI6bnVsbH0sInRmd19kdXBsaWNhdGVfc2NyaWJlc190b19zZXR0aW5ncyI6eyJidWNrZXQiOiJvbiIsInZlcnNpb24iOm51bGx9LCJ0ZndfdXNlX3Byb2ZpbGVfaW1hZ2Vfc2hhcGVfZW5hYmxlZCI6eyJidWNrZXQiOiJvbiIsInZlcnNpb24iOm51bGx9LCJ0ZndfdmlkZW9faGxzX2R5bmFtaWNfbWFuaWZlc3RzXzE1MDgyIjp7ImJ1Y2tldCI6InRydWVfYml0cmF0ZSIsInZlcnNpb24iOm51bGx9LCJ0ZndfbGVnYWN5X3RpbWVsaW5lX3N1bnNldCI6eyJidWNrZXQiOnRydWUsInZlcnNpb24iOm51bGx9LCJ0ZndfdHdlZXRfZWRpdF9mcm9udGVuZCI6eyJidWNrZXQiOiJvbiIsInZlcnNpb24iOm51bGx9fQ%3D%3D&frame=false&hideCard=false&hideThread=false&id=996790447048613888&lang=en&origin=https%3A%2F%2Fdeveloper.x.com%2Fen%2Fdocs%2Fx-api%2Fenterprise%2Faccount-activity-api%2Foverview&sessionId=81f4a0339cbd7bd77b669faa00bd3a7224bc4418&theme=light&widgetsVersion=2615f7e52b7e0%3A1702314776716&width=550px" height="400px" />

<div id="feature-summary">
  ### 機能概要
</div>

| ティア | 価格 | 固有サブスクリプション数 | Webhook 数 | 信頼性とアクティビティ復旧 |
| :--- | :--- | :--- | :--- | :--- |
| Enterprise | [営業担当にお問い合わせ](/ja/x-api/enterprise-gnip-2.0/enterprise-gnip) | 最大 500 以上 | 3 以上 | [再試行](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#retries) と [リプレイ](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#account-activity-replay-api) |

- ご不明点やエラーが発生していますか？
  - [よくある質問](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#frequently-asked-questions) と [エラーのトラブルシューティングガイド](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#frequently-asked-questions) をご覧ください。

- サンプルコードをお試しください:
  - [Enterprise Account Activity API ダッシュボード](https://github.com/xdevplatform/account-activity-dashboard-enterprise)：Account Activity API の Enterprise ティアを使用して Webhook イベントを表示し、[リプレイ](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#account-activity-replay-api) 機能を備えた Node 製の Web アプリです。
  - [SnowBot チャットボット](https://github.com/xdevplatform/SnowBotDev)：Enterprise の Account Activity API と Direct Message API の上に構築された Ruby 製の Web アプリです。

#### Webhook の管理:

Webhook を使用すると、単一の接続でユーザーアカウントに関連するリアルタイムのアクティビティを購読できます。 

<Tabs>
  <Tab title="Webhook を追加する">
    まず、対象のアプリケーションコンテキストに新しい webhook URL を登録します。

    保存前に、その URL は CRC リクエストで検証されます。Webhook を登録したら、後で必要になるため webhook ID を必ず控えておいてください。

    次の項目を編集したうえで、以下の cURL リクエストをコマンドラインにコピーして実行してください。

    - **URL** `<URL>` 例: `https://yourdomain.com/webhooks/twitter/`

    - **Consumer key** `<CONSUMER_KEY>` 例: `xvz1evFS4wEEPTGEFPHBog`

    - **Access token** `<ACCESS_TOKEN>` 例: `370773112-GmHxMAgYyLbNEtIKZeRNFsMKPR9EyMZeS9weJAEb`

      ```
      curl --request POST --url 'https://api.x.com/1.1/account_activity/webhooks.json?url=<URL>' --header 'authorization: OAuth oauth_consumer_key="<CONSUMER_KEY>", oauth_nonce="GENERATED", oauth_signature="GENERATED", oauth_signature_method="HMAC-SHA1", oauth_timestamp="GENERATED", oauth_token="<ACCESS_TOKEN>", oauth_version="1.0"'
      ```
  </Tab>

  <Tab title="Webhook を表示する">
    対象のアプリケーションについて、登録済みのすべての webhook URL とそのステータスを取得するには、次のコマンドを実行します。

    次の項目を編集したうえで、以下の cURL リクエストをコマンドラインにコピーして実行してください。

    - **Bearer token** `<BEARER_TOKEN>` 例: `AAAAAAAAAAAA0%2EUifi76ZC9Ub0wn...`

      ```curl --request GET --url https://api.x.com/1.1/account_activity/webhooks.json --header 'authorization: Bearer <BEARER_TOKEN>'
      ```
  </Tab>

  <Tab title="Webhook を削除する">
    対象のアプリケーション設定から webhook を削除するには、次の項目を編集したうえで、以下の cURL リクエストをコマンドラインにコピーして実行してください。

    - **Webhook ID** `<:WEBHOOK_ID>` 例: `1234567890`

    - **Consumer key** `<CONSUMER_KEY>` 例: `xvz1evFS4wEEPTGEFPHBog`

    - **Access token** `<ACCESS_TOKEN>` 例: `370773112-GmHxMAgYyLbNEtIKZeRNFsMKPR9EyMZeS9weJAEb`

      ```curl --request DELETE --url https://api.x.com/1.1/account_activity/webhooks/<:WEBHOOK_ID>.json --header 'authorization: OAuth oauth_consumer_key="<CONSUMER_KEY>", oauth_nonce="GENERATED", oauth_signature="GENERATED", oauth_signature_method="HMAC-SHA1", oauth_timestamp="GENERATED", oauth_token="<ACCESS_TOKEN>", oauth_version="1.0"'
      ```
  </Tab>
</Tabs>

<div id="managing-a-webhook">
  #### 購読ユーザーの管理:
</div>

Webhook を登録したら、Account Activity API に購読ユーザーを追加して、そのユーザーのアカウントアクティビティの受信を開始できます。

<Tabs>
  <Tab title="サブスクリプションの追加">
    まずユーザーを購読し、すべてのイベントタイプを受信できるようにします。

    次の項目を差し替えたうえで、以下の cURL リクエストをコマンドラインにコピーしてください。

    - **Webhook ID** `<:WEBHOOK_ID>` 例: `1234567890`

    - **Consumer key 名** `<CONSUMER_KEY>` 例: `xvz1evFS4wEEPTGEFPHBog`

    - **購読ユーザーのアクセス トークン** `<SUBSCRIBING_USER'S_ACCESS_TOKEN>` 例: `370773112-GmHxMAgYyLbNEtIKZeRNFsMKPR9EyMZeS9weJAEb`

      ```
      curl --request POST --url https://api.x.com/1.1/account_activity/webhooks/<:WEBHOOK_ID>/subscriptions/all.json --header 'authorization: OAuth oauth_consumer_key="<CONSUMER_KEY>", oauth_nonce="GENERATED", oauth_signature="GENERATED", oauth_signature_method="HMAC-SHA1", oauth_timestamp="GENERATED", oauth_token="<SUBSCRIBING_USER'S_ACCESS_TOKEN>", oauth_version="1.0"'
      ```
  </Tab>

  <Tab title="サブスクリプションの表示">
    指定した webhook に対するすべてのアクティビティタイプのサブスクリプション一覧を表示するには、次の項目を差し替えたうえで、以下の cURL リクエストをコマンドラインにコピーしてください。

    - **Webhook ID** `<:WEBHOOK_ID>` 例: `1234567890`

    - **Bearer トークン** `<BEARER_TOKEN>` 例: `AAAAAAAAAAAA0%2EUifi76ZC9Ub0wn...`

      ```
      curl --request GET --url https://api.x.com/1.1/account_activity/webhooks/<:WEBHOOK_ID>/subscriptions/all/list.json --header 'authorization: Bearer <BEARER_TOKEN>'
      ```
  </Tab>

  <Tab title="サブスクリプションの削除">
    非アクティブ化後、リクエスト元ユーザーに関するすべてのイベントは webhook の URL に送信されなくなります。

    指定したユーザーコンテキストとアプリケーションからサブスクリプションを非アクティブ化するには、次の項目を差し替えたうえで、以下の cURL リクエストをコマンドラインにコピーしてください。

    - **Webhook ID** `<:WEBHOOK_ID>` 例: `1234567890`

    - **Consumer key** `<CONSUMER_KEY>` 例: `xvz1evFS4wEEPTGEFPHBog`

    - **購読ユーザーのアクセス トークン** `<SUBSCRIBING_USER'S_ACCESS_TOKEN>` 例: `370773112-GmHxMAgYyLbNEtIKZeRNFsMKPR9EyMZeS9weJAEb`

      ```
      curl --request DELETE --url https://api.x.com/1.1/account_activity/webhooks/:WEBHOOK_ID/subscriptions/all.json --header 'authorization: OAuth oauth_consumer_key="CONSUMER_KEY", oauth_nonce="GENERATED", oauth_signature="GENERATED", oauth_signature_method="HMAC-SHA1", oauth_timestamp="GENERATED", oauth_token="SUBSCRIBED_USER'S_ACCESS_TOKEN", oauth_version="1.0"'
      ```
  </Tab>
</Tabs>

これで Webhook と購読ユーザーを管理できるようになりました。

<div id="managing-subscribed-users">
  #### 関連記事
</div>

- [チャレンジレスポンスチェック（CRC）の概要](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#securing-webhooks)
- \[アカウントアクティビティデータタイプ]\(/x-api/enterprise-gnip-2.0/fundamentals/account-activity#account-activity-data-object-structure
- [Webhookとサブスクリプションの管理](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#managing-webhooks-and-subscriptions)

## Account Activity API の動画ガイド

この動画ガイドでは、Account Activity API のプレミアムおよびエンタープライズ各ティアで利用できる機能について学びます。

動画の最後までに、次の機能を理解できます。

- Webhook の登録
- ユーザーサブスクリプションの追加
- ユーザーサブスクリプションの削除
- アカウントアクティビティの受信
- アカウントアクティビティのリプレイ

<iframe src="https://platform.x.com/embed/Tweet.html?dnt=false&embedId=twitter-widget-0&features=eyJ0ZndfdGltZWxpbmVfbGlzdCI6eyJidWNrZXQiOltdLCJ2ZXJzaW9uIjpudWxsfSwidGZ3X2ZvbGxvd2VyX2NvdW50X3N1bnNldCI6eyJidWNrZXQiOnRydWUsInZlcnNpb24iOm51bGx9LCJ0ZndfdHdlZXRfZWRpdF9iYWNrZW5kIjp7ImJ1Y2tldCI6Im9uIiwidmVyc2lvbiI6bnVsbH0sInRmd19yZWZzcmNfc2Vzc2lvbiI6eyJidWNrZXQiOiJvbiIsInZlcnNpb24iOm51bGx9LCJ0ZndfZm9zbnJfc29mdF9pbnRlcnZlbnRpb25zX2VuYWJsZWQiOnsiYnVja2V0Ijoib24iLCJ2ZXJzaW9uIjpudWxsfSwidGZ3X21peGVkX21lZGlhXzE1ODk3Ijp7ImJ1Y2tldCI6InRyZWF0bWVudCIsInZlcnNpb24iOm51bGx9LCJ0ZndfZXhwZXJpbWVudHNfY29va2llX2V4cGlyYXRpb24iOnsiYnVja2V0IjoxMjA5NjAwLCJ2ZXJzaW9uIjpudWxsfSwidGZ3X3Nob3dfYmlyZHdhdGNoX3Bpdm90c19lbmFibGVkIjp7ImJ1Y2tldCI6Im9uIiwidmVyc2lvbiI6bnVsbH0sInRmd19kdXBsaWNhdGVfc2NyaWJlc190b19zZXR0aW5ncyI6eyJidWNrZXQiOiJvbiIsInZlcnNpb24iOm51bGx9LCJ0ZndfdXNlX3Byb2ZpbGVfaW1hZ2Vfc2hhcGVfZW5hYmxlZCI6eyJidWNrZXQiOiJvbiIsInZlcnNpb24iOm51bGx9LCJ0ZndfdmlkZW9faGxzX2R5bmFtaWNfbWFuaWZlc3RzXzE1MDgyIjp7ImJ1Y2tldCI6InRydWVfYml0cmF0ZSIsInZlcnNpb24iOm51bGx9LCJ0ZndfbGVnYWN5X3RpbWVsaW5lX3N1bnNldCI6eyJidWNrZXQiOnRydWUsInZlcnNpb24iOm51bGx9LCJ0ZndfdHdlZXRfZWRpdF9mcm9udGVuZCI6eyJidWNrZXQiOiJvbiIsInZlcnNpb24iOm51bGx9fQ%3D%3D&frame=false&hideCard=false&hideThread=false&id=1204084171334832128&lang=en&origin=https%3A%2F%2Fdeveloper.x.com%2Fen%2Fdocs%2Fx-api%2Fenterprise%2Faccount-activity-api%2Fquick-start%2Fa-visual-walkthrough-of-the-account-activity-api&sessionId=b5b8e259a4c6287be2413de9059093170036fb30&theme=light&widgetsVersion=2615f7e52b7e0%3A1702314776716&width=550px" />

- 質問がありますか？エラーが発生していますか？
  - [よくある質問](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#frequently-asked-questions) または [エラーのトラブルシューティングガイド](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#frequently-asked-questions) をご覧ください。

- サンプルコードを確認する:
  - [Enterprise Account Activity API dashboard](https://github.com/xdevplatform/account-activity-dashboard-enterprise) は、Account Activity API のエンタープライズティアで Webhook イベントを表示し、[Replay](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#account-activity-replay-api) 機能を備えた Node 製の Web アプリです。
  - [SnowBot chatbot](https://github.com/xdevplatform/SnowBotDev) は、エンタープライズ版 Account Activity API と Direct Message API の上に構築された Ruby 製の Web アプリです。

**エンタープライズ**

<div id="a-video-walkthrough-of-the-account-activity-api">
  ## Webhook のはじめ方
</div>

Account Activity API は、あなたが開発・デプロイ・ホストする Web アプリにアカウントイベントを送信する、Webhook ベースの API です。

イベント受信側のアプリケーションで Webhook イベントを受け取れるようにする前に、いくつかの実装上の前提作業があります。以下のとおり、X アプリを作成し、Account Activity API へのアクセス権を取得し、Webhook イベントを取り込む Web アプリを開発する必要があります。 

### 1. X アプリを作成します。

- [developer portal](/ja/resources/fundamentals/developer-portal) で承認済みの開発者アカウントを使用し、[X app](/ja/resources/fundamentals/developer-apps) を作成します。会社を代表して作成する場合は、企業の X アカウントでの作成を推奨します。開発者アカウントを申請するには、[こちら](/ja/resources/fundamentals/developer-apps)から行ってください。
- アプリページの [permissions](/ja/resources/fundamentals/developer-apps#oauth-1-0a-app-permissions) タブで「Read, Write and Access direct messages」を有効にします。
- "Keys and Access Tokens" タブで、アプリの Consumer Key (API Key) と Consumer Secret (API Secret) を控えておきます。
- 同じタブで、アプリの [Access Token and Access Token Secret](/ja/resources/fundamentals/authentication#obtaining-access-tokens-using-3-legged-oauth-flow) を生成します。これらのアクセストークンは、X がアカウントイベントを送信する先となる webhook URL を登録する際に必要です。
- [X Sign-in](/ja/resources/fundamentals/authentication#log-in-with-x) および X API におけるユーザーコンテキストに不慣れな場合は、[Obtaining Access Tokens](https://dev.x.com/webhooks/access-tokens) を確認してください。イベントを受信するアカウントを追加する際は、そのアカウントのアクセストークンで購読を設定します。
- [developer portal](/ja/resources/fundamentals/developer-portal) の ["Apps"](/ja/resources/fundamentals/developer-apps) ページに表示されるアプリの数値 ID を控えておきます。Account Activity API アクセスを申請する際に、このアプリ ID が必要になります。
   

<div id="1-create-a-x-app">
  ### 2. Account Activity API へのアクセスを取得する
</div>

X のアプリを作成したら、次のステップは Account Activity API へのアクセス申請です。 

Account Activity API は Enterprise でのみ利用可能なため、以下のリンクから申請を行ってください。

<Button href="https://developer.x.com/en/enterprise-application.html">
  Enterprise アクセスを申請
</Button>

<div id="2-get-account-activity-api-access">
  ### 3. Webhook コンシューマーアプリを開発する
</div>

Account Activity API へのアクセスが付与されたら、X の webhook イベントを受信する Web アプリを開発・デプロイ・ホスティングする必要があります。 

- イベント受信用の webhook として使用する URL を持つ Web アプリを作成します。これは、X の webhook イベントを受信するためにサーバー上にデプロイするエンドポイントです。 
  - URI の path は任意です。次の例は有効です: https://mydomain.com\_/service/listen\_

  - 複数のソースからの webhook を受信する場合、一般的なパターンは次のとおりです: https://mydomain.com/webhook/twitter

  - 指定する URL にはポート番号を含められない点に注意してください（https://mydomain.com:5000/NoWorkie は不可）。

- [Securing Webhooks](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#securing-webhooks) ガイドで説明しているとおり、最初のステップは、X の Challenge Response Check（CRC）GET リクエストを受け取り、適切に整形された JSON レスポンスで応答するコードを書くことです。 

- Webhook の URL を登録します。/webhooks.json?url= エンドポイントに POST リクエストを送信します。このリクエストを送信すると、X はあなたの Web アプリに CRC リクエストを送信します。Webhook が正常に登録されると、レスポンスには webhook の id が含まれます。この webhook id は、後で Account Activity API に対して一部のリクエストを行う際に必要になります。 

- X は、登録した URL にアカウントの webhook イベントを送信します。受信イベントに対して、あなたの Web アプリが POST リクエストを受け付けるようにしておいてください。これらのイベントは JSON でエンコードされます。Webhook の JSON ペイロード例は[こちら](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#account-activity-data-object-structure)を参照してください。

- Web アプリの準備ができたら、次のステップはアクティビティを受信するアカウントを追加することです。アカウントを追加（または削除）する際は、アカウント id を参照する POST リクエストを行います。詳細は[サブスクリプションの追加に関するガイド](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#managing-webhooks-and-subscriptions)を参照してください。

<div id="3-develop-webhook-consumer-app">
  ### 4. セットアップの検証
</div>

- アプリとWebhookが正しく構成されていることを検証するには、アプリが購読しているXアカウントのいずれかが投稿したポストを「いいね」してください。購読者が受け取る各「いいね」について、WebhookのURL宛てにPOSTリクエストで`favorite_events`が届くはずです。
- 購読を追加してからイベントの配信が開始されるまで、最大10秒かかる場合がある点に注意してください。

**重要な注意事項**

- WebhookのURLを登録する際、Webアプリはコンシューマートークンとシークレットに加え、\_アプリ所有者のユーザーアクセス用トークンとシークレット\_で認証する必要があります。

- 受信したすべてのダイレクトメッセージはWebhook経由で配信されます。[POST direct\_messages/events/new (message\_create)](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/new-event)経由で送信されたすべてのダイレクトメッセージもWebhook経由で配信されます。これは、別のクライアントから送信されたダイレクトメッセージをWebアプリが把握できるようにするためです。

- すべてのWebhookイベントには、そのイベントがどの購読に対して配信されたかを示すfor\_user\_idのユーザーIDが含まれる点に注意してください。

- 同じ会話で2人のユーザーがWebアプリをダイレクトメッセージ用に使用している場合、Webhookは重複する2件のイベント（各ユーザーごとに1件）を受信します。Webアプリ側で考慮してください。

- 同じWebhookのURLを共有し、かつ同じユーザーを各アプリにマッピングしているWebアプリが複数ある場合、同じイベントがWebhookに複数回（Webアプリごとに1回）送信されます。

- 場合によっては、Webhookが重複したイベントを受信することがあります。Webhookアプリはこれに耐性を持ち、イベントIDで重複排除すべきです。

- クイックリプライの応答がリクエストに直ちに続くとは限りません。ユーザーはクイックリプライのリクエストを無視でき、従来のダイレクトメッセージで返信する場合があります。ユーザーが、メッセージスレッド内で以前に返信していないリクエストに対してクイックリプライで応答する可能性もあります。

- サンプルコードを参照:
  - [Enterprise Account Activity API dashboard](https://github.com/xdevplatform/account-activity-dashboard-enterprise) — Account Activity APIのエンタープライズ階層を使用してWebhookイベントを表示し、[Replay](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#account-activity-replay-api)機能を備えたNode製のWebアプリ。

  - [SnowBot chatbot](https://github.com/xdevplatform/SnowBotDev) — Account Activity APIとDirect Message API上に構築されたRuby製のWebアプリ。このコードベースには、Account Activity APIのWebhook設定を支援する[script](https://github.com/xdevplatform/SnowBotDev/wiki/Account-Activity-API-setup-script)が含まれます。

## Webhook の保護

X の Webhook ベースの API では、Webhook サーバーのセキュリティを確認するために、次の 2 つの方法を提供しています。

1. チャレンジレスポンス検証により、Webhook イベントを受信する Web アプリの所有権を X が確認できます。
2. 各 POST リクエストの署名ヘッダーにより、受信した Webhook が X から送信されたものであることを確認できます。
    

### チャレンジレスポンスチェック

あなたがアプリと webhook URL の双方の所有者であることを検証するため、X は Challenge-Response Check（CRC）を実行します。これは巡回冗長検査（cyclic redundancy check）とは異なります。CRC が送信されると、X は `_crc_token` パラメータを付与してあなたの Web アプリに対し GET リクエストを送信します。そのリクエストを受信したら、あなたの Web アプリは `_crc_token` パラメータとアプリの Consumer Secret（詳細は以下）に基づいて暗号化された `response_token` を生成する必要があります。`response_token` は JSON でエンコード（以下の例を参照）し、3 秒以内に返却しなければなりません。成功すると、webhook の `id` が返されます。

webhook URL を登録するときに CRC が送信されるため、CRC 応答コードの実装は最初の基本ステップです。webhook が確立された後は、直近で成功した応答の受信時刻からおよそ 24 時間ごとに X が CRC をトリガーします。あなたのアプリは、必要に応じて webhook の `id` を用いた PUT リクエストを行うことで CRC をトリガーすることもできます。新しいコードをデプロイしてサービスを再起動した後など、webhook アプリケーションの開発中に CRC をトリガーするのは有用です。

`_crc_token` は受信する CRC リクエストごとに変化することが想定されており、計算においては Consumer Secret を鍵として、メッセージとして使用する必要があります。

3 秒以内に応答が返されない場合、または無効になった場合は、イベントは登録済みの webhook への送信が停止されます。

#### CRC リクエストが発生するタイミング:

- Webhook の URL が登録されたとき
- Webhook の URL を検証するため、概ね _毎時_
- PUT リクエストを送信することで、手動で CRC を実行できます。Webhook クライアントを開発する際は、CRC レスポンスの実装に合わせて、手動で CRC を実行できるようにしておいてください。 
   

<div id="the-crc-request-will-occur">
  #### レスポンス要件:
</div>

- `crc_token` とアプリの Consumer Secret を用いて作成した、base64 エンコードの HMAC-SHA256 ハッシュ
- 有効な response\_token と JSON 形式
- レイテンシは 3 秒未満
- HTTP ステータスコード 200
   

<div id="response-requirements">
  #### 言語ごとの HMAC ライブラリ:
</div>

- [Java/Scala](https://docs.oracle.com/javase/8/docs/api/index.html?javax/crypto/Mac.html)
- [Ruby](http://ruby-doc.org/stdlib-2.1.0/libdoc/openssl/rdoc/OpenSSL/HMAC.html)
- [Node.js](https://nodejs.org/api/crypto.html#crypto_class_hmac)
- [Python](https://docs.python.org/2/library/hmac.html)

<div id="language-specific-hmac-libraries">
  #### Python におけるレスポンストークン生成の例:
</div>

以下は、Python 2.7 の Flask ウェブアプリで、チャレンジレスポンス検証に正しく応答するルートを定義しています。

```
import base64
import hashlib
import hmac
import json


\# Defines a route for the GET request
@app.route('/webhooks/twitter', methods=\['GET'\])
def webhook_challenge():

  # creates HMAC SHA-256 hash from incomming token and your consumer secret
  sha256\_hash\_digest = hmac.new(TWITTER\_CONSUMER\_SECRET, msg=request.args.get('crc_token'), digestmod=hashlib.sha256).digest()

  # construct response data with base64 encoded hash
  response = {
    'response\_token': 'sha256=' + base64.b64encode(sha256\_hash_digest)
  }

  # returns properly formatted json response
  return json.dumps(response)
```

<div id="example-response-token-generation-in-python">
  #### JSON レスポンスの例:
</div>

上記のようにルートを定義していれば、ウェブブラウザで https://your-app-domain/webhooks/twitter?crc\_token=foo にアクセスした際に、ウェブアプリは次のようなレスポンスを返します。

```
{
  "response_token": "sha256=x0mYd8hz2goCTfcNAaMqENy2BFgJJfJOb4PdvTffpwg="
}
```

<div id="example-json-response">
  #### その他の例:
</div>

- [HERE](https://github.com/xdevplatform/account-activity-dashboard/blob/master/helpers/security.js) は、Node/JS で実装された CRC 応答メソッドの例です。
- [HERE](https://github.com/xdevplatform/SnowBotDev/blob/master/app/controllers/snow_bot_dev_app.rb) は、Ruby で実装された CRC 応答メソッドの例です（_generate\_crc\_response_ と、CRC イベントを受け取る /GET ルートを参照してください）。

### 任意の署名ヘッダー検証

X から POST リクエストを受信する場合、Webhook を作成するために GET リクエストを送信する場合、または手動 CRC を実行するために GET リクエストを送信する場合、ハッシュ署名がヘッダーの x-twitter-webhooks-signature として渡されます。この署名は、データの送信元が X であることを検証するために使用できます。POST のハッシュ署名は sha256= で始まり、HMAC SHA-256 を使用して X App Consumer Secret とペイロードから計算されていることを示します。GET のハッシュは、クエリパラメータ文字列 crc\_token=$token\&nonce=$nonce から計算されます。 

**リクエストを検証する手順**

1. Consumer Secret と受信したペイロード本文を使ってハッシュを作成します。
2. 作成したハッシュを、base64 でエンコードされた x-twitter-webhooks-signature の値と比較します。タイミング攻撃への耐性を高めるため、[compare\_digest](https://docs.python.org/2/library/hmac.html) のような手法を使用してください。

<div id="optional-signature-header-validation">
  ### 追加のセキュリティガイドライン
</div>

以下は、Web アプリケーションで検討すべき追加のセキュリティガイドラインです。これらのガイドラインを実装していなくても webhook の動作自体は妨げられませんが、X の情報セキュリティチームにより強く推奨されています。以下の推奨事項に詳しくない場合は、サーバー管理者に相談してください。

#### X 集約ネットワークブロック

追加のセキュリティ対策として、以下の集約ネットワークブロックを許可リストに追加することを検討してください：

- 199.59.148.0/22

- 199.16.156.0/22

- 192.133.77.0/26

- 64.63.15.0/24

- 64.63.31.0/24

- 64.63.47.0/24

- 202.160.128.0/24

- 202.160.129.0/24

- 202.160.130.0/24

<div id="x-aggregate-network-blocks">
  #### 推奨サーバー構成
</div>

- [ssllabs.com](http://ssllabs.com/) のテストで「A」評価を獲得
- **TLS 1.2 を有効にする**
- Forward Secrecy を有効にする
- SSLv2 を無効にする
- SSLv3 を無効にする（POODLE 対策）
- TLS 1.0 を無効にする
- TLS 1.1 を無効にする
- TLS 圧縮を無効にする
- セッションチケットキーをローテーションしない限り、セッションチケットを無効にする
- SSL 構成で “ssl\_prefer\_server\_ciphers” または “SSLHonorCipherOrder” オプションを「on」に設定する
- 暗号スイートの一覧が次のようなモダンなリストになっていることを確認する:
  `ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA:ECDHE-RSA-DES-CBC3-SHA:DES-CBC3-SHA`

## Webhook とサブスクリプションの管理

### Webhook の作成と変更

Webhook の URL を変更するには、既存の webhook を削除してから新しいものを作成する必要があります。なお、その際は新しい webhook にユーザーのサブスクリプションを再度追加し直す必要があります。

#### Webhook 構成管理エンドポイント:

|     |     |
| :--- | :--- |
| **メソッド** | エンタープライズ |
| Webhook URL を登録／webhook\_id を生成 | [POST webhooks](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#enterprise-account-activity-api) |
| すべての Webhook URL とそのステータスを返す | [GET webhooks](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks) |
| アプリの現在の Webhook 構成を削除 | [DELETE webhooks/:webhook\_id](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id) |
| CRC リクエストを手動で実行 | [PUT webhooks/:webhook\_id](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#put-account-activity-webhooks-webhook-id) |

<div id="webhook-configuration-management-endpoints">
  #### なぜ webhook の URL を更新するだけではいけないのですか？
</div>

なぜ webhook 構成は変更不可なのですか？X はセキュリティを非常に重視しています。webhook の URL が変更された場合、アプリケーションの consumer key と consumer secret が漏えいしている可能性があります。新しい webhook 構成の作成を必須とすることで、ユーザーのイベントへの再購読も必要になります。これには、不正な第三者が保有している可能性が低いアクセス・トークンの使用が伴います。結果として、第三者がユーザーの非公開情報を受け取ってしまうリスクが低減されます。
 

### ユーザーサブスクリプションの追加と削除

エンタープライズ層では、数千件のサブスクリプションに対応しています。すでにアカウントマネージャーがいる場合は、ご不明点について担当者までお問い合わせください。エンタープライズ API へのアクセス申請は、[こちら](https://developer.x.com/en/products/x-api/enterprise)から行えます。 

#### サブスクリプション管理エンドポイント

 

|     |     |
| :--- | :--- |
| メソッド | エンタープライズ |
| 新規ユーザーサブスクリプションを追加 | [POST webhooks/:webhook\_id/subscriptions/all](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks-webhook-id-subscriptions-all) |
| ユーザーサブスクリプションを取得 | [GET webhooks/:webhook\_id/subscriptions/all](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks-webhook-id-subscriptions-all) |
| すべての有効なサブスクリプションの一覧を返す | [GET webhooks/:webhook\_id/subscriptions/all/list](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-subscriptions-count) |
| アプリケーション専用 OAuth を使用してユーザーサブスクリプションを無効化 | [DELETE webhooks/:webhook\_id/subscriptions/:user\_id/all.json](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id-subscriptions-user-id-all-json) |

Account Activity API: エンタープライズ

<Note>
  **ご留意ください**: 

  API を利用開始する前に、X 側でお客様の開発者向け App に対して Account Activity API へのアクセスを有効化する必要があります。認証に使用する予定の App ID を、担当アカウントマネージャーまたはテクニカルサポートチームに必ず共有してください。
</Note>

[Account Activity API](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity) は、単一の接続で、購読中のすべてのアカウントのリアルタイムなアカウントアクティビティを受け取るためのユーザーサブスクリプションを作成・管理できる一連のエンドポイントで構成されています。 

Account Activity API では 2 種類の認証方法（[OAuth 1.0a](/ja/resources/fundamentals/authentication#oauth-1-0a-2) と [OAuth 2.0 ベアラートークン](/ja/resources/fundamentals/authentication#bearer-token-also-known-as-app-only)）が利用可能です。どの認証方法を使用するかは、利用するエンドポイントによって異なります。

|     |     |     |     |
| :--- | :--- | :--- | :--- |
| **説明** | **エンドポイント** | OAuth 1.0a  <br />(ユーザーコンテキスト) | OAuth 2.0 ベアラートークン（アプリケーション専用） |
| 指定されたアプリケーションコンテキストに新しい webhook URL を登録する | [POST account\_activity/webhooks](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks) | ✓   |     |
| 指定されたアプリケーションのすべての URL とそのステータスを返す | [GET account\_activity/webhooks](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks) |     | ✓   |
| 指定の webhook の URL に対して CRC（チャレンジレスポンスチェック）を実行する | [PUT account\_activity/webhooks/:webhook\_id](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#put-account-activity-webhooks-webhook-id) | ✓   |     |
| アプリケーションをユーザーのアカウントイベントに登録（サブスクライブ）する | [POST account\_activity/webhooks/:webhook\_id/subscriptions/all](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks-webhook-id-subscriptions-all) | ✓ \* |     |
| 現在アクティブなサブスクリプション数を返す | [GET account\_activity/subscriptions/count](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-subscriptions-count) |     | ✓   |
| webhook 構成がユーザーのイベントにサブスクライブされているか確認する | [GET account\_activity/webhooks/:webhook\_id/subscriptions/all](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks-webhook-id-subscriptions-all) | ✓ \* |     |
| 現在アクティブなサブスクリプションの一覧を返す | [GET account\_activity/webhooks/:webhook\_id/subscriptions/all/list](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks-webhook-id-subscriptions-all-list) |     | ✓   |
| webhook を削除する | [DELETE account\_activity/webhooks/:webhook\_id](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id) | ✓   |     |
| \[非推奨] 指定のユーザーコンテキストとアプリケーションのサブスクリプションを無効化する | [DELETE account\_activity/webhooks/:webhook\_id/subscriptions/all](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id-subscriptions-all-deprecated) | ✓ \* |     |
| アプリケーション専用 OAuth を使用してサブスクリプションを無効化する | [DELETE /account\_activity/webhooks/:webhook\_id/subscriptions/:user\_id/all.json](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id-subscriptions-user-id-all-json) |     | ✓   |
| アクティビティを webhook に再配信する | [POST /1.1/account\_activity/replay/webhooks/:webhook\_id/subscriptions/all.json](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#replay-api) |     | ✓   |

\*\_ 認証には、サブスクライブ対象ユーザーのアクセストークンが必要です。 \_

OAuth 1.0a のユーザーコンテキスト認証が必要なエンドポイントでは、リクエストの認証に以下のクレデンシャルを提供する必要があります。

- コンシューマーキー（API Key と Secret）
- アクセストークン（Access Token と Secret）

次の3つのエンドポイントでは、アプリケーションのコンテキストで書き込み操作を行います（X のユーザーは関与しません）。したがって、提供すべきアクセストークンはあなたの開発者向け App のものです。これらは [developer portal](https://developer.x.com/en/portal/projects-and-apps) の該当 App の “Keys and tokens” タブから直接生成できます。  

- [POST account\_activity/webhooks](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks): 指定されたアプリケーションコンテキストに新しい webhook URL を登録する
- [PUT account\_activity/webhooks/:webhook\_id](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#put-account-activity-webhooks-webhook-id): 指定された webhook の URL に対してチャレンジレスポンスチェック（CRC）を実行する
- [DELETE account\_activity/webhooks/:webhook\_id](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id): webhook を削除する

一方、以下の3つのエンドポイントでは、アプリケーションが X ユーザー（例：ダイレクトメッセージ）の代わりに保護されたデータへアクセスできるようにするリクエストを行います。したがって、該当する購読ユーザーに属する Access Token を提供する必要があります。必要な Access Token は 3-legged OAuth フローで取得できます（[OAuth 1.0a: how to obtain a user’s Access Tokens](/ja/resources/fundamentals/authentication#obtaining-access-tokens-using-3-legged-oauth-flow) を参照）。これらのエンドポイントは上の表でアスタリスク（\*）で示されています。

- [POST account\_activity/webhooks/:webhook\_id/subscriptions/all](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks-webhook-id-subscriptions-all): アプリケーションをユーザーのアカウントイベントに購読させる
- [GET account\_activity/webhooks/:webhook\_id/subscriptions/all](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks-webhook-id-subscriptions-all): webhook 構成がユーザーのイベントを購読しているか確認する
- [DELETE account\_activity/webhooks/:webhook\_id/subscriptions/all](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id-subscriptions-all-deprecated): 指定のユーザーコンテキストとアプリケーションのサブスクリプションを無効化する \[DEPRECATED]

<Note>
  **Please note**: 

  開発者 App が「Read, Write, and Direct Messages」に有効化されていることを確認してください。この設定は、開発者アカウントの [Projects & Apps section](https://developer.x.com/en/portal/projects-and-apps) の対象の開発者 App の「App permissions」で変更できます。権限設定を変更した後は、App の認証情報を再生成する必要があります。
</Note>

Account Activity API で利用可能なすべてのエンドポイントの一覧（説明および認証実装例付きの cURL サンプルを含む）は、[API リファレンスドキュメント](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#account-activity-api-reference-index)に記載されています。

追加情報については、Enterprise Account Activity API を始める際に役立つ XDev の[サンプル Web アプリとヘルパースクリプト](https://github.com/xdevplatform/account-activity-dashboard-enterprise)を参照してください。

<Note>
  **Please note**: 

  API を使用開始する前に、X が開発者 App に対して Account Activity API へのアクセスを有効化する必要があります。そのため、認証に使用する予定の App ID をアカウントマネージャーまたはテクニカルサポートチームと共有してください。
</Note>

[Account Activity API](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity) は、単一の接続で、購読しているすべてのアカウントのリアルタイムなアカウントアクティビティを受信するためのユーザー購読を作成・管理できるエンドポイント群で構成されています。

Account Activity API では 2 つの認証方式（[OAuth 1.0a](/ja/resources/fundamentals/authentication#oauth-1-0a-2) と [OAuth 2.0 Bearer Token](/ja/resources/fundamentals/authentication#oauth-2-0)）が利用可能です。使用する認証方式は、利用するエンドポイントによって異なります。

|     |     |     |     |
| :--- | :--- | :--- | :--- |
| **説明** | **エンドポイント** | OAuth 1.0a  <br />(ユーザーコンテキスト) | OAuth 2.0 ベアラートークン（アプリケーション専用） |
| 指定されたアプリケーションコンテキストに新しい webhook URL を登録する | [POST account\_activity/webhooks](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks) | ✓   |     |
| 指定されたアプリケーションのすべての URL とそのステータスを返す | [GET account\_activity/webhooks](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks) |     | ✓   |
| 指定の webhook の URL に対して CRC（チャレンジレスポンスチェック）を実行する | [PUT account\_activity/webhooks/:webhook\_id](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#put-account-activity-webhooks-webhook-id) | ✓   |     |
| アプリケーションをユーザーのアカウントイベントに登録（サブスクライブ）する | [POST account\_activity/webhooks/:webhook\_id/subscriptions/all](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks-webhook-id-subscriptions-all) | ✓ \* |     |
| 現在アクティブなサブスクリプション数を返す | [GET account\_activity/subscriptions/count](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-subscriptions-count) |     | ✓   |
| webhook 構成がユーザーのイベントにサブスクライブされているか確認する | [GET account\_activity/webhooks/:webhook\_id/subscriptions/all](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks-webhook-id-subscriptions-all) | ✓ \* |     |
| 現在アクティブなサブスクリプションの一覧を返す | [GET account\_activity/webhooks/:webhook\_id/subscriptions/all/list](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks-webhook-id-subscriptions-all-list) |     | ✓   |
| webhook を削除する | [DELETE account\_activity/webhooks/:webhook\_id](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id) | ✓   |     |
| \[非推奨] 指定のユーザーコンテキストとアプリケーションのサブスクリプションを無効化する | [DELETE account\_activity/webhooks/:webhook\_id/subscriptions/all](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id-subscriptions-all-deprecated) | ✓ \* |     |
| アプリケーション専用 OAuth を使用してサブスクリプションを無効化する | [DELETE /account\_activity/webhooks/:webhook\_id/subscriptions/:user\_id/all.json](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id-subscriptions-user-id-all-json) |     | ✓   |
| アクティビティを webhook に再配信する | [POST /1.1/account\_activity/replay/webhooks/:webhook\_id/subscriptions/all.json](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#replay-api) |     | ✓   |

\*\_ 認証には、サブスクライブ対象ユーザーのアクセストークンが必要です。 \_

OAuth 1.0a のユーザーコンテキスト認証が必要なエンドポイントでは、リクエストの認証に以下のクレデンシャルを提供する必要があります。

- コンシューマーキー（API Key と Secret）
- アクセストークン（Access Token と Secret）

次の3つのエンドポイントでは、アプリケーションのコンテキストで書き込み操作を行います（X のユーザーは関与しません）。したがって、提供すべきアクセストークンはあなたの開発者向け App のものです。これらは [developer portal](https://developer.x.com/en/portal/projects-and-apps) の該当 App の “Keys and tokens” タブから直接生成できます。  

- [POST account\_activity/webhooks](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks): 指定のアプリケーションコンテキスト用に新しい webhook URL を登録する
- [PUT account\_activity/webhooks/:webhook\_id](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#put-account-activity-webhooks-webhook-id): 指定の webhook の URL に対して CRC（チャレンジレスポンスチェック）を実行する
- [DELETE account\_activity/webhooks/:webhook\_id](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id): webhook を削除する

一方、次の3つのエンドポイントでは、アプリケーションが X ユーザー（例：ダイレクトメッセージ）の保護対象データに、そのユーザーに代わってアクセスします。したがって、該当する購読ユーザーに紐づくアクセス・トークンを必ず提供してください。必要なアクセス・トークンは 3-legged OAuth フローで取得できます（[OAuth 1.0a: ユーザーの Access Tokens の取得方法](/ja/resources/fundamentals/authentication#obtaining-access-tokens-using-3-legged-oauth-flow) を参照）。これらのエンドポイントは上表でアスタリスク（\*）付きで示されています。

- [POST account\_activity/webhooks/:webhook\_id/subscriptions/all](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks-webhook-id-subscriptions-all): アプリケーションをユーザーのアカウントイベントに購読させる
- [GET account\_activity/webhooks/:webhook\_id/subscriptions/all](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks-webhook-id-subscriptions-all): webhook 構成がユーザーのイベントを購読しているか確認する
- [DELETE account\_activity/webhooks/:webhook\_id/subscriptions/all](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id-subscriptions-all-deprecated): 指定のユーザーコンテキストとアプリケーションのサブスクリプションを無効化する［非推奨］

<Note>
  **ご注意**: 

  開発者アプリが「Read, Write, and Direct Messages」を有効化していることを確認してください。この設定は、開発者アカウントの [Projects & Apps セクション](https://developer.x.com/en/portal/projects-and-apps) の該当アプリの “App permissions” で変更できます。権限を変更した後は、アプリの認証情報を再生成する必要があります。
</Note>

Account Activity API で利用可能なすべてのエンドポイントの一覧（説明および認証実装例付きの cURL サンプルリクエストを含む）は、[API リファレンスドキュメント](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#account-activity-api-reference-index)にあります。

詳細については、Enterprise Account Activity API の導入に役立つ XDev の[サンプル Web アプリとヘルパースクリプト](https://github.com/xdevplatform/account-activity-dashboard-enterprise)をご覧ください。

## 再試行

`Enterprise`

Account Activity API のエンタープライズ階層の利点のひとつに、Webhook イベント向けの再試行メカニズムがあります。200（成功）HTTP レスポンスコードが受信されない場合、X サーバーは再試行を開始し、5 分間に最大 3 回まで Webhook イベントを再送します。この Webhook イベントの再試行機能は、ネットワーク障害の発生時や、クライアント側のサービス中断・デプロイ時に、信頼性の向上とイベントのリカバリに寄与します。
 

### リトライとは？

Account Activity API では、クライアントの Web アプリがアカウントアクティビティの webhook イベントに対して「成功」を示す 200 応答を返さない場合に、リトライ機能を提供します。クライアント側がイベントの受領成功を確認しない場合、X はイベントが受信されなかったと見なします。非 200 の応答が返された場合、3 秒以内に応答がない場合、またはまったく応答がない場合は、リクエストを再試行し、その接続を 3 秒間開いたままにします。これは、当社があなたの webhook URL に送信しようとしているアクティビティに応答するために、2 回の試行で合計おおよそ 5 秒があることを意味します。サーバーが応答しない、または一時的なエラーを返す場合には、5 分間リトライを行います。検証の確認のためのリトライ試行は合計で 3 回行われます。これにより冗長性が確保され、すべての webhook イベントを受信できるよう担保します。リトライが発生している購読については、購読中のすべてのユーザーの任意／すべてのアクティビティに対して、リトライされたイベントが配信される点に注意してください。

これら 8 回の試行内に検証を確認できない場合、当該アクティビティは Account Activity API 経由では利用できなくなります。 

<div id="what-are-retries">
  ### 再試行タイムライン
</div>

Account Activity API は、200 応答が受信されるまでの 5 分間に最大 3 回再試行します。詳細は以下の表をご参照ください。約 5 分を経過すると、Account Activity API を通じてアクティビティを再送することはできません。取り逃したデータを収集するには、他の X のエンドポイントを使用する必要があります。たとえば、[search APIs](/ja/x-api/enterprise-gnip-2.0/fundamentals/search-api) を使用して、関連する投稿、リポスト、引用ポスト、メンション、返信を取得できます。見逃したダイレクトメッセージは [こちらのエンドポイント](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/list-events) で取得できます。

#### リトライのタイムライン

|     |
| :--- |
| アクティビティが作成され、Account Activity API が webhook URL に POST しますが、3秒でタイムアウトします。 |
| 直前のタイムアウトが完了してから3秒待機し、Account Activity API が webhook URL に POST しますが、3秒でタイムアウトします。 |
| 直前のタイムアウトが完了してから27秒待機し、Account Activity API が webhook URL に POST しますが、3秒でタイムアウトします。 |
| 直前のタイムアウトが完了してから242秒待機し、Account Activity API が webhook URL に POST しますが、3秒でタイムアウトします。 |
| これ以降、Account Activity API は POST を試行しません。クライアントはデータ復旧のために他の X のエンドポイントを使用する必要があります。 |

## アカウントアクティビティのデータオブジェクト構造

| オブジェクト | 詳細 |
| :--- | :--- |
| for\_user\_id | イベントが関連する、購読中のユーザーサブスクリプションを識別します。 |
| is\_blocked\_by | （条件付き）他のユーザーが購読ユーザーをメンションした場合にのみ表示。投稿のメンションイベントで true のときに含まれます。 |
| source | アクティビティを実行しているユーザー。たとえば、フォロー・ブロック・ミュートをしている側のユーザーが source です。 |
| target | アクティビティの対象となるユーザー。たとえば、フォロー・ブロック・ミュートされている側のユーザーが target です。 |

**利用可能なアクティビティ**

| メッセージタイプ | 詳細 |
| :--- | :--- |
| [tweet\_create\_events](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#tweet-create-events-posts-retweets-replies-quotetweets) | 購読ユーザーが行う、または購読ユーザーに対して行われる次のアクションに関する投稿ステータスのペイロード：投稿、リツイート、返信、@メンション、引用ツイート、引用ツイートのリツイート。 |
| [favorite\_events](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#favorite-events) | ユーザーと対象を含む「いいね」イベントのステータス。 |
| [follow\_events](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#follow-events) | ユーザーと対象を含むフォローイベント。 |
| [unfollow\_events](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#unfollow-events) | ユーザーと対象を含むフォロー解除イベント。 |
| [block\_events](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#block-events) | ユーザーと対象を含むブロックイベント。 |
| [unblock\_events](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#unblock-events) | ユーザーと対象を含むブロック解除イベント。 |
| [mute\_events](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#mute-events) | ユーザーと対象を含むミュートイベント。 |
| [unmute\_events](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#unmute-events) | ユーザーと対象を含むミュート解除イベント。 |
| [user\_event](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#user-event) | ユーザーがアプリケーションの認可を取り消し、サブスクリプションが自動的に削除された際に送信される失効イベント。 |
| [direct\_message\_events](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#direct-message-events) | ダイレクトメッセージの送受信時に、ユーザーと対象を含むダイレクトメッセージのステータス。 |
| [direct\_message\_indicate\_typing\_events](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#direct-message-indicate-typing-events) | ユーザーと対象を含むダイレクトメッセージの入力中イベント。 |
| [direct\_message\_mark\_read\_events](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#direct-message-mark-read-events) | ユーザーと対象を含むダイレクトメッセージの既読イベント。 |
| [tweet\_delete\_events](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#tweet-delete-events) | コンプライアンス維持を容易にするための、削除された投稿の通知。 |

**ペイロードの例**

上記の表で説明した各アカウントアクティビティイベントのペイロード例を以下に示します。

#### tweet\_create\_events（投稿、リポスト、返信、引用） 

```
{
	"for_user_id": "2244994945",
	"tweet_create_events": [
	  {
		<Tweet Object>
	  }
	]
}
```

#### tweet\_create\_events（@メンション）

```
{
	"for_user_id": "2244994945",
	"user_has_blocked": "false",
	"tweet_create_events": [
	  {
		<Tweet Object>
	  }
	]
}
```

#### favorite\_events

```
{
	"for_user_id": "2244994945",
	"favorite_events": [{
		"id": "a7ba59eab0bfcba386f7acedac279542",
		"created_at": "Mon Mar 26 16:33:26 +0000 2018",
		"timestamp_ms": 1522082006140,
		"favorited_status": {
			<Tweet Object>
		},
		"user": {
			<User Object>
		}
	}]
}
```

#### follow\_events

```
{
	"for_user_id": "2244994945",
	"follow_events": [{
			"type": "follow",
			"created_timestamp": "1517588749178",
			"target": {
				<User Object>
			},
			"source": {
				<User Object>
			}
		]
	}
}
```

#### unfollow\_events

```
{
	"for_user_id": "2244994945",
	"follow_events": [{
			"type": "unfollow",
			"created_timestamp": "1517588749178",
			"target": {
				<User Object >
			},
			"source": {
				< User Object >
			}
		]
	}
}
```

#### block\_events

```
{
	"for_user_id": "2244994945",
	"block_events": [{
		"type": "block",
		"created_timestamp": "1518127020304",
		"source": {
			<User Object>
		},
		"target": {
			<User Object>
		}
	}]
}
```

#### unblock\_events

```
{
	"for_user_id": "2244994945",
	"block_events": [{
		"type": "unblock",
		"created_timestamp": "1518127020304",
		"source": {
			<User Object>
		},
		"target": {
			<User Object>
		}
	}]
}
```

#### mute\_events

```
{
	"for_user_id": "2244994945",
	"mute_events": [
		{
			"type": "mute",
		  	"created_timestamp": "1518127020304",
			"source": {
				<User Object>
			},
			"target": {
				<User Object>
			}
		}
	]
}
```

#### unmute\_events

```
{
	"for_user_id": "2244994945",
	"mute_events": [
		{
			"type": "unmute",
		  	"created_timestamp": "1518127020304",
			"source": {
				<User Object>
			},
			"target": {
				<User Object>
			}
		}
	]
}
```

#### user\_event

```
{
	"user_event": {
		"revoke": {
			"date_time": "2018-05-24T09:48:12+00:00",
			"target": {
				"app_id": "13090192"
			},
			"source": {
				"user_id": "63046977"
			}
		}
	}
}
```

#### direct\_message\_events

```
{
  	"for_user_id": "4337869213",
	"direct_message_events": [{
		"type": "message_create",
		"id": "954491830116155396",
		"created_timestamp": "1516403560557",
		"message_create": {
			"target": {
				"recipient_id": "4337869213"
			},
			"sender_id": "3001969357",
			"source_app_id": "13090192",
			"message_data": {
				"text": "Hello World!",
				"entities": {
					"hashtags": [],
					"symbols": [],
					"user_mentions": [],
					"urls": []
				}
			}
		}
	}],
	"apps": {
		"13090192": {
			"id": "13090192",
			"name": "FuriousCamperTestApp1",
			"url": "https://x.com/furiouscamper"
		},
		"users": {},
		"3001969357": {
			"id": "3001969357",
			"created_timestamp": "1422556069340",
			"name": "Jordan Brinks",
			"screen_name": "furiouscamper",
			"location": "Boulder, CO",
			"description": "Alter Ego - X PE opinions-are-my-own",
			"url": "https://t.co/SnxaA15ZuY",
			"protected": false,
			"verified": false,
			"followers_count": 22,
			"friends_count": 45,
			"statuses_count": 494,
			"profile_image_url": "null",
			"profile_image_url_https": "https://pbs.twimg.com/profile_images/851526626785480705/cW4WTi7C_normal.jpg"
		},
		"4337869213": {
			"id": "4337869213",
			"created_timestamp": "1448312972328",
			"name": "Harrison Test",
			"screen_name": "Harris_0ff",
			"location": "Burlington, MA",
			"protected": false,
			"verified": false,
			"followers_count": 8,
			"friends_count": 8,
			"profile_image_url": "null",
			"statuses_count": 240,
			"profile_image_url_https": "https://abs.twimg.com/sticky/default_profile_images/default_profile_normal.png"
		}
	}
}
```

#### direct\_message\_indicate\_typing\_events

```
{
	"for_user_id": "4337869213",
	"direct_message_indicate_typing_events": [{
		"created_timestamp": "1518127183443",
		"sender_id": "3284025577",
		"target": {
			"recipient_id": "3001969357"
		}
	}],
	"users": {
		"3001969357": {
			"id": "3001969357",
			"created_timestamp": "1422556069340",
			"name": "Jordan Brinks",
			"screen_name": "furiouscamper",
			"location": "Boulder, CO",
			"description": "Alter Ego - X PE opinions-are-my-own",
			"url": "https://t.co/SnxaA15ZuY",
			"protected": false,
			"verified": false,
			"followers_count": 23,
			"friends_count": 47,
			"statuses_count": 509,
			"profile_image_url": "null",
			"profile_image_url_https": "https://pbs.twimg.com/profile_images/851526626785480705/cW4WTi7C_normal.jpg"
		},
		"3284025577": {
			"id": "3284025577",
			"created_timestamp": "1437281176085",
			"name": "Bogus Bogart",
			"screen_name": "bogusbogart",
			"protected": true,
			"verified": false,
			"followers_count": 1,
			"friends_count": 4,
			"statuses_count": 35,
			"profile_image_url": "null",
			"profile_image_url_https": "https://pbs.twimg.com/profile_images/763383202857779200/ndvZ96mE_normal.jpg"
		}
	}
}
```

#### direct\_message\_mark\_read\_events

```
{
	"for_user_id": "4337869213",
	"direct_message_mark_read_events": [{
		"created_timestamp": "1518452444662",
		"sender_id": "199566737",
		"target": {
			"recipient_id": "3001969357"
		},
		"last_read_event_id": "963085315333238788"
	}],
	"users": {
		"199566737": {
			"id": "199566737",
			"created_timestamp": "1286429788000",
			"name": "Le Braat",
			"screen_name": "LeBraat",
			"location": "Denver, CO",
			"description": "day はデータ、dusk はデザイン（@X）",
			"protected": false,
			"verified": false,
			"followers_count": 299,
			"friends_count": 336,
			"statuses_count": 752,
			"profile_image_url": "null",
			"profile_image_url_https": "https://pbs.twimg.com/profile_images/936652894371119105/YHEozVAg_normal.jpg"
		},
		"3001969357": {
			"id": "3001969357",
			"created_timestamp": "1422556069340",
			"name": "Jordan Brinks",
			"screen_name": "furiouscamper",
			"location": "Boulder, CO",
			"description": "もう一つの顔 - X PE（意見は私個人のものです）",
			"url": "https://t.co/SnxaA15ZuY",
			"protected": false,
			"verified": false,
			"followers_count": 23,
			"friends_count": 48,
			"statuses_count": 510,
			"profile_image_url": "null",
			"profile_image_url_https": "https://pbs.twimg.com/profile_images/851526626785480705/cW4WTi7C_normal.jpg"
		}
	}
}
```

#### tweet\_delete\_events

```
{
    "for_user_id": "930524282358325248",
    "tweet_delete_events": [
{
        "status": {
            "id": "1045405559317569537",
            "user_id": "930524282358325248"
        },
        "timestamp_ms": "1432228155593"
    }
   ]
}
```

## Account Activity Replay API

`Enterprise`

Account Activity Replay API は、最大で過去5日分のイベントを取得できるデータ復旧ツールです。これは、[webhook](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#enterprise-account-activity-api) サーバーがイベントを受信できなかった場合にデータを復旧するために使用します。たとえば、[リトライウィンドウ](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#retries) を超える切断が発生したときや、数日かけてシステムを通常状態に戻す必要があるディザスタリカバリーの状況などです。

Account Activity Replay API は、一定期間にわたり [activities](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity) の取り込みに失敗したあらゆるケースを想定して開発されました。アクティビティは、元のリアルタイム配信で使用したのと同じ webhook に配信されます。本製品はリカバリーツールであり、バックフィルツールではありません。つまり、過去に配信試行が行われたイベントのみ再送されます。Account Activity Replay API は、サブスクリプション作成時刻より前の期間のイベントを配信することはできません。

### Account Activity Replay API の使用

アカウントで Replay 機能が有効化されている場合は、Account Activity API へのリクエストと同様の方法でリクエストできます。重要な点として、どの webhook のアクティビティをリプレイするかを示すために、リクエストで webhook id パラメータを指定する必要があります。言い換えると、Replay リクエストは、webhook id と application id に基づき、開始日時から終了日時までのイベントを取得するように Account Activity Replay API に指示します。

時刻は UTC を前提としています。これらのアクティビティは、指定された id に関連付けられた登録済みの webhook を通じて、最大毎秒 2,500 件のレートで配信されます。また、1 つの webhook につき同時に実行できる Replay ジョブは 1 件のみですが、その webhook で指定した期間中にアクティブだったすべてのサブスクリプションはリプレイされる点にも留意してください。

イベントは、指定した期間の最初（最も古い）1 分から配信が始まり、可能な限り時系列順に最終の 1 分が配信されるまで続きます。その時点で、Replay は webhook に [ジョブ完了イベント](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#job-completed-successfully-message) を配信します。アクティビティは時系列で配信されるため、開始時刻付近で一致する結果がほとんどない、または存在しない場合は、最初の結果が配信されるまでに時間が生じる可能性があります。

<div id="using-account-activity-replay-api">
  ### 制限事項
</div>

Replay は、過去5日分までのアクティビティを簡便に復旧するためのツールとして設計されていますが、サブスクリプションの作成時刻より前のイベントは配信されません。たとえば、3日前に新しいサブスクリプションを追加し、本日から5日前までを対象に Replay ジョブを実行した場合、受け取れるのはその新しいサブスクリプションが有効だった3日分のデータのみです。

<div id="limitations">
  ### データの可用性と種類
</div>

Account Activity Replay API のアクティビティは、リクエスト開始から5日間利用可能で、各アクティビティの作成からおおむね10分後に新しいデータが利用可能になります。リクエストの from\_date および to\_date パラメータを使用して、この5日間の範囲内で期間を指定してリクエストできます。Replay へのアクセスが有効化される前に本来配信されていたイベントはリプレイできません。たとえば、あなたのアカウントで Account Activity Replay API へのアクセスが 2019年6月1日 3:30 PM UTC に有効化された場合、その日時より前のイベントを Replay で取得することはできません。

[Account Activity Replay API リファレンス](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id-subscriptions-all-deprecated)に進む

## 移行の概要

**Site Streams、User Streams、および Account Activity API - DM Only の標準ベータ版は 2018 年に提供終了しました。これらの製品をご利用中だった場合は、Account Activity API のプレミアム版またはエンタープライズ版へ移行してください。**

**レガシーの Direct Message エンドポイントも提供終了しました。これらのエンドポイントをご利用中だった場合は、新しい DM エンドポイント、または Account Activity API のプレミアム版もしくはエンタープライズ版へ移行してください。**

**詳細については[このお知らせ](https://devcommunity.x.com/t/details-and-what-to-expect-from-the-api-deprecations-this-week-on-august-16-2018/110746)をご確認ください。**

以下のエンドポイントがこれらの変更の影響を受けます：

- User Streams
- Site Streams
- GET direct\_messages
- GET direct\_messages/sent
- GET direct\_messages/show
- POST direct\_messages/new
- POST direct\_messages/destroy
   

同様のアクセスを提供し、Direct Message については追加機能も備えた新しいエンドポイントとサービスを提供しています：

- Account Activity API [enterprise](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#enterprise-account-activity-api) および [premium](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#account-activity-api-reference-index)
- [GET direct\_messages/events/list](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/list-events)
- [GET direct\_messages/events/show](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/get-event)
- [POST direct\_messages/events/new](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/new-event)
- [POST direct\_messages/events/destroy](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/delete-message-event)

これらの新しいエンドポイントとサービスへ円滑に移行できるよう、次の 2 つの移行ガイドをご用意しています：

- User Streams および Site Streams から新しい webhook ベースのサービスへ移行する方向けの[Account Activity API 移行ガイド](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#migration-guide-moving-from-user-streams-site-streams-to-account-activity-api)
- Direct Message の REST エンドポイント間を移行する方向けの[Direct Message 移行ガイド](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/guides/direct-message-migration)
   

さらに、Account Activity API とその始め方について解説する[動画シリーズ](https://www.youtube.com/playlist?list=PLFKjcMIU2WshGG6Yj940XM7Z6BFs1zfBg)も用意しています。

最後に、理解を深め、迅速に着手するためのコードサンプルもご用意しています：

- [Account Activity Dashboard](https://github.com/xdevplatform/Account-Activity-dashboard) は、Account Activity API を始めるためのヘルパースクリプト付きサンプル Node.js Web アプリです。
- [SnowBot](https://github.com/xdevplatform/SnowBotDev) は、Account Activity API と REST の Direct Message エンドポイントを使用したサンプルのチャットボットです。Ruby で実装され、Sinatra Web アプリフレームワークを使用し、Heroku にデプロイされています。

<div id="migration-introduction">
  ## 移行ガイド：User Streams／Site Streams から Account Activity API への移行
</div>

**2018年8月23日をもって、Site Streams と User Streams は提供を終了しました。必ず Account Activity API へ移行してください。**

**詳細は[こちらのお知らせ](https://devcommunity.x.com/t/details-and-what-to-expect-from-the-api-deprecations-this-week-on-august-16-2018/110746)をご確認ください。**

本ガイドは、レガシーの User Streams および Site Streams API から、後継となる Account Activity API への移行を支援するためのものです。以下に、変更点の要約、新機能の一覧、ならびに移行時の主な相違点と考慮事項を示します。基本的な DM エンドポイントからの移行に関するガイダンスは、[ダイレクトメッセージ移行ガイド](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/guides/direct-message-migration)を参照してください。

### 変更点の概要

Account Activity API は、User Streams や Site Streams のようなストリーミング接続ではなく、Webhook を通じて認証済みかつサブスクライブ済みアカウント向けのイベントを配信します。

#### 廃止予定の API

GET user

GET site（以下のコントロールストリームを含む: GET site/c/:stream\_id、GET site/c/:stream\_id/info.json、GET site/c/:stream\_id/friends/ids.json、POST site/c/:stream\_id/add\_user.json、POST /site/c/:stream\_id/remove\_user.json）

<div id="deprecated-apis">
  #### 代替 API
</div>

[Enterprise Account Activity API - 全アクティビティ](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#enterprise-account-activity-api)

### 違いと移行時の考慮事項

**API 形式：** 新しい Account Activity API は、User Streams や Site Streams とは動作が異なります。データを webhook で受信できるように Web アプリを変更する必要があります。webhook の詳細は[こちら](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#getting-started-with-webhooks)をご覧ください。

**利用可能なデータ：** もう一つの大きな違いは、配信されるデータの内容です。X は今後、X 上であなたがフォローしているユーザーからのイベント（いわゆるホームタイムライン）の送信を行いません。これは意図的な変更であり、今後も変更する予定はありません。

**信頼性：** ストリーミングと異なり、webhook では配信の確認が可能で、webhook URL に到達しなかった POST 済みアクティビティの再試行も行えます。これにより、短時間の切断やダウンタイムがあっても、アプリが該当するすべてのアクティビティを受信できているという確実性が高まります。

<div id="differences-migration-considerations">
  ### 新機能
</div>

Account Activity API には多くの新機能があり、なかでもデータがストリーミングではなく Webhook で配信される点が大きな変更です。Webhook にはストリーミングに比べて多くの利点がありますが、とりわけ速度と信頼性が優れています。API はデータを、利用可能になり次第 JSON のイベントとして送信するため、アクティブな接続の維持やエンドポイントのポーリングは不要です。これにより冗長化機能の必要性が抑えられ、全体としての効率が向上します。Webhook の詳細については、[技術ドキュメント](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#getting-started-with-webhooks)をご参照ください。

<div id="new-features">
  ### ユーザー購読の管理
</div>

Account Activity API は、1 つの登録済み webhook に対して複数の購読を許可します。これにより、Site Streams のアーキテクチャに類似する形で、webhook を通じて複数のユーザー購読のアクティビティを同一のエンドポイントに配信できます。つまり、購読上限に関わる購読数の管理を、webhook 接続とは切り離して追跡できます。さらに、単一の webhook で、少数の購読から数千規模までスケールできます。

<div id="managing-user-subscriptions">
  ### **移行手順**
</div>

<div id="how-to-migrate">
  ### **以下の手順に従って、Site Streams API から Account Activity API へスムーズに移行する**
</div>

**ステップ 1: パッケージを選定する**

現在の User Streams または Site Streams の運用状況に応じて、Account Activity API の enterprise 版または premium 版への移行を検討してください。現在サポートしているアプリケーション数や認可ユーザー数を考慮し、必要なボリュームと可用性に見合うようにスケールしてください。最適なパッケージを選ぶ際は、次の点を検討してください:

- 必要な webhook の数
- アプリケーションで管理している現在／将来見込みのサブスクリプション数／認可ユーザー数
- 現在の X クライアントアプリケーション数
- 望ましい X のサポートレベル（フォーラムサポート、またはマネージドなエンタープライズ向け 1:1 サポート）
- 各パッケージの価格

**ステップ 2:** **developer portal での X アプリの設定を確認する**

User Streams または Site Streams に現在使用している [X app](/ja/resources/fundamentals/developer-apps) は、[developer portal](/ja/resources/fundamentals/developer-portal) 上で所有ユーザーに表示されます。この X app は、当該アプリケーションの認可ユーザーを維持するために Account Activity API でも使用できます。新しいアプリを作成し、必要に応じてユーザーにこの新しいアプリを再認可してもらうことも可能です。ビジネス用途で新しいアプリを作成する場合は、企業の X の @handle アカウントでアプリを作成することを推奨します。

- X アプリの [permissions](/ja/resources/fundamentals/developer-apps#app-permissions) タブで「Read, Write and Access direct messages」を有効にします。 
  \*これらの設定変更は遡及適用されない点に注意してください。認可済みユーザーは認可時点の設定を保持します。ユーザーがまだ Read、Write、Direct Message アクセスを付与していない場合は、そのユーザーにアプリケーションの再認可を行ってもらう必要があります。
- [X Sign-in](/ja/resources/fundamentals/authentication#log-in-with-x) および X API におけるユーザーコンテキストの仕組みに不慣れな場合は、[Obtaining Access Tokens](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#getting-started-with-webhooks) を確認してください。
- 「Keys and Tokens」タブの下部で、X アプリ所有者のアクセストークンを生成します。同タブで Consumer Key、Consumer Secret、Access Token、Access Token Secret を控えておいてください。API 利用時に必要です。
- [application-only](/ja/resources/fundamentals/authentication#bearer-token-also-known-as-app-only) の API メソッド用に、Consumer Key と Consumer Secret を使用してベアラートークンを生成します。

**ステップ 3: Webhook をセットアップして構成する**

- イベント受信用の webhook として使用するエンドポイントを持つ Web アプリを作成します（例: https://your\_domain.com/webhook/twitter または https://webhooks.your\_domain.com）。

- Webhook を作成する際は、Consumer Key、Consumer Secret、Access Token、Access Token Secret を使用します。エンドポイントは response\_token を含む JSON を返す必要があります。response\_token は、crc\_token とアプリの Consumer Secret から生成された、base64 エンコードの HMAC SHA-256 ハッシュである必要があります。

- [Securing Webhooks](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#securing-webhooks) のドキュメントを確認し、Challenge Response Check（CRC）の要件に特に注意してください。

- Webhook が、受信イベント用の POST リクエストおよび CRC 用の GET リクエストをサポートしていることを確認してください。

- Webhook のレイテンシが低いことを確認してください（POST リクエストへの応答は 3 秒未満）。

**ステップ 4: Webhook セットアップを検証する**

- Webhook API は次の 2 つの方法で webhook を保護します:

               - Webhook の所有者が Web アプリの所有者であることを検証するため、チャレンジレスポンスチェックを要求します。

               - 各 POST リクエストに署名ヘッダーを付与し、Web アプリ側で送信元を検証可能にします。

- あなたが Web アプリと webhook URL の両方の所有者であることを検証するために、X は Challenge Response Check（CRC）を実行します。これは巡回冗長検査（cyclic redundancy check）と混同しないでください。
- パラメータ名 crc\_token を付与した GET リクエストが webhook URL に送信されます。エンドポイントは response\_token を含む JSON レスポンスを返す必要があり、response\_token は crc\_token とアプリの Consumer Secret から生成された、base64 エンコードの HMAC SHA-256 ハッシュである必要があります。
- crc\_token は受信する各 CRC リクエストごとに変化すると想定してください。計算では、crc\_token をメッセージ、Consumer Secret をキーとして使用してください。
- レスポンスが無効な場合、登録された webhook へのイベント送信は停止します。

**ステップ 5: 各 User Stream または Site Streams の認可ユーザーに対してサブスクリプションを作成する**

User Streams から Account Activity API へ移行する場合:

- User Streams 上で現在のユーザーサブスクリプションの一覧を取得する
- リクエスト：  _POST account\_activity/all/:env\_name/subscriptions_ を使用して新しい Account Activity API のサブスクリプションを設定する
- リクエスト：  _GET account\_activity/all/:env\_name/subscriptions/list_ を使用して Account Activity API のサブスクリプションを確認する

Site Streams から Account Activity API への移行（コントロールストリーム使用）：

- リクエスト：  _GET /1.1/site/c/:stream\_id/info.json_ を使用して Site Streams 上の現在のサブスクリプションの一覧を取得する
- リクエスト：  _POST account\_activity/all/:env\_name/subscriptions_ を使用して新しい Account Activity API のサブスクリプションを設定する
- リクエスト：  _GET account\_activity/all/:env\_name/subscriptions/list_ を使用して Account Activity API のサブスクリプションを確認する

Webhook の登録とサブスクリプションの作成（Site Streams または User Streams からの移行ではない場合）

- アプリで [POST webhooks](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#enterprise-account-activity-api) を使用して webhook URL を登録し、webhook\_id を受け取る。
- 返却された webhook\_id を使用して [POST webhooks/:webhook\_id/subscriptions/all](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks-webhook-id-subscriptions-all) でユーザーサブスクリプションを追加する。

<div id="follow-the-steps-below-to-easily-migrate-from-the-site-streams-api-to-the-account-activity-api">
  ### Account Activity ダッシュボード（Account Activity API サンプルアプリケーション）
</div>

Account Activity API のテストを迅速に行えるよう、サンプルアプリを用意しました。   

- Account Activity Dashboard のサンプルアプリケーションを[こちら](https://github.com/xdevplatform/Account-Activity-dashboard)からダウンロードしてください（Node.js 使用）
- README の手順に従ってアプリをインストールし、起動してください
- アプリケーションを起動したら、UI を使って簡単に webhook を設定し、新しいサブスクリプションを作成できます

<div id="the-account-activity-dashboard-sample-account-activity-api-application">
  ### 利用可能なアクティビティ
</div>

| メッセージタイプ | 詳細 |
| :--- | :--- |
| [tweet\_create\_events](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#tweet-create-events-posts-retweets-replies-quotetweets) | サブスクリプションユーザーが実行した、または対象となった以下のアクション時に送信される投稿ステータスのペイロード：投稿、リツイート、返信、@メンション、引用投稿 |
| [favorite\_events](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#favorite-events) | ユーザーと対象を含む「いいね」イベントのステータス。 |
| [follow\_events](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#follow-events) | ユーザーと対象を含むフォローイベント。 |
| [block\_events](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#block-events) | ユーザーと対象を含むブロックイベント。 |
| [mute\_events](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#mute-events) | ユーザーと対象を含むミュートイベント。 |
| [direct\_message\_events](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#direct-message-events) | ユーザーと対象を含むダイレクトメッセージのステータス。 |
| [direct\_message\_indicate\_typing\_events](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#direct-message-indicate-typing-events) | ユーザーと対象を含むダイレクトメッセージの入力中イベント。 |
| [direct\_message\_mark\_read\_events](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#direct-message-mark-read-events) | ユーザーと対象を含むダイレクトメッセージの既読イベント。 |

### 非推奨となったストリーミングメッセージタイプ 

|     |     |
| :--- | :--- |
| 空行 | 空行は User Streams と Site Streams でキープアライブメッセージとして使用されていましたが、Account Activity API では今後配信されません。 |
| 制限通知 | 制限通知は特定の webhook には送信されません。代わりに、利用可能なハンドルの現在の使用状況は API を呼び出して取得できます。これは将来的に開発者ポータルにも追加される予定です。 |
| 切断メッセージ | webhook はアクティブな接続に依存しないため、切断通知は不要です。 |
| ストール警告 | webhook は多数の受信メッセージを処理するためのアクティブな接続に依存しないため、ストール警告は不要です。 |
| フレンドリスト | フレンドリストは今後プッシュ配信されません。代わりに、この情報を取得するための REST エンドポイントが提供されます。 |

<div id="deprecated-streaming-message-types">
  ### 非推奨のイベントタイプ
</div>

|     |     |     |     |     |
| :--- | :--- | :--- | :--- | :--- |
| **説明** | **イベント名** | **ソース** | **ターゲット** | **ターゲットオブジェクト** |
| ユーザーが投稿を削除 | delete | 現在のユーザー | 現在のユーザー | 投稿 |
| フォロー中のユーザーが投稿を削除 | delete | フォロー中のユーザー | フォロー中のユーザー | 投稿 |
| ユーザーが投稿のお気に入りを解除 | unfavorite | 現在のユーザー | 投稿の作成者 | 投稿 |
| ユーザーの投稿がお気に入り解除される | unfavorite | お気に入り解除したユーザー | 現在のユーザー | 投稿 |
| ユーザーが誰かのフォローを解除 | unfollow | 現在のユーザー | フォローしていたユーザー | Null |
| ユーザーがリストを作成 | list\_created | 現在のユーザー | 現在のユーザー | リスト |
| ユーザーがリストを削除 | list\_destroyed | 現在のユーザー | 現在のユーザー | リスト |
| ユーザーがリストを編集 | list\_updated | 現在のユーザー | 現在のユーザー | リスト |
| ユーザーが誰かをリストに追加 | list\_member\_added | 現在のユーザー | 追加されたユーザー | リスト |
| ユーザーがリストに追加される | list\_member\_added | 追加したユーザー | 現在のユーザー | リスト |
| ユーザーが誰かをリストから削除 | list\_member\_removed | 現在のユーザー | 削除されたユーザー | リスト |
| ユーザーがリストから削除される | list\_member\_removed | 削除したユーザー | 現在のユーザー | リスト |
| ユーザーがリストを購読 | list\_user\_subscribed | 現在のユーザー | リスト所有者 | リスト |
| ユーザーのリストが購読される | list\_user\_subscribed | 購読したユーザー | 現在のユーザー | リスト |
| ユーザーがリストの購読を解除 | list\_user\_unsubscribed | 現在のユーザー | リスト所有者 | リスト |
| ユーザーのリストの購読が解除される | list\_user\_unsubscribed | 購読解除したユーザー | 現在のユーザー | リスト |
| ユーザーがプロフィールを更新 | user\_update | 現在のユーザー | 現在のユーザー | Null |
| ユーザーが保護ステータスを更新 | user\_update | 現在のユーザー | 現在のユーザー | Null |

## ダイレクトメッセージ移行ガイド

**2018年9月17日、旧ダイレクトメッセージエンドポイントは提供終了しました。
これらのエンドポイントを利用していた場合は、新しいダイレクトメッセージエンドポイントまたは Account Activity API へ必ず移行してください。**

**詳しくは [この告知](https://devcommunity.x.com//t/details-and-what-to-expect-from-the-api-deprecations-this-week-on-august-16-2018/110746) をご確認ください。**

本ガイドは、レガシーのダイレクトメッセージ REST API から、ベータ期間を終了した強化版への移行を支援するためのものです。以下に、変更点の概要、新機能一覧、移行時の主な相違点と考慮事項をまとめました。新しいダイレクトメッセージエンドポイントは、すべての開発者が現在利用可能です。User Streams または Site Streams からの移行に関するガイダンスは、[Account Activity API への移行ガイド](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#migration-guide-moving-from-user-streams-site-streams-to-account-activity-api)をご参照ください。

- [変更点の概要](#summary)
- [新機能](#features)
- [ダイレクトメッセージの送信](#sending)
- [ダイレクトメッセージの受信](#receiving)
- [ダイレクトメッセージの削除](#deleting)

### 変更点の概要

以下の DM エンドポイントを引き続き使用している場合は、新しいエンドポイントへ移行する必要があります。

| 廃止予定のエンドポイント | 移行先 |
| :--- | :--- |
| [POST direct\_messages/new](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/new-event) | [POST direct\_messages/events/new](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/new-event) |
| [GET direct\_messages/show](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/get-event) | [GET direct\_messages/events/show](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/get-event) |
| [GET direct\_messages](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/list-events) | [GET direct\_messages/events/list](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/list-events) |
| [GET direct\_messages/sent](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/get-event) | [GET direct\_messages/events/list](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/list-events) |
| [POST direct\_messages/destroy](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/delete-message-event) | [DELETE direct\_messages/events/destroy](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/delete-message-event "GET direct_messages/events/list") |

<div id="differences-migration-considerations">
  ### 新機能
</div>

新しい Direct Message API エンドポイントは、複数の新機能に対応し、過去の Direct Message へのアクセスも改善されています。新機能には以下が含まれます。

- メディア（画像、GIF、動画）の添付に対応。
- 事前定義の選択肢リストで、ユーザーに構造化された返信を促す機能。
- 過去の Direct Message を最大30日分まで取得可能。

新しい Direct Message 機能の一覧および追加の新規 API エンドポイントについては、[技術ドキュメント](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/overview)を参照してください。
 

<div id="new-features">
  ### 相違点と移行時の考慮事項
</div>

新しい API エンドポイントは、従来のエンドポイントとは大きく異なる挙動をします。エンドポイントの URL をただ更新するだけでは、アプリケーションでエラーが発生します。移行に向けてアプリケーションを更新する際は、以下の点を考慮してください。

#### 新しいダイレクトメッセージオブジェクト

まず目につくのは、ダイレクトメッセージの新しいオブジェクト構造です。この新しい Message Create オブジェクト構造は、[Quick Replies](https://developer.x.com/en/docs/x-api/v1/direct-messages/quick-replies/overview) や [Attachments](https://developer.x.com/en/docs/x-api/v1/direct-messages/message-attachments/overview) などの新機能をサポートするために導入されました。新しいオブジェクトには、より小さく要約されたユーザーオブジェクトも含まれます。アプリケーションは、この新しいオブジェクト構造に対応するため、パース時に加え、データモデルやストレージも更新する必要があります。各プロパティの説明は、[Message Create Object の完全なドキュメント](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/guides/message-create-object)を参照してください。

**メッセージ作成オブジェクトの例**

```json
{
      "type": "message_create",
      "id": "1234858592",
      "created_timestamp": "1392078023603",
      "initiated_via": {
        "tweet_id": "123456",
        "welcome_message_id": "456789"
      },
      "message_create": {
        "target": {
          "recipient_id": "1234858592"
        },
        "sender_id": "3805104374",
        "source_app_id": "268278",
        "message_data": {
          "text": "Blue Bird",
          "entities": {
            "hashtags": [],
            "symbols": [],
            "urls": [],
            "user_mentions": []
          },
          "quick_reply_response": {
            "type": "options",
            "metadata": "external_id_2"
          },
          "attachment": {
            "type": "media",
            "media": {
             ...
            }
          }
        }
      }
```

<div id="new-direct-message-object">
  #### 概要
</div>

- ダイレクトメッセージオブジェクトの構造を全面刷新。
- ユーザーオブジェクトを凝縮。
- 新たな情報を提供（クイックリプライの応答、添付ファイルなど）。

### ダイレクトメッセージの送信

[POST direct\_messages/events/new](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/new-event) は、ダイレクトメッセージ送信のための置き換え用エンドポイントです。 このエンドポイントの最も大きな違いは、すべての情報が個別の POST パラメータではなく、POST リクエストの本文で JSON として送信される点です。

**Twurl リクエスト例**

```bash
twurl -A 'Content-type: application/json' -X POST /1.1/direct_messages/events/new.json -d '{"event": {"type": "message_create", "message_create": {"target": {"recipient_id": "4534871"}, "message_data": {"text": "Hello World!"}}}}'
```

上記のリクエストでは、Content-Type が application/x-www-form-urlencoded ではなく application/json に設定されている点に注意してください。 また、OAuth 1.0a の署名を作成する場合、署名の生成には JSON 本文は含まれないことにも注意してください。 ほとんどの OAuth ライブラリは既にこの点を考慮しています。 [twurl](https://github.com/twitter/twurl) を使用する場合は、少なくともバージョン 0.9.3 を使用していることを確認してください。

#### まとめ

- メッセージは JSON の POST ボディで定義します
- Content-Type ヘッダーは application/json に設定する必要があります
- JSON ボディは OAuth 署名の生成には含まれません
   

### ダイレクトメッセージの取得

過去のダイレクトメッセージの取得は、単一の API エンドポイント [GET direct\_messages/events/list](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/list-events) で行えるようになりました。この新しいエンドポイントの大きな変更点は、送信・受信の両方のメッセージを新しいものから順に返すことです。これにより会話の再構築が容易になります。ただし、送信のみ、または受信のみを取得したい場合は、`sender_id` プロパティを参照してレスポンスを後処理する必要があります。

ページネーションは、ダイレクトメッセージの ID ではなくカーソル値に基づく方式になりました。各レスポンスには `cursor` プロパティが含まれます。[GET direct\_messages/events/list](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/list-events) は、過去 30 日間に存在するメッセージ数に関係なく、最大で過去 30 日分のメッセージを返します。カーソルが返されない場合は、取得可能なメッセージがもう存在しないことを意味します。[GET direct\_messages/events/show](https://developer.x.com/en/docs/x-api/v1/direct-messages/sending-and-receiving/api-reference/get-event) による個々のダイレクトメッセージへのアクセス方法は従来どおりですが、返されるダイレクトメッセージオブジェクトの構造は前述のとおり異なります。

最後に、ダイレクトメッセージへのリアルタイムアクセスは、[Account Activity API](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity) の webhook を通じて行います。User Streams または Site Streams からの移行に関するガイダンスは、Account Activity API への移行ガイドをご参照ください。

<div id="new-direct-message-object">
  #### 概要
</div>

- 送信メッセージと受信メッセージが同じエンドポイントから返されるようになりました。
- 最大30日分のメッセージが取得可能です。
- カーソルベースのページネーションに対応。
- Webhook を介してダイレクトメッセージにリアルタイムでアクセス可能。

### ダイレクトメッセージの削除

ダイレクトメッセージは、DELETE direct\_messages/events/destroy で削除できるようになりました。仕様は概ね同じで、削除するメッセージの ID が必要です。主な違いは、このエンドポイントが POST リクエストではなく DELETE リクエストを要求する点です。

削除されたダイレクトメッセージが公式 X クライアントにどのように反映されるかは従来どおりです。ダイレクトメッセージは、指定したユーザーコンテキストのインターフェース上でのみ削除されます。会話の他の参加者は引き続きそのダイレクトメッセージにアクセスできます。

<div id="new-direct-message-object">
  #### 概要
</div>

- ダイレクトメッセージを削除するには ID が必要です。
- 新しいエンドポイントでは DELETE リクエストが必要です。
- 削除されたダイレクトメッセージが公式 X クライアントに反映される方法は従来どおりです。

**新しいダイレクトメッセージエンドポイントへの移行に関してご不明な点はありますか？**
**[devcommunity.com](https://devcommunity.x.com/) の開発者コミュニティフォーラムに質問を投稿してください。**

## よくあるご質問

### 一般

**Account Activity API を使用する利点は何ですか？**

Account Activity API は webhook を使用します。つまり、ストリーミング API と異なり、こちらから情報を送るためにオープンな接続を維持しておく必要がありません。Webhook は REST API とも異なり、関心のあるデータを得るために 15 分ごとに何百回もポーリングする必要がありません。イベント発生時にデータを配信するため、ユーザーとアプリ間のやり取りが効率化されます。

Account Activity API には次の利点があります。

1. **速度**: X のスピードでデータを配信します。
2. **シンプルさ**: 単一の webhook 接続で、アカウントのすべてのイベントを配信します。API で配信されるアクティビティには、投稿、@メンション、返信、リポスト、引用投稿、引用投稿のリポスト、いいね、送信済みダイレクトメッセージ、受信ダイレクトメッセージ、フォロー、ブロック、ミュートが含まれます。 
3. **スケール**: イベントのレート制限や上限に縛られず、管理対象アカウントのすべてのアクティビティを受け取れます。

Account Activity API は premium sandbox、premium 有料、enterprise の各オファリングとして提供されており、責任機能や追加機能のためにさらに多くのアカウントが必要になった場合でもスケールできます。

開始するには、[GitHub](https://github.com/xdevplatform/account-activity-dashboard) からサンプルコードスニペットをダウンロードしてください。
 

**自分に最適な製品ティアを見分けるにはどうすればよいですか？**

Premium オプションと Enterprise オプションの違いについては、[Account Activity API Overview](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity) のページをご確認ください。 
 

**Premium 環境と Enterprise webhook の違いは何ですか？**

違いはありません。各 Premium 環境には独自の webhook\_id があります。
 

**Account Activity API 用に開発・ステージング・本番の各環境が必要です。可能ですか？**

はい。有料ティア（有料 Premium および Enterprise）では、複数の webhook URL を登録し、API メソッドを通じて各環境ごとにサブスクリプションを個別に管理できます。さらに、複数のクライアントアプリを allowlist に追加して、現在の承認済みユーザーの認可を維持できます。
 

**Account Activity API のセットアップに関するステップバイステップのガイドはありますか？**

もちろんあります。

- これから始める場合は、[Getting started with webhooks](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#getting-started-with-webhooks) ガイドをご覧ください

- X Dev がサポートするスクリプトもご活用ください: 
  - [Account Activity API dashboard](https://github.com/xdevplatform/account-activity-dashboard) — webhook イベントを表示する Node の Web アプリ。
  - [SnowBot chatbot](https://github.com/xdevplatform/SnowBotDev) — Account Activity と Direct Message API を用いて構築された Ruby の Web アプリ。このコードベースには、Account Activity API の webhook 設定を支援する[スクリプト](https://github.com/xdevplatform/SnowBotDev/wiki/Account-Activity-API-setup-script)が含まれます。
     

**システムが一定時間ダウンした場合、データを復旧する方法はありますか？**

有料ティア（有料 Premium および Enterprise）では、当社システムが 4 時間の間に複数回、アクティビティの[再試行](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#retries)送信を行います。4 時間以内にシステムが応答しない場合、そのアクティビティは失われ、7 日以内に他の REST エンドポイントを使用してデータを復旧する必要があります。

異なる webhook や環境を、[Account Activity Replay API](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#account-activity-replay-api) のような冗長化ツールとして活用し、いずれかのシステムがダウンしてもアクティビティを取り逃がさないようにすることをお勧めします。
 

**Account Activity API ではどの認証を使用する必要がありますか？**

Account Activity API に必要な認可方法は、[API リファレンスページ](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#account-activity-api-reference-index)の各メソッドに記載されています。X の認証をこれから始める場合は、[このセクション](/ja/resources/fundamentals/authentication)をご覧ください。

**challenge-response check（CRC）とは何ですか？**

Account Activity API のチャレンジレスポンスチェックは、Account Activity API のアクティビティが正しい開発者に送信されていることを保証するためのセキュリティ機能です。受信しているデータが X から送られたものであることを開発者が確認する目的でも使用できます。X は、Webhook URL が最後に検証された時点から 24 時間ごとに自動的に CRC をあなたの webhook URL に送信します。システムは検証状態を維持するため、3 秒以内に有効なレスポンスを返す必要があります。 

詳細は [Securing webhooks](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#securing-webhooks) のページをご覧ください。
 

**Webhook URL が即時に無効化される原因はありますか？**

以下のいずれかが発生した場合、webhook は直ちに無効とマークされます。

- サーバーが CRC に不正なトークンで応答した場合。この場合、当社システムはアクティビティ送信を[再試行](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#retries)しません。
- webhook URL に不正な証明書が設定されている場合。この場合、当社システムはアクティビティ送信を[再試行](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#retries)しません。
- サーバーが 2XX、4XX、5XX 以外のレスポンスコードを返した場合。
- gzip の使用を宣言しているのに、実際には送っていない場合。
- gzip の使用を宣言していないのに、実際にはレスポンスで送っている場合。
   

**相互にやり取りしているユーザーを購読していると、アクティビティが重複しますか？**

はい。Web アプリでユーザー A とユーザー B の購読が有効で、ユーザー A が投稿でユーザー B に言及した場合、登録済みの webhook には 2 件の POST アクティビティが送信されます。各アクティビティには、そのアクティビティがどの購読に属するかを示す "for\_user\_id" が含まれます。
 

**自分の webhook への購読を作成する際、次のエンドポイントの `/all/` 部分を他のアカウントアクティビティのデータオブジェクトに置き換えて、API が配信するアクティビティを限定できますか？**`POST https://api.x.com/1.1/account_activity/all/:env_name/subscriptions.json`

いいえ、できません。現時点では `/all/` 製品のみが利用可能です。
 

**ユーザーから Direct Messages の権限をリクエストせずに Account Activity API を利用できますか？**

現時点では、Direct Messages のアクティビティをこの API から「除外」する手段がないため、Direct Messages の権限が必須です。 
 

**Account Activity API に無料版はありますか？**

はい、無料ティアとして sandbox 版を提供しています。sandbox では Webhook は 1 つ、購読は最大 15 件に制限されます。詳細は[ドキュメント](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity)をご覧ください。 

**購読しているユーザーに言及した投稿の Retweet を、Account Activity API で取得できますか？**

残念ながら、この API が配信するアクティビティには含まれていません。この用途には Streaming API の利用をお勧めします。 
 

**tweet\_create\_event が表す可能性のあるアクティビティタイプは何ですか？**

tweet\_create\_event のペイロードは、次の場合に送信されます。

購読ユーザーが以下のいずれかを行ったとき：

- 投稿を作成
- リツイート
- 投稿に返信

他のユーザーが以下を行ったとき：

- 購読ユーザーに @メンションする\*
- 購読ユーザーが作成したツイートを引用する 

\*注: Account Activity API は、購読ユーザーが X から通知を受け取り、かつそのイベントを公開で確認できる場合にのみイベントを配信します。つまり、言及されたアカウント（@userA）が保護アカウント（@userB）をフォローしている場合、UserA は UserB が自分を言及した通知を受け取ります。UserA が UserB をフォローしていない（かつ UserB に承認されていない）場合、UserA は通知を受け取らず、したがって @userA が購読していても AAA 経由で tweet\_create\_event は送信されません。

**ブロックしたユーザーが購読ユーザーに言及した場合、どのように判別できますか？**

JSON レスポンスのトップレベルに `user_has_blocked` という boolean フィールドがあり、“true” または “false” が設定されます。このフィールドは投稿のメンションにのみ含まれます。 

Enterprise

**自分のアプリを allowlist に追加する、または既に allowlist にあるかを確認するにはどうすればよいですか？**

Enterprise API 経由でのアクセスのために許可リストに追加した[X apps](/ja/resources/fundamentals/developer-apps)を管理するには、アカウントマネージャーにアプリ ID を添えてご連絡ください。アプリ ID は、[developer portal](/ja/resources/fundamentals/developer-portal) の「[Apps](/ja/resources/fundamentals/developer-apps)」ページで確認できます。
 

**3 つの webhook へのアクセス権がある場合、エンタープライズ用途として登録した各アプリごとに 3 つの webhook を使用できますか？**

webhook の上限はアカウント単位で設定されており、アプリ単位ではありません。3 つの webhook へのアクセス権があり、エンタープライズ用途として 2 つのアプリを登録している場合、片方のアプリで 2 つ、もう一方のアプリで 1 つの webhook を使用できますが、各アプリで 3 つずつ使用することはできません。 

**Account Activity Replay API を使用して再配信されるイベントの種類を指定できますか？**

再配信するイベントの種類は指定できません。指定した日時の範囲内で配信されたすべてのイベントが再配信されます。 

**アプリケーションが Account Activity Replay API のイベント取り込みに失敗した場合、再試行は行われますか？**

いいえ、再試行は行われません。アプリケーションが Account Activity Replay API によって送信されたイベントの取り込みに失敗した場合、同じ期間で別の Replay ジョブを送信して、取りこぼした Replay イベントの再配信を試みることができます。 

**部分的成功の完了イベントを受け取った場合はどうすればよいですか？**

受信したイベントのタイムスタンプを控え、未受信のイベントについて別の Replay ジョブをリクエストすることをお勧めします。 

**同時に実行できる Account Activity Replay API ジョブはいくつですか？**

webhook ごとに同時に実行できる Account Activity Replay API ジョブは 1 つのみです。 

**Account Activity Replay API のイベントを、webhook に配信されるリアルタイムの本番イベントとどのように区別できますか？**

Account Activity Replay API は常に過去のイベントを配信するため、イベントのタイムスタンプに基づいてリアルタイムの本番イベントと区別できます。 

**アプリケーションがドロップまたは取り逃したアクティビティの再配信を Account Activity Replay API でどれくらい早く開始できますか？**

アクティビティは作成から約 10 分後に再配信可能になります。 

<div id="general">
  ### エラー対応ガイド
</div>

#### コード 32

このエラーは一般的に、指定しているリクエスト、ヘッダー、認可、または URL のいずれかの形式が不正であることを意味します。これは Account Activity API のエラーではなく、認可エラーであり、X が適切な OAuth 設定または URL を受け取れていません。

- **Enterprise** - 使用しているコンシューマーキーとアクセストークンが、Enterprise 製品の利用に登録された [X app](/ja/resources/fundamentals/developer-apps) に属していることを確認してください。コンシューマーキーやアクセストークンをお持ちでない場合、または X app を許可リストに追加する必要がある場合は、アカウントマネージャーまでご連絡ください。

- ユーザーコンテキストで認証している場合は、`oauth nonce`、`oauth_signature`、`oauth_timestamp` を正しく指定し、[リクエストを承認](/ja/resources/fundamentals/authentication#authorizing-a-request)していることを確認してください。

- アクセストークンに適切な権限レベルが付与されていることを確認してください。
  - [app dashboard](/ja/resources/fundamentals/developer-apps) の「Keys and tokens」タブで、アクセストークンに「Read, write, and direct messages」の[permission level](/ja/resources/fundamentals/developer-apps#app-permissions)が設定されていることを確認してください。
  - トークンの権限レベルがこれより低い場合は、「Permissions」タブに移動し、アクセス権限を「Read, write, and direct messages」に設定してから、「Keys and tokens」タブでアクセストークンとシークレットを再生成してください。

- URL の形式が正しいことを確認してください。
  - `:env_name` は大文字と小文字を区別します。
     

<div id="code-32">
  #### コード 200 - Forbidden
</div>

- **Premium** - API にリクエストする前に、承認済みの[開発者アカウント](/ja/resources/fundamentals/developer-portal)を取得していることを確認してください。リクエストでは適切な :env\_name を使用する必要があり、これは [dev environments](/ja/resources/fundamentals/developer-portal) ページで設定できます。

- **Enterprise** - アカウント担当者によって Account Activity API へのアクセス権が付与されていることを確認してください。

- URI が正しく設定されていることを確認してください。リクエストに誤った URI を入力すると、このエラーが発生する場合があります。
   

<div id="code-200-forbidden">
  #### コード 214 - Webhook URL が要件を満たしていません。
</div>

- HTTPS を使用していることを確認してください。
- Webhook URL の形式が正しくない可能性があります。
- Webhook URL の設定方法は、[Getting started with webhooks](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#getting-started-with-webhooks) ページの [Develop webhook consumer app](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#3-develop-webhook-consumer-app) セクションを参照してください。
   

<div id="code-214-webhook-url-does-not-meet-the-requirements">
  #### コード 214 - CRC の GET リクエストで高遅延が発生。Webhook は 3 秒未満で応答する必要があります。
</div>

- これはサーバーの処理が遅いことを示します。CRC に 3 秒以内に応答していることを確認してください。
   

<div id="code-214-high-latency-on-crc-get-request-your-webhook-should-respond-in-less-than-3-seconds">
  #### コード 214 - CRC の GET リクエスト中に 200 以外のレスポンスコード（例：404、500 など）
</div>

- サーバーがダウンしています。サーバーが正常に稼働していることを確認してください。
   

<div id="code-214-non-200-response-code-during-crc-get-request-ie-404-500-etc">
  #### コード 214 - 作成済みリソースが多すぎます。
</div>

- **Enterprise** - すでにすべての webhook を使用しています。登録済みの各アプリで [GET webhooks](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks) エンドポイントを使用して、webhook の配布先を確認してください。 

<div id="code-214-too-many-resources-already-created">
  #### コード 261 - アプリケーションは書き込み操作を実行できません。
</div>

- 使用中の API 連携アプリのアクセス トークンおよびアクセス トークンシークレットに、適切な[権限レベル](/ja/resources/fundamentals/developer-apps#app-permissions)が設定されていません。[X apps](/ja/resources/fundamentals/developer-apps) ダッシュボードの「Keys and tokens」タブに移動し、アクセス トークンとアクセス トークンシークレットに割り当てられている権限レベルを確認してください。「Read, write and Direct Messages」以外に設定されている場合は、「Permission」タブで設定を変更し、新しい設定を反映させるためにアクセス トークンとアクセス トークンシークレットを再生成してください。
- もしくは、アプリのみ認証（app-only authentication）で webhook の登録を試みている可能性がありますが、これはサポートされていません。代わりにユーザーコンテキストで認証してください。詳しくは、[Enterprise Account Activity API](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks) の webhook 登録に関する API リファレンスの該当セクションを参照してください。

## アカウントアクティビティ API リファレンス索引

|     |     |
| :--- | :--- |
| **目的** | エンタープライズ |
| Webhook URL を登録／webhook\_id を生成 | [POST  <br />webhooks](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#enterprise-account-activity-api) |
| すべての Webhook URL とそのステータスを返す | [GET  <br />webhooks](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks) |
| チャレンジレスポンスの確認を手動で実行 | [PUT  <br />webhooks/:webhook\_id](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#put-account-activity-webhooks-webhook-id) |
| アカウントのイベントをアプリケーションに購読させる | [POST  <br />webhooks/:webhook\_id/subscriptions/all](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#post-account-activity-webhooks-webhook-id-subscriptions-all) |
| 現在アクティブな購読数を返す | [GET  <br />subscriptions/count](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-subscriptions-count) |
| Webhook がアカウントを購読しているか確認 | [GET  <br />webhooks/:webhook\_id/subscriptions/all](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-webhooks-webhook-id-subscriptions-all) |
| 現在アクティブな購読の一覧を返す | [GET  <br />webhooks/:webhook\_id/subscriptions/all/list](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#get-account-activity-subscriptions-count) |
| Webhook を削除 | [DELETE  <br />webhooks/:webhook\_id](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id) |
| 3-legged OAuth を使用して購読を無効化（非推奨） | [DELETE  <br />webhooks/:webhook\_id/subscriptions/all](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id-subscriptions-all-deprecated) |
| アプリケーション専用 OAuth を使用して購読を無効化 | [DELETE  <br />webhooks/:webhook\_id/subscriptions/:user\_id/all.json](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id-subscriptions-user-id-all-json) |
| アクティビティを Webhook に再配信 | [POST  <br />replay/webhooks/:webhook\_id/subscriptions/all](/ja/x-api/enterprise-gnip-2.0/fundamentals/account-activity#delete-account-activity-webhooks-webhook-id-subscriptions-all-deprecated) |

### エンタープライズ向け Account Activity API

#### POST account\_activity/webhooks[](#post-account-activity-webhooks "この見出しへのパーマリンク")

指定されたアプリケーションコンテキストに対して新しい webhook URL を登録します。URL は保存前に CRC リクエストで検証されます。検証に失敗した場合は、要求元に詳細なエラーメッセージを返します。

許可される webhook の数は課金プランによって決まります。

### リソース URL[](#resource-url "この見出しへのパーマリンク")

`https://api.x.com/1.1/account_activity/webhooks.json`

<div id="resource-url">
  ### リソース情報[](#resource-information "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| レスポンス形式 | JSON |
| 認証が必要 | はい（ユーザーコンテキスト — すべてのコンシューマー／アクセストークン） |
| レート制限 | あり |
| リクエスト数 / 15分ウィンドウ（ユーザー認証） | 15 |
| 投稿の編集サポート | すべての投稿オブジェクトに、その投稿の編集履歴を示す編集メタデータが含まれます。詳細は「投稿の編集」の基礎 ([「投稿の編集」](/ja/x-api/enterprise-gnip-2.0/fundamentals/edit-tweets)) を参照してください。 |

<div id="resource-information">
  ### パラメータ[](#parameters "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| url（必須） | コールバックエンドポイントのためにエンコードされたURL。 |

<div id="parameters">
  ### リクエスト例[](#example-request "Permalink to this headline")
</div>

$ curl --request POST
\--url 'https://api.x.com/1.1/account\_activity/webhooks.json?url=https%3A%2F%2Fyour\_domain.com%2Fwebhooks%2Ftwitter%2F0'
\--header 'authorization: OAuth oauth\_consumer\_key="CONSUMER\_KEY", oauth\_nonce="GENERATED", oauth\_signature="GENERATED", oauth\_signature\_method="HMAC-SHA1", oauth\_timestamp="GENERATED", oauth\_token="ACCESS\_TOKEN", oauth\_version="1.0"'

<div id="example-request">
  ### HTTP レスポンス[](#http-responses "Permalink to this headline")
</div>

| HTTP Code | メッセージ |
| :--- | :--- |
| 200 | Webhook URL が指定のアプリケーションに登録されています |
| 403 | リクエストにエラーがあります。以下のエラーメッセージのセクションを参照してください。 |

<div id="http-responses">
  ### レスポンス例 - 成功[](#example-response-success "Permalink to this headline")
</div>

```json
_HTTP 200_

    {
      "id": "1234567890",
      "url": "https://your_domain.com/webhook/twitter/0",
      "valid": true,
      "created_at": "2016-06-02T23:54:02Z"
    }
```

<div id="example-response-success">
  ### エラーメッセージ[](#error-messages "Permalink to this headline")
</div>

| コード | メッセージ |
| :--- | :--- |
| 214 | Webhook の URL が要件を満たしていません。 |
| 214 | 作成済みのリソースが多すぎます。 |
| 214 | Webhook の URL が要件を満たしていません。CRC トークンが無効、または JSON 応答形式が不正です。 |
| 214 | CRC の GET リクエストのレイテンシーが高すぎます。Webhook は 3 秒未満で応答する必要があります。 |
| 214 | CRC の GET リクエスト中に 200 以外のステータスコード（例：404、500 など）が返されました。 |

_HTTP 403_

```json
    {
      "errors": [
        {
          "code": 214,
          "message": "Too many resources already created."
        }
      ]
    }
```

#### GET account\_activity/webhooks[](#get-account-activity-webhooks "この見出しへのパーマリンク")

指定したアプリケーションのすべてのURLとそのステータスを返します。

URLが日次の検証チェックに失敗した場合、そのURLは無効としてマークされます。再度有効化するには、update エンドポイントを呼び出してください。

### リソース URL[](#resource-url "この見出しへのパーマリンク")

`https://api.x.com/1.1/account_activity/webhooks.json`

<div id="resource-url">
  ### リソース情報[](#resource-information "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| レスポンス形式 | JSON |
| 認証が必要 | はい（アプリケーションのみ・ベアラートークン） |
| レート制限 | あり |
| リクエスト数 / 15分間（アプリ認証） | 15 |

### リクエスト例[](#example-request "この見出しへのパーマリンク")

```bash
    $ curl --request GET
     --url https://api.x.com/1.1/account_activity/webhooks.json
     --header 'authorization: Bearer TOKEN'
```

<div id="example-request">
  ### レスポンス例[](#example-response "Permalink to this headline")
</div>

_HTTP 200 OK_

```json
    [
      {
        "id": "1234567890",
        "url": "https://your_domain.com/webhook/twitter/0",
        "valid": true,
        "created_at": "2016-06-02T23:54:02Z"
      }
      {
        "id": "2468013579",
        "url": "https://your_domain2.com/webhook/twitter/0",
        "valid": true,
        "created_at": "2016-06-04T22:31:29Z"
      }
    ]
```

<div id="example-response-success">
  ### エラーメッセージ[](#error-messages "Permalink to this headline")
</div>

| コード | メッセージ |
| :--- | :--- |
| 99  | このリソースへのアクセス権がありません。 |

#### PUT account\_activity/webhooks/:webhook\_id[](#put-account-activity-webhooks-webhook-id "この見出しへのパーマリンク")

指定された webhook の URL に対して challenge response check（CRC）を実行します。チェックが成功すると、ステータスを `valid` に設定して webhook を再有効化し、204 を返します。

### リソース URL[](#resource-url "この見出しへのパーマリンク")

`https://api.x.com/1.1/account_activity/webhooks/:webhook_id.json`

<div id="resource-url">
  ### リソース情報[](#resource-information "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| レスポンス形式 | JSON |
| 認証が必要 | はい（ユーザーコンテキスト—すべてのコンシューマーおよびアクセストークン） |
| レート制限 | あり |
| リクエスト数／15分（ユーザー認証） | 15 |

<div id="resource-information">
  ### パラメータ[](#parameters "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| webhook\_id（必須） | Webhook の ID。リソースパスで定義されます。 |

### リクエスト例[](#example-request "この見出しへのパーマリンク")

```json
    $ curl --request PUT
     --url https://api.x.com/1.1/account_activity/webhooks/:WEBHOOK_ID.json
     --header 'authorization: OAuth oauth_consumer_key="CONSUMER_KEY", oauth_nonce="GENERATED", oauth_signature="GENERATED", oauth_signature_method="HMAC-SHA1", oauth_timestamp="GENERATED", oauth_token="ACCESS_TOKEN", oauth_version="1.0"'
```

<div id="example-request">
  ### レスポンス[](#response "Permalink to this headline")
</div>

_HTTP 204 OK_

```
    { }
```

<div id="example-response-success">
  ### エラーメッセージ[](#error-messages "Permalink to this headline")
</div>

| コード | メッセージ |
| :--- | :--- |
| 34  | Webhook が存在しないか、別の X アプリに関連付けられています。 |
| 214 | Webhook の URL が要件を満たしていません。 |
| 214 | Webhook の URL が要件を満たしていません。CRC トークンが無効、または JSON の応答形式が不正です。 |
| 214 | CRC の GET リクエストのレイテンシーが高すぎます。Webhook は 3 秒未満で応答する必要があります。 |
| 214 | CRC の GET リクエスト時に 200 以外の応答コード（例：404、500 など）。 |

#### POST account\_activity/webhooks/:webhook\_id/subscriptions/all[](#post-account-activity-webhooks-webhook-id-subscriptions-all "Permalink to this headline")

指定したユーザーコンテキストについて、すべてのメッセージタイプにおける全イベントを、指定のアプリケーションに配信する購読を登録します。有効化後、リクエスト元ユーザーの全イベントは、POST リクエストでアプリケーションの webhook に送信されます。

サブスクリプションは現在、お客様のアカウント構成に基づき制限されています。さらにサブスクリプションを追加する必要がある場合は、アカウント担当者にお問い合わせください。

### リソース URL[](#resource-url "Permalink to this headline")

`https://api.x.com/1.1/account_activity/webhooks/:webhook_id/subscriptions/all.json`

<div id="resource-url">
  ### リソース情報[](#resource-information "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| レスポンス形式 | JSON |
| 認証が必要 | はい（3-legged OAuth：ホワイトリスト登録済みコンシューマーキーと購読ユーザーのアクセストークン） |
| レート制限 | あり |
| リクエスト数/15分（ユーザー認証） | 500 |

<div id="resource-information">
  ### パラメータ[](#parameters "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| webhook\_id（必須） | Webhook の ID。リソースパスで定義されます。 |

<div id="parameters">
  ### リクエスト例[](#example-request "Permalink to this headline")
</div>

```bash
    $ curl --request POST
     --url https://api.x.com/1.1/account_activity/webhooks/:WEBHOOK_ID/subscriptions/all.json
     --header 'authorization: OAuth oauth_consumer_key="WHITELISTED_CONSUMER_KEY", oauth_nonce="GENERATED", oauth_signature="GENERATED", oauth_signature_method="HMAC-SHA1", oauth_timestamp="GENERATED", oauth_token="SUBSCRIBING_USER'S_ACCESS_TOKEN", oauth_version="1.0"'
```

<div id="http-responses">
  ### レスポンス例 - 成功[](#example-response-success "Permalink to this headline")
</div>

_HTTP 204 NO CONTENT_

```
    {}
```

<div id="example-response-success">
  ### エラーメッセージ[](#error-messages "Permalink to this headline")
</div>

| コード | メッセージ |
| :--- | :--- |
| 34  | Webhook が存在しないか、別の X アプリケーションに関連付けられています。 |
| 348 | クライアントアプリケーションは、このユーザーの Webhook サブスクリプションへアクセスする権限がありません。 |

#### GET account\_activity/subscriptions/count[](#get-account-activity-subscriptions-count "この見出しへのパーマリンク")

現在アカウントで有効なサブスクリプションの件数を返します。なお、/count エンドポイントはアプリケーション専用の OAuth を要するため、ユーザーコンテキストではなくベアラートークンを用いてリクエストしてください。

### リソースURL[](#resource-url "Permalink to this headline")

`https://api.x.com/1.1/account_activity/subscriptions/count.json`

<div id="resource-url">
  ### リソース情報[](#resource-information "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| レスポンス形式 | HTTP ステータスコード |
| 認証が必要 | はい（アプリケーションのみ・ベアラートークン） |
| レート制限 | あり |
| リクエスト数／15分（アプリ認証） | 15 |

<div id="resource-information">
  ### HTTP レスポンスコード[](#http-response-codes "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| Code | メッセージ |
| 200 | 成功。リクエストされた Webhook のサブスクリプション数が返されます。 |
| 401 | お使いのアプリケーションには、指定された Webhook のサブスクリプションを表示する権限がありません。 |

<div id="parameters">
  ### リクエスト例[](#example-request "Permalink to this headline")
</div>

```bash
    $ curl --request GET
     --url https://api.x.com/1.1/account_activity/subscriptions/count.json
     --header 'authorization: Bearer TOKEN'
```

<div id="http-responses">
  ### レスポンス例 - 成功[](#example-response-success "Permalink to this headline")
</div>

_HTTP 200_

```bash
    {
      "account_name":"my-account",
      "subscriptions_count_all":"1",
      "subscriptions_count_direct_messages":"0",
      "provisioned_count":"50"
    }
```

<div id="example-response-success">
  ### エラーメッセージ[](#error-messages "Permalink to this headline")
</div>

| コード | メッセージ |
| :--- | :--- |
| 32  | 認証に失敗しました。 |

_HTTP 401_

```abash
    {
      "errors": [
        {
           "code": 32,
          "message": "Could not authenticate you."
        }
      ]
    }
```

#### GET account\_activity/webhooks/:webhook\_id/subscriptions/all[](#get-account-activity-webhooks-webhook-id-subscriptions-all "この見出しへのパーマリンク")

指定したユーザーのイベントに、その Webhook 構成が購読済みかを判定する手段を提供します。指定したユーザーコンテキストが指定したアプリケーションでアクティブなサブスクリプションを持つ場合は、204 OK を返します。レスポンスコードが 204 でない場合、そのユーザーにはアクティブなサブスクリプションはありません。詳細は以下の HTTP レスポンスコードとエラーメッセージを参照してください。

### リソース URL[](#resource-url "Permalink to this headline")

`https://api.x.com/1.1/account_activity/webhooks/:webhook_id/subscriptions/all.json`

<div id="resource-url">
  ### リソース情報[](#resource-information "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| レスポンス形式 | JSON |
| 認証が必要 | はい（3-legged OAuth：ホワイトリスト登録済みコンシューマーキーと購読ユーザーのアクセストークン） |
| レート制限 | あり |
| リクエスト数/15分（ユーザー認証） | 500 |

<div id="resource-information">
  ### パラメータ[](#parameters "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| webhook\_id（必須） | Webhook の ID。リソースパスで定義されます。 |

<div id="parameters">
  ### リクエスト例[](#example-request "Permalink to this headline")
</div>

$ curl --request GET
\--url https://api.x.com/1.1/account\_activity/webhooks/:WEBHOOK\_ID/subscriptions/all.json
\--header 'authorization: OAuth oauth\_consumer\_key="WHITELISTED\_CONSUMER\_KEY", oauth\_nonce="GENERATED", oauth\_signature="GENERATED", oauth\_signature\_method="HMAC-SHA1", oauth\_timestamp="GENERATED", oauth\_token="SUBSCRIBING\_USER'''S\_ACCESS\_TOKEN", oauth\_version="1.0"'

<div id="http-responses">
  ### レスポンス例 - 成功[](#example-response-success "Permalink to this headline")
</div>

_HTTP 204 No Content_

```
    { }
```

#### GET account\_activity/webhooks/:webhook\_id/subscriptions/all/list[](#get-account-activity-webhooks-webhook-id-subscriptions-all-list "この見出しへのパーマリンク")

指定した webhook に対する現在の All Activity タイプのサブスクリプション一覧を返します。なお、/list エンドポイントはアプリケーション専用の OAuth が必要なため、リクエストはユーザーコンテキストではなくベアラートークンを使用してください。

### リソースURL[](#resource-url "Permalink to this headline")

`https://api.x.com/1.1/account_activity/webhooks/:webhook_id/subscriptions/all/list.json`

<div id="resource-url">
  ### リソース情報[](#resource-information "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| レスポンス形式 | HTTP ステータスコード |
| 認証が必要 | はい（アプリケーションのみ・ベアラートークン） |
| レート制限 | あり |
| リクエスト数／15 分ウィンドウ（アプリケーション認証） | 50 |

<div id="resource-information">
  ### パラメータ[](#parameters "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| webhook\_id（必須） | Webhook の ID。リソースパスで定義されます。 |

<div id="resource-information">
  ### HTTP レスポンスコード[](#http-response-codes "Permalink to this headline")
</div>

| Code | Message |
| :--- | :--- |
| 200 | 成功。リクエストされた webhook のサブスクリプション一覧が返されます。 |
| 401 | 指定された webhook のサブスクリプションを閲覧する権限が、このアプリケーションにはありません。 |

### リクエスト例[](#example-request "この見出しへのパーマリンク")

$ curl --request GET
\--url https://api.x.com/1.1/account\_activity/webhooks/:WEBHOOK\_ID/subscriptions/all/list.json
\--header 'authorization: Bearer TOKEN'

<div id="example-request">
  ### 応答例 - 成功[](#example-response-success "Permalink to this headline")
</div>

_HTTP 200_

```bash
    {
      "webhook_id": "1234567890",
      "webhook_url": "https://your_domain.com/webhook/twitter/0",
      "application_id": "11231812",
      "subscriptions": [{
        "user_id": "20212306"
      }]
    }
```

<div id="example-response-success">
  ### エラーメッセージ[](#error-messages "Permalink to this headline")
</div>

| コード | メッセージ |
| :--- | :--- |
| 32  | 認証できませんでした。 |

_HTTP 401_

```bash
    {
      "errors": [
        {
           "code": 32,
          "message": "Could not authenticate you."
        }
      ]
    }
```

#### DELETE account\_activity/webhooks/:webhook\_id[](#delete-account-activity-webhooks-webhook-id "この見出しへのパーマリンク")

指定したアプリケーションの設定から webhook を削除します。webhook ID は、GET /1.1/account\_activity/webhooks を呼び出すことで取得できます。

### リソース URL[](#resource-url "この見出しへのパーマリンク")

`https://api.x.com/1.1/account_activity/webhooks/:webhook_id.json`

<div id="resource-url">
  ### リソース情報[](#resource-information "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| レスポンス形式 | JSON |
| 認証が必要 | はい（ユーザーコンテキスト—すべてのコンシューマーおよびアクセストークン） |
| レート制限 | あり |
| リクエスト数／15分（ユーザー認証） | 15 |

<div id="resource-information">
  ### パラメータ[](#parameters "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| webhook\_id（必須） | Webhook の ID。リソースパスで定義されます。 |

<div id="parameters">
  ### リクエスト例[](#example-request "Permalink to this headline")
</div>

```bash
    $ curl --request DELETE
     --url https://api.x.com/1.1/account_activity/webhooks/:WEBHOOK_ID.json
     --header 'authorization: OAuth oauth_consumer_key="CONSUMER_KEY", oauth_nonce="GENERATED", oauth_signature="GENERATED", oauth_signature_method="HMAC-SHA1", oauth_timestamp="GENERATED", oauth_token="ACCESS_TOKEN", oauth_version="1.0"'
```

<div id="example-request">
  ### レスポンス[](#response "Permalink to this headline")
</div>

_HTTP 204 OK_

```
    { }
```

#### DELETE account\_activity/webhooks/:webhook\_id/subscriptions/all (非推奨)[](#delete-account-activity-webhooks-webhook-id-subscriptions-all-deprecated- "Permalink to this headline")

指定されたユーザーコンテキストとアプリケーションのサブスクリプションを無効化します。無効化後、リクエスト元のユーザーに対するすべてのイベントは、Webhook URLには送信されません。

### リソース URL[](#resource-url "Permalink to this headline")

`https://api.x.com/1.1/account_activity/webhooks/:webhook_id/subscriptions/all.json`

<div id="resource-url">
  ### リソース情報[](#resource-information "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| レスポンス形式 | JSON |
| 認証が必要 | はい（3-legged OAuth ― ホワイトリスト登録済みコンシューマーキーと購読ユーザーのアクセストークン） |
| レート制限 | あり |
| リクエスト数 / 15分ウィンドウ（ユーザー認証） | 500 |

<div id="resource-information">
  ### パラメータ[](#parameters "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| webhook\_id（必須） | Webhook の ID。リソースパスで定義されます。 |

### リクエスト例[](#example-request "この見出しへのパーマリンク")

```bash
    $ curl --request DELETE
     --url https://api.x.com/1.1/account_activity/webhooks/:WEBHOOK_ID/subscriptions/all.json
     --header 'authorization: OAuth oauth_consumer_key="WHITELISTED_CONSUMER_KEY", oauth_nonce="GENERATED", oauth_signature="GENERATED", oauth_signature_method="HMAC-SHA1", oauth_timestamp="GENERATED", oauth_token="SUBSCRIBED_USER\'S_ACCESS_TOKEN", oauth_version="1.0"'
```

リクエスト例

```
    { }
```

#### DELETE /account\_activity/webhooks/:webhook\_id/subscriptions/:user\_id/all.json[](#delete-account-activity-webhooks-webhook-id-subscriptions-user-id-all-json "この見出しへのパーマリンク")

指定された webhook と user ID の購読を無効化します。無効化後、リクエスト元ユーザーに関するすべてのイベントは webhook の URL へ送信されなくなります。なお、このエンドポイントはアプリケーション専用の OAuth を必要とするため、リクエストはユーザーコンテキストではなくベアラートークンを使用して行う必要があります。

### リソース URL[](#resource-url "Permalink to this headline")

`https://api.x.com/1.1/account_activity/webhooks/:webhook_id/subscriptions/:user_id/all.json`

<div id="resource-url">
  ### リソース情報[](#resource-information "Permalink to this headline")
</div>

|     |     |
| :--- | :--- |
| レスポンス形式 | JSON |
| 認証が必要 | はい（アプリケーションのみ・ベアラートークン） |
| レート制限 | あり |
| リクエスト数/15分間ウィンドウ | 500 |

<div id="parameters">
  ### リクエスト例[](#example-request "Permalink to this headline")
</div>

```bash
    $ curl --request DELETE
     --url https://api.x.com/1.1/account_activity/webhooks/:webhook_id/subscriptions/:user_id/all.json
     --header 'authorization: Bearer TOKEN'
```

### レスポンス[](#response "この見出しへのパーマリンク")

_HTTP 204 No Content_

<div id="example-response-success">
  ### エラーメッセージ[](#error-messages "Permalink to this headline")
</div>

| コード | メッセージ |
| :--- | :--- |
| 404 | 申し訳ありません、そのページは存在しません。— 指定したユーザーIDが実際には購読していない場合に発生することがよくあります。 |

<div id="error-messages">
  ### リプレイ API
</div>

**POST /1.1/account\_activity/replay/webhooks/:webhook\_id/subscriptions/all.json [¶](#post-1-1-account-activity-replay-webhooks-webhook-id-subscriptions-all-json- "この見出しへのパーマリンク")**

リクエストで指定した日時の範囲に存在していたすべてのサブスクリプションを対象に、過去最大5日分のアクティビティ取得を要求します。Webhook にアクティブなユーザーサブスクリプションがある場合、それらのイベントも同時に受信します。注: リプレイイベントを配信する前に CRC を実行します。

|     |     |
| :--- | :--- |
| **Request Method** | HTTP POST |
| **URL** | /1.1/account\_activity/replay/webhooks/:webhook\_id/subscriptions/all.json?from\_date=yyyymmddhhmm\&to\_date=yyyymmddhhmm |
| **Response Format** | JSON |
| **Requires Authentication** | はい（アプリケーションのみ・ベアラートークン） |
| **Rate Limit** | 15分あたり5リクエスト。現在、要求可能なリプレイジョブ数の上限はありません。 |
| **from\_date** | イベント提供の起点となる最も古い UTC タイムスタンプ。'yyyymmddhhmm' 形式で指定します。タイムスタンプは分単位の粒度で、包括的です（例: 12:00 は00分を含みます）。有効な時刻は UTC で過去5日以内、かつ現在時刻の31分前より新しくない必要があります。from\_date と to\_date は約2時間以内に収めることを推奨します。 |
| **to\_date** | イベント提供の終点となる最も新しい UTC タイムスタンプ。'yyyymmddhhmm' 形式で指定します。タイムスタンプは分単位の粒度で、排他的です（例: 12:30 はその時間の30分を含みません）。有効な時刻は UTC で過去5日以内、かつ現在時刻の10分前より新しくない必要があります。 |

#### レスポンス

以下のレスポンスが API から返される可能性があります。ほとんどのエラーコードは、本文に追加の詳細を含む文字列とともに返されます。200 以外のレスポンスの場合は、エラーを解消してから再試行してください。

| ステータス | テキスト | エラーコード | 説明 | メッセージ |
| :--- | :--- | :--- | :--- | :--- |
| 202 | Accepted | N/A | リクエストは成功し、アクティビティが送信されます。 | N/A |
| 400 | Bad Request | 214 | Webhook が無効としてマークされています。 | Webhook は無効としてマークされており、CRC チェックが必要です。 |
| 400 | Bad Request | 357 | クエリパラメータが欠落しています。 | : queryParam は必須です。 |
| 400 | Bad Request | 358 | ルートまたはクエリパラメータの形式が不正です。 | パラメータを解析できません。 |
| 400 | Bad Request | 360 | ルートパラメータが負の値です。 | webhook\_id: \[] は 0 以上ではありません。 |
| 400 | Bad Request | 368 | from\_date または to\_date が過去ではありません。 | : \[\<field\_value>] は過去ではありません。 |
| 400 | Bad Request | 356 | from\_date は to\_date より前でなければなりません。 | from\_date は to\_date より前でなければなりません。 |
| 400 | Bad Request | 356 | from\_date は過去 5 日以内でなければなりません。 | from\_date は過去 5 日以内でなければなりません。 |
| 401 | Unauthorized | 32  | 提供された 3-legged 認証により HTTP 認証が失敗しました。 | 無効な認証方法です。アプリケーション専用認証を使用してください。 |
| 401 | Unauthorized | 61  | クライアントにはこのメソッドをリクエストする権限がありません。 | クライアントにはこのメソッドをリクエストする権限がありません。 |
| 403 | Forbidden | 200 | クライアントに Replay が有効なエンタープライズアカウントがありません。 | Account Activity API のリプレイ対応エンタープライズアカウントが必要です。エンタープライズアカウントをお持ちで、リプレイが有効化されていることを確認してください。 |
| 404 | Not Found | 34  | 存在しない webhook\_id、または webhook\_id と application\_id の不一致。 | Webhook が存在しないか、別の X アプリケーションに関連付けられています。 |
| 409 | Conflict | 355 | 実行中のリクエストがあり、別のリクエストを行う前に処理完了を待つ必要があります。 | この Webhook にはすでにリプレイジョブが進行中です。 |
| 429 | Too Many Requests | 88  | レート制限（一定期間内のリクエスト数の上限に達しました） | リクエストが多すぎます。API のリクエストレートを下げてください。 |
| 500 | Internal Server Error | 0   | 内部サーバーエラー。 | 内部サーバーエラー。 |
| 503 | Service Unavailable | 67  | X の依存サービスの 1 つ以上が利用できません。 | X サーバーエラー。指数バックオフ方式で再試行してください。 |

<div id="responses">
  #### 「ジョブは正常に完了しました」メッセージ
</div>

ジョブが正常に完了すると、Account Activity Replay API は次のジョブ完了イベントを配信します。このイベントを受信した時点でジョブの実行は終了しており、次のジョブを送信できます。

```json
{
  "replay\_job\_status": {
    "webhook_id": "1234577122340233217",
    "job_state": "Complete",
    "job\_state\_description": "Job completed successfully"
    "job_id": "1095098195724558337"
  }
}
```

<div id="job-completed-successfully-message">
  #### 「ジョブが完了しませんでした」メッセージ
</div>

ジョブが正常に完了しなかった場合は、リプレイジョブの再試行を促す次のメッセージを返します。このイベントを受信した時点でジョブの実行は終了しており、別のジョブを送信できます。

```json
{
  "replay\_job\_status": {
    "webhook_id": "123451374207332352",
    "job_state": "Incomplete",
    "job\_state\_description": "Job failed to deliver all events, please retry your replay job",
    "job_id": "1093226942650736640"
  }
}
```

<div id="job-failed-to-complete-message">
  #### curl のリクエスト例
</div>

```bash
    curl --request POST  --url 'https://api.x.com/1.1/account_activity/replay/webhooks/:webhook_id/subscriptions/all.json?from_date=yyyymmddhhmm&to_date=yyyymmddhhmm'
    --header 'authorization: Bearer TOKEN'
```

<div id="example-curl-request">
  #### レスポンス例
</div>

HTTP 202

```bash
{
  "job_id": "1234567890",
  "created_at": "2016-06-02T23:54:02Z"
}
```