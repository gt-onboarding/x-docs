<div id="v2-webhooks-api">
  # V2 Webhooks API
</div>

<div id="overview">
  ## 概要
</div>

V2 Webhooks API は、webhook ベースの JSON メッセージを介して、X アカウントからのリアルタイムなイベント通知を受信できるようにします。これらの API により、webhook の登録と管理、イベントを処理するコンシューマーアプリケーションの開発、さらに CRC（challenge-response check）や署名ヘッダーによる安全な通信の確保が可能です。

<div id="feature-summary">
  ## 機能概要
</div>

| ティア | 料金 | Webhook 数 |
| :---: | :---: | :---: |
| セルフサーブ Pro | $5,000/月 | 1 |
| エンタープライズ | [営業担当にお問い合わせ](/ja/resources/enterprise/forms/enterprise-api-interest#enterprise-access-form) | 5以上 |

<div id="products-that-support-webhooks">
  ## Webhook をサポートする製品
</div>

現在、webhook 経由でイベント配信をサポートしている製品は次のとおりです。

- [Account Activity API (AAA)](/ja/x-api/account-activity/introduction)
- [Filtered Stream](/ja/x-api/webhooks/stream/introduction)

<div id="manage-webhooks">
  ## Webhook の管理
</div>

Account Activity API は、あなたのサービスに登録されている X アカウントに関連するイベントが発生するたびに、Webhook ベースの JSON メッセージを送信します。X はそれらのアクティビティを、あなたが登録した Webhook に配信します。以下の手順では、Webhook と登録ユーザーの管理方法を説明します。

Webhook と登録ユーザーについて、登録、表示、削除の方法を学びます。各種 API エンドポイントへのリクエストには、シンプルな cURL コマンドを使用します。cURL は、URL 構文でリクエストを送受信するためのコマンドラインツールです。

イベントコンシューマーアプリケーションで Webhook イベントの受信を開始する前に、いくつか準備が必要です。以下のとおり、X アプリを作成し、Account Activity API へのアクセスを取得し、Webhook イベントを受け取って処理する Web アプリを開発する必要があります。 

<div id="1-develop-a-webhook-consumer-app">
  ### 1. Webhook コンシューマーアプリを開発する
</div>

X アプリに関連付けられた新しい webhook を登録するには、X の webhook イベントを受信し、当社のセキュリティ要求に応答する Web アプリを開発・デプロイしてホストする必要があります。

_開始する前に、[サンプルアプリ](https://github.com/xdevplatform/account-activity-dashboard-enterprise/tree/master)をご確認ください。_

- イベントを受信する webhook エンドポイントとして機能する、公開アクセス可能な HTTPS URL を持つ Web アプリを作成します。
  - URI の「パス」は自由に決められます。次の例は有効です: [https://mydomain.com/service/listen](https://mydomain.com/service/listen)
  - 複数のソースからの webhook を受信する場合の一般的なパターンの一例: [https://mydomain.com/webhook/twitter](https://mydomain.com/webhook/twitter)
  - 指定する URL にポート番号を含めることはできません（例: [https://mydomain.com:5000/NoWorkie](https://mydomain.com:5000/NoWorkie) は不可）。
- まず、X の Challenge Response Check（CRC）の GET リクエストを受信し、適切に整形された JSON レスポンスで返すコードを実装します。
- webhook の URL を登録します。JSON 本文に URL を含めて /2/webhooks エンドポイントに POST リクエストを送信します。このリクエストを行うと、X は CRC リクエストをあなたの Web アプリに送信します。
- webhook が正常に登録されると、レスポンスに webhook の ID が含まれます。後で webhook 対応プロダクトにリクエストする際に、この webhook ID が必要です。
- X は、登録した URL にイベントを含む POST リクエストを送信します。これらのイベントは JSON でエンコードされます。webhook の JSON ペイロード例は[こちら](/ja/x-api/account-activity/introduction#account-activity-data-object-structure)をご覧ください。

<div id="optional-use-xurl-for-testing">
  #### オプション: テストには xurl を使用する
</div>

テスト目的で、xurl ツールは一時的な webhook をサポートするようになりました。GitHub から[`xurl` プロジェクト](https://github.com/xdevplatform/xurl)の最新バージョンをインストールし、認可を設定してから、次を実行します:

```
xurl webhook start
```

これにより一時的な公開 webhook URL が生成され、CRC チェックを自動処理し、受信したサブスクリプションイベントをすべてログ出力します。デプロイ前に設定を検証するのに最適です。出力例:

```
Starting webhook server with ngrok...
Enter your ngrok authtoken (leave empty to try NGROK_AUTHTOKEN env var):

Attempting to use NGROK_AUTHTOKEN environment variable for ngrok authentication.
Configuring ngrok to forward to local port: 8080
Ngrok tunnel established!
  Forwarding URL: https://<your-ngrok-subdomain>.ngrok-free.app -> localhost:8080

Use this URL for your X API webhook registration: https://<your-ngrok-subdomain>.ngrok-free.app/webhook

Starting local HTTP server to handle requests from ngrok tunnel (forwarded from https://<your-ngrok-subdomain>.ngrok-free.app)...
```

**重要な注意事項**

- webhook URL を登録する際は、Web アプリで CRC チェックの暗号化にアプリの consumer secret を使用する必要があります。

- 受信するダイレクトメッセージはすべて webhook 経由で配信されます。さらに、[POST /2/dm\_conversations/with/:participant\_id/messages](/ja/x-api/direct-messages/send-a-new-message-to-a-user) で送信されたダイレクトメッセージも webhook 経由で配信されます。これは、別クライアントから送信されたダイレクトメッセージも Web アプリで把握できるようにするためです。

- 同じ webhook URL を共有し、かつ同一のユーザーが各アプリにマッピングされている Web アプリが複数ある場合、同じイベントが複数回（Web アプリごとに 1 回）あなたの webhook に送信されます。

- 場合によっては、webhook が重複イベントを受信することがあります。webhook アプリはこれを許容し、イベント ID によって重複排除できるようにしてください。

- サンプルコード:

  - [Account Activity API Setup](https://github.com/m-rosinsky/XWebhookTest) — Account Activity API のエンタープライズティアを使用して webhook イベントを表示する Node 製 Web アプリ。

<div id="2-securing-webhooks">
  ### 2. Webhook のセキュリティ保護
</div>

X の webhook ベースの API では、Webhook サーバーのセキュリティを確認するために次の 2 つの方法を提供しています:

1. チャレンジレスポンスチェックにより、Webhook イベントを受け取る Web アプリの所有権を X が確認できます。 
2. 各 POST リクエストの署名ヘッダーにより、受信した Webhook の送信元が X であることを確認できます。

実装要件については、CRC チェックのセクションを参照してください。

<div id="3-the-webhooks-api">
  ### 3. Webhooks API
</div>

Webhook は Webhook Management API を通じて管理されます。すべてのエンドポイントで OAuth 2.0 のアプリ専用ベアラートークン認証が必要です。

<div id="adding-a-webhook">
  #### [Webhook の追加](/ja/x-api/webhooks/create-webhook-config)
</div>

**POST /2/webhooks**

**説明:**

Webhook 設定を作成します。公開アクセス可能な `https` コールバック URL を JSON ボディで渡す必要があります。\
まずは、指定されたアプリケーションコンテキストに新しい webhook URL を登録します。

**認証:**

OAuth2 アプリ専用ベアラートークン

- **ベアラートークン** `<BEARER_TOKEN>` 例: `AAAAAAAAAAAA0%2EUifi76ZC9Ub0wn...`

**パラメータ（JSON ボディ）:**

```
{
    "url": "<your publicly accessible https callback url>"
}
```

- **URL** `<URL>` 例: `https://yourdomain.com/webhooks/twitter/`

**リクエスト:** 次を編集のうえ、以下の cURL リクエストをコマンドラインにコピーしてください:

````
  ```
  curl --request POST --url 'https://api.twitter.com/2/webhooks?url=<URL>' --header 'authorization: Bearer <BEARER_TOKEN>'
  --data '{
"url": "https://yourdomain.com/webhooks/twitter"
          }'
  ```
````

**レスポンス:**

**成功（200 OK）**

成功レスポンスは、Webhook が作成され、初回の CRC チェックに合格したことを示します。

```
{
  "data": {
    "id": "<webhook_id>",
    "url": "<your callback url>",
    "valid": true,
    "created_at": "YYYY-mm-DDTHH:MM:ss.000Z"
  }
}
```

**失敗（400 Bad Request）**

失敗時は標準的なエラーオブジェクトを返します。

```
{
    "errors": [
      {
        "message": "<Reason>: <Details>"
      }
    ],
    "title": "Invalid Request",
    "detail": "One or more parameters to your request was invalid.",
    "type": "https://api.twitter.com/2/problems/invalid-request"
}
```

失敗の一般的な理由には次が含まれます:

| Reason | Description |
| :---- | :---- |
| `CrcValidationFailed` | コールバック URL が CRC チェックに正しく応答しませんでした（例: タイムアウト、不正な応答）。 |
| `UrlValidationFailed` | 指定されたコールバック URL が要件を満たしていません（例: `https` ではない、不正な形式）。 |
| `DuplicateUrlFailed` | 指定されたコールバック URL については、すでにアプリケーションで Webhook が登録されています。 |
| `WebhookLimitExceeded` | アプリケーションが許可されている Webhook 設定の上限数に達しています。 |

<div id="viewing-a-webhook">
  #### [Webhook を表示する](/ja/x-api/webhooks/get-a-list-of-webhook-configs-associated-with-a-client-app)
</div>

**GET /2/webhooks**

**説明:** アプリケーション（開発者アカウント）に関連付けられているすべての webhook 構成を取得します。

**認証:**

OAuth2 App Only Bearer Token

- **Bearer token** `<BEARER_TOKEN>` 例: `AAAAAAAAAAAA0%2EUifi76ZC9Ub0wn...`

- **URL** `<URL>` 例: `https://yourdomain.com/webhooks/twitter/`

**リクエスト:** 次のコマンドを実行して、指定したアプリケーションに登録されているすべての webhook の URL とそのステータスを取得します。

以下の cURL リクエストを、必要な箇所を変更のうえでコマンドラインにコピーしてください。

````
  ```
  curl --request GET --url 'https://api.twitter.com/2/webhooks' --header 'authorization: Bearer <BEARER_TOKEN>'
  ```
````

**成功 (200 OK)**

webhook 構成の一覧を返します。webhook が構成されていない場合、一覧は空です。

_例（webhook が 1 件構成されている場合）:_

```
{
  "data": [
    {
      "created_at": "YYYY-mm-DDTHH:MM:ss.000Z",
      "id": "<webhook_id>",
      "url": "<callback url>",
      "valid": true
    }
  ],
  "meta": {
    "result_count": 1
  }
}
```

_例（webhook が構成されていない場合）:_

```
{
  "data": [],
  "meta": {
    "result_count": 0
  }
}
```

<div id="removing-a-webhook">
  #### [Webhook の削除](/ja/x-api/webhooks/delete-webhook-config)
</div>

DELETE /2/webhooks/:webhook\_id

**説明:** 特定の `webhook_id` を指定して Webhook 設定を削除します。ID は `POST /2/webhooks` の作成時レスポンス、または `GET /2/webhooks` の一覧レスポンスから取得できます。

**認証:**

OAuth2 App Only Bearer Token

- **Bearer token** `<BEARER_TOKEN>` 例: `AAAAAAAAAAAA0%2EUifi76ZC9Ub0wn...`

**パスパラメータ:**

| パラメータ | 説明 |
| :---- | :---- |
| `webhook_id` | 削除する Webhook の ID。 |

**リクエスト:** 指定したアプリケーションの設定から Webhook を削除するには、次のコマンドを実行します。

以下の値を差し替えたうえで、次の cURL リクエストをコマンドラインにコピーしてください。

````
  ```
  curl --request DELETE --url 'https://api.twitter.com/2/webhooks/:WEBHOOK_ID' --header 'authorization: Bearer <BEARER_TOKEN>'
  ```

  **レスポンス:**
````

**成功 (200 OK)**

削除に成功した場合は、"deleted" ステータスが true の JSON レスポンスを返します。

_例 (Webhook の削除に成功した場合):_

```
{
  "data": {
    "deleted": true
  }
}
```

**失敗 (400 Bad Request)**

| 理由 | 説明 |
| :---- | :---- |
| `WebhookIdInvalid` | 指定された `webhook_id` が見つからない、またはアプリに関連付けられていません。 |

<div id="validate-and-reenable-webhook">
  #### [Webhook の検証と再有効化](/ja/x-api/webhooks/webhook-crc-check)
</div>

**PUT /2/webhooks/:webhook\_id**

**説明:** 指定された Webhook の URL に対して CRC（challenge response check）を実行します。チェックが成功すると、200 を返し、ステータスを `valid` に設定して Webhook を再有効化します。

**認証:**

OAuth2 App Only Bearer Token

- **Bearer token** `<BEARER_TOKEN>` 例: `AAAAAAAAAAAA0%2EUifi76ZC9Ub0wn...`

**パスパラメータ:**

| Parameter | Description |
| :---- | :---- |
| `webhook_id` | 検証する Webhook の ID。 |

**リクエスト:** 提供されたアプリケーションの設定に基づき Webhook を検証するには、次のコマンドを実行します。

以下の cURL リクエストを、必要な箇所を変更してからコマンドラインにコピーしてください。

````
  ```
  curl --request PUT --url 'https://api.twitter.com/2/webhooks/:WEBHOOK_ID' --header 'authorization: Bearer <BEARER_TOKEN>'
  ```

  **レスポンス:**
````

**成功（200 OK）**

200 OK レスポンスは、CRC チェックリクエストが開始されたことを示します。これは CRC チェックの合格を保証するものではありません。レスポンス内の `valid` フィールドは、チェック試行後のステータスを反映します。CRC チェックが成功した場合、Webhook のステータスは valid に更新されます。現在のステータスは `GET /2/webhooks` で確認できます。

```
{
  "data": {
    "valid": true // CRC チェック試行完了後のステータスを示します
  }
}
```

**失敗（400 Bad Request）**

| Reason | Description |
| :---- | :---- |
| `WebhookIdInvalid` | 提供された `webhook_id` が見つからないか、アプリに関連付けられていません。 |
| `CrcValidationFailed` | コールバック URL が CRC チェックリクエストに正しく応答しませんでした。 |

<div id="4-the-crc-check">
  ### 4. CRC チェック
</div>

Challenge Response Check（CRC）は、提供したコールバック URL が有効であり、その管理権限があることを X が検証する仕組みです。

**CRC がトリガーされるタイミング:**

- 初回の webhook 登録時（`POST /2/webhooks`）
- X による毎時の検証
- `PUT /2/webhooks/:id` による手動実行

例:

```
GET https://your-webhook-url.com/webhook?crc_token=challenge_string
```

JSON レスポンスボディの例:

```
{
  "response_token": "sha256=<base64_encoded_hmac_hash>"
}
```

**レスポンスの作成方法:**

- メッセージとして crc\_token を使用する
- キーとしてアプリの**consumer secret**を使用する
- HMAC SHA-256 ハッシュを作成する
- 結果を Base64 エンコードする

<div id="sample-apps">
  ## サンプルアプリ
</div>

- [Simple webhook server](https://github.com/m-rosinsky/XWebhookTest/blob/main/app.py)
  - CRC チェックに応答し、POST イベントを受け取る方法を示す、単一ファイルの Python スクリプト。
- [Account Activity API sample dashboard](https://github.com/xdevplatform/account-activity-dashboard-enterprise/tree/master)
  - [bun.sh](https://bun.sh) で実装された Web アプリで、アプリ内で webhook とサブスクリプションの管理、ライブイベントの受信が可能です。