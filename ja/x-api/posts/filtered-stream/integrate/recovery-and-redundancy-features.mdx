---
title: 復旧と冗長化
sidebarTitle: 復旧と冗長化
---

<div id="introduction">
  #### はじめに
</div>

ストリーミングデータを取り込む際は、接続時間を最大化し、マッチしたデータを漏れなく受信することが基本目標です。つまり、冗長接続を活用し、切断を自動検知して迅速に再接続し、欠落したデータを回復するための計画を用意しておくことが重要です。

このインテグレーションガイドでは、冗長接続、バックフィル、リカバリーといった復旧・冗長化機能について解説します。
 

**冗長接続**

冗長接続とは、フィルタードストリームに同時に複数接続できるようにする仕組みです。これにより、2 つの別々のコンシューマーで同一ストリームに接続し、両方の接続を通じて同じデータを受信することで冗長性を確保できます。したがって、片方のストリームが切断された場合やアプリケーションのプライマリサーバーに障害が発生した場合など、さまざまな状況でアプリにホットフェイルオーバーを提供できます。

フィルタードストリームは現在、Enterprise アクセスを持つプロジェクトに対してのみ、最大 2 本の冗長接続を許可しています。冗長ストリームを利用するには、プライマリ接続と同じ URL に接続するだけです。ストリームのデータは両方の接続を通じて配信されます。

<div id="recovering-missed-data-after-a-disconnection-backfill">
  #### 切断後に取り逃したデータの復旧：バックフィル
</div>

切断を検知したら、システムはストリームへ再接続できるようにしておく必要があります。可能であれば、適切な復旧機能でデータをバックフィルできるよう、切断がどのくらい続いたかを記録してください。 

Enterprise アクセス付きのプロジェクトを使用していて、切断が 5 分以下であったと特定できた場合は、バックフィル用のパラメータ backfill\_minutes を使用できます。 このパラメータを [GET /tweets/search/stream](/ja/x-api/posts/filtered-stream#get-2-tweets-search-stream) リクエストに渡すと、直近 1～5 分の間にルールに一致した投稿を受け取ります。通常、これらの過去の投稿は新たに一致した投稿より先に配信され、また投稿の重複排除は行いません。つまり、90 秒間切断されていたにもかかわらず 2 分分のバックフィルデータを要求した場合、30 秒分の重複した投稿を受け取ることになり、システム側で許容する必要があります。以下は backfill パラメータを使用したリクエストの例です。

`curl 'https://api.x.com/2/tweets/search/stream?backfill_minutes=5' -H "Authorization: Bearer $ACCESS_TOKEN"`

Enterprise アクセスがない場合、または切断時間が 5 分を超えると特定された場合は、[recent search endpoint](/ja/x-api/posts/search/introduction) または復旧機能を利用して取り逃したデータをリクエストできます。ただし、search Posts エンドポイントには sample:, bio:, bio\_name:, bio\_location: の各オペレーターが含まれない点や、keyword および #hashtag オペレーターでアクセントやダイアクリティカルマークを使用した際のマッチング動作にいくつかの違いがある点に注意してください。これらの違いにより、フィルタードストリームのエンドポイント経由で受信できた可能性のある投稿を完全には復旧できない場合があります。 

**切断後に取り逃したデータの復旧：Recovery**

Enterprise アクセス付きのプロジェクトを使用している場合、5 分のバックフィルウィンドウ内で再接続できないときでも、直近 24 時間の取り逃したデータを Recovery 機能で復旧できます。

ストリーミングのリカバリー機能により、バックフィルの時間範囲を 24 時間に拡張できます。Recovery は取り逃した期間を「再生」できるようにします。リクエストパラメータとして "start\_time" と "end\_time" を指定して接続要求を行うと、リカバリーストリームが開始されます。接続が確立されると、Recovery は指定された期間を再ストリームし、その後切断します。  

同時に 2 件の Recovery へのリクエスト、すなわち「2 つのリカバリージョブ」を実行できます。Recovery は技術的には backfill と同様に動作しますが、開始時刻と終了時刻を定義する点が異なります。リカバリー期間は単一の時間範囲です。

|     |     |     |
| :--- | :--- | :--- |
| **Name** | **Type** | **Description** |
| start\_time | date (ISO 8601) | YYYY-MM-DDTHH:mm:ssZ (ISO 8601/RFC 3339).<br /><br />復旧の開始時刻を示す UTC の日時。 |
| end\_time | date (ISO 8601) | YYYY-MM-DDTHH:mm:ssZ (ISO 8601/RFC 3339).<br /><br />復旧の終了時刻を示す UTC の日時。 |

例のリクエスト URL: [https://api.x.com/2/tweets/search/stream?start\_time=2022-07-12T15:10:00Z\&end\_time=2022-07-12T15:20:00Z](https://api.x.com/2/tweets/search/stream?start_time=1985-04-12T23:20:50.52Z\&end_time=1985-04-13T00:20:50.52Z)