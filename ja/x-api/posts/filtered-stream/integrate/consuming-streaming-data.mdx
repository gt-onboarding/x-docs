---
title: ストリーミングデータの利用
sidebarTitle: ストリーミングデータの利用
---

<div id="building-a-client-to-consume-streaming-data">
  ### ストリーミングデータを受信するクライアントの構築
</div>

ストリーミングエンドポイントを利用する際は、利用を最適化するために考慮すべき一般的なベストプラクティスがいくつかあります。  
 

<div id="client-design">
  #### クライアント設計
</div>

フィルタードストリームのエンドポイントでソリューションを構築する場合、次の機能を備えたクライアントが必要です。

1. フィルタードストリームのエンドポイントに対して HTTPS のストリーミング接続を確立する。
2. ストリームのルールを追加・削除するため、フィルタードストリームのルールエンドポイントへ非同期で POST リクエストを送信する。
3. 低トラフィック時の処理 — ストリーミング接続を維持し、Post オブジェクトとキープアライブ信号を検出する。
4. 高トラフィック時の処理 — 非同期処理でストリーム取り込みと後続処理を分離し、クライアント側バッファを定期的にフラッシュする。
5. クライアント側での消費量トラッキングを管理する。
6. ストリームの切断を検出・評価し、自動的に再接続する。
    

<div id="connecting-to-a-streaming-endpoint">
  #### ストリーミングエンドポイントへの接続
</div>

X API v2 のストリーミングエンドポイントに接続するということは、非常に長時間持続する HTTP リクエストを発行し、レスポンスを逐次的に解析することを意味します。概念的には、HTTP 経由で無限に長いファイルをダウンロードするようなものと考えられます。接続が確立されると、接続が開いている限り、X サーバーはその接続を通じて投稿イベントを配信します。
 

<div id="consuming-data">
  #### データの取り込み
</div>

JSON オブジェクトの各フィールドには順序がなく、あらゆる状況で全フィールドが存在するとは限りません。同様に、個々のアクティビティは並び替えられた順序で配信されず、重複メッセージが届く場合があります。時間の経過とともに新しいメッセージタイプが追加され、ストリーム経由で送信される可能性がある点にも留意してください。

したがって、クライアントは次に対して許容できる必要があります:

- 任意の順序で出現するフィールド
- 予期しないフィールドや欠落しているフィールド
- 並び替えられていない投稿
- 重複メッセージ
- ストリーム経由で随時送られてくる新たな任意のメッセージタイプ

関連する投稿データおよび要求したフィールドパラメータに加えて、ストリーム接続では次の種類のメッセージが配信される場合があります。この一覧は網羅的ではない可能性がある点に注意してください。ストリームに追加のオブジェクトが導入される場合があります。予期しないメッセージ形式に対してパーサーが堅牢に動作するようにしてください。
 

<div id="buffering">
  #### バッファリング
</div>

ストリーミングエンドポイントは、データが利用可能になり次第すぐに送信するため、多くの場合に高いデータ量になります。X サーバーがすぐに新しいデータをストリームへ書き込めない場合（たとえばクライアントの読み取り速度が不十分なとき。詳細は[切断の処理](/ja/x-api/posts/filtered-stream#what-is-a-disconnection)を参照）、クライアントが追いつけるようにサーバー側でコンテンツをバッファします。ただし、このバッファが満杯になると接続は強制的に切断され、バッファされていた投稿は破棄され再送されません。詳細は以下を参照してください。

アプリが処理に遅れ始めているかを特定する一つの方法は、受信した投稿のタイムスタンプを現在時刻と比較し、その差を継続的に追跡することです。

パブリックインターネット上の潜在的なレイテンシや一時的な障害により、ストリームのバックアップを完全に無くすことはできませんが、アプリの適切な構成によって大部分は回避できます。バックアップの発生を最小化するには:

- クライアントがストリームを十分な速度で読み取れていることを確認してください。通常、読み取り中に本格的な処理を行うべきではありません。ストリームは読み取りに専念し、処理は別のスレッド／プロセス／データストアに渡して非同期に実行してください。
- データセンターに、大量の継続的なデータ量および大幅なスパイク（例: 通常の 5～10 倍）に対応可能な十分な受信帯域幅があることを確認してください。フィルタードストリームの場合、発生量とそれに応じて必要となる帯域幅は、ルールが一致させている投稿に完全に依存します。
   

<div id="usage-tracking-and-rule-management">
  #### 使用状況の追跡とルール管理
</div>

開発者ごとにストリームの「通常」データ量に対する期待値は異なるため、特定の増減率や期間についての一般的な推奨値は提示していません。

予期しない変動がないか、ストリームのデータ量を監視してください。データ量の減少は、ストリーム切断とは別の問題を示している可能性があります。このような場合でも、ストリームは keep-alive シグナルや一部の新しいアクティビティデータを受信し続けます。ただし、Post の数が大きく減少している場合は、アプリケーションやネットワークへの受信データ量を減少させている要因がないかを調査し、関連する告知がないか[ステータスページ](https://api.twitterstat.us/)を確認してください。

このような監視を行うには、一定時間内に観測される見込みの新規 Post 数を追跡します。ストリームのデータ量が設定したしきい値を大きく下回り、所定時間内に回復しない場合は、アラートや通知を発報する必要があります。特にフィルタードストリームのルールを変更している場合や、Post アクティビティが急増するイベントが発生した場合には、データ量の大幅な増加についても監視してください。

フィルタードストリーム経由で配信される Post は月間の総 Post 量に算入される点に留意し、最適化のために消費量を追跡・調整してください。ボリュームが高い場合は、必要に応じて各ルールに sample: 演算子を追加し、マッチ率を 100% から sample:50 や sample:25 に下げることを検討してください。

さらに、事前に設定したしきい値を超えた場合にチームへ警告する仕組みをアプリ内に実装することを推奨します。過剰なデータを取り込んでいるルールの自動削除や、極端な場合にはストリームからの完全切断といった対策の導入も検討してください。
 

<div id="responding-to-system-messages">
  #### システムメッセージへの対応
</div>

キープアライブ信号
少なくとも20秒ごとに、ストリームはオープンな接続を通じて \r\n のキャリッジリターン（ハートビート）の形でキープアライブ信号を送信し、クライアントのタイムアウトを防ぎます。クライアントアプリケーションはストリーム中の \r\n 文字を許容する必要があります。

クライアントがHTTPライブラリで適切に読み取りタイムアウトを実装していれば、この期間内にデータが読み取られない場合はHTTPプロトコルおよびHTTPライブラリがイベントを発生させるため、\r\n 文字を明示的に監視する必要はありません。

このイベントは、使用するHTTPライブラリによっては例外のスローやその他のイベントになります。これらのタイムアウトを検出するため、HTTPメソッドをエラー／イベントハンドラーでラップすることを強く推奨します。タイムアウト時は、アプリケーションは再接続を試みてください。

エラーメッセージ
v2 のストリーミングエンドポイントは、ストリーム内でエラーメッセージを配信する場合があります。以下にメッセージの基本形式といくつかの例を示します。配信されるメッセージは変更される可能性があり、新しいメッセージが導入されることもあります。クライアントアプリケーションは、変化するシステムメッセージのペイロードに対して堅牢である必要があります。

なお、エラーメッセージには、問題の解決方法を説明するドキュメントへのリンクが含まれます。

メッセージ形式:

```{
	"errors": [{
		"title": "operational-disconnect",
		"disconnect_type": "UpstreamOperationalDisconnect",
		"detail": "This stream has been disconnected upstream for operational reasons.",
		"type": "https://api.x.com/2/problems/operational-disconnect"
	}]
}
```

バッファのフルによる強制切断を示すエラーメッセージは、強制切断の原因となったバックアップによって配信が妨げられる場合、クライアントに届かないことがあります。したがって、アプリは再接続の開始をこれらのメッセージに依存すべきではありません。